# Plan: Execute Operaciones Schema Migration

---
wave: 1
depends_on: []
files_modified:
- Operaciones Google Sheet (columns 68-72 added)
- backend/repositories/column_map_cache.py (cache invalidated)
autonomous: true
---

## Context

The verification report shows that `backend/scripts/extend_operaciones_schema.py` exists and works (tested in dry-run mode), but hasn't been executed on the production Google Sheet. The Operaciones sheet currently has 67 columns but needs 72 columns to support v4.0 union-level metrics.

Missing columns (68-72):
- Total_Uniones: Count of all unions for the spool
- Uniones_ARM_Completadas: Count of unions with ARM_FECHA_FIN != NULL
- Uniones_SOLD_Completadas: Count of unions with SOL_FECHA_FIN != NULL
- Pulgadas_ARM: Sum of DN_UNION for completed ARM unions
- Pulgadas_SOLD: Sum of DN_UNION for completed SOLD unions

The migration script is idempotent and safe to run multiple times.

## Task

<task>
Execute the Operaciones schema migration to add columns 68-72 with proper defaults.
</task>

<subtasks>

1. **Verify current sheet state**
   - Check that Operaciones sheet currently has 67 columns
   - Confirm columns 68-72 don't already exist (idempotency check)

2. **Execute migration script**
   - Run `backend/scripts/extend_operaciones_schema.py`
   - Script will add 5 new columns with defaults
   - Script will invalidate ColumnMapCache after success

3. **Verify migration success**
   - Confirm Operaciones sheet now has 72 columns
   - Verify new column headers are correct (Total_Uniones through Pulgadas_SOLD)
   - Check default values are applied (0 for numeric columns)

4. **Test column access**
   - Run a quick test to read the new columns via ColumnMapCache
   - Verify cache rebuild picks up new columns correctly

</subtasks>

## Verification

<verification>

After execution, verify:

1. **Sheet structure**:
   - Operaciones sheet has exactly 72 columns
   - Column 68 header = "Total_Uniones"
   - Column 69 header = "Uniones_ARM_Completadas"
   - Column 70 header = "Uniones_SOLD_Completadas"
   - Column 71 header = "Pulgadas_ARM"
   - Column 72 header = "Pulgadas_SOLD"

2. **Default values**:
   - All existing rows have 0 in columns 68-72
   - No #N/A or error values

3. **Cache behavior**:
   - ColumnMapCache.get_or_build("Operaciones") returns map with 72 entries
   - headers["Total_Uniones"] == 68
   - headers["Pulgadas_SOLD"] == 72

</verification>

## must_haves

<must_haves>

After this plan:

1. Operaciones sheet MUST have 72 columns total
2. Columns 68-72 MUST have the correct headers for union metrics
3. All existing rows MUST have default value 0 in the new columns
4. ColumnMapCache MUST correctly map the new column names to indices

</must_haves>