---
phase: 12-frontend-union-selection-ux
plan: 04
type: execute
wave: 2
depends_on: ["12-01", "12-02", "12-03"]
files_modified:
  - zeues-frontend/app/seleccionar-uniones/page.tsx
  - zeues-frontend/components/UnionTable.tsx
  - zeues-frontend/components/Modal.tsx
autonomous: true

must_haves:
  truths:
    - "P5 page displays union selection table with checkboxes"
    - "Selection counter shows 'Seleccionadas: X/Y | Pulgadas: Z' in real-time"
    - "Zero-selection modal appears when continuing with no unions selected"
    - "Completed unions are visually disabled with badges"
  artifacts:
    - path: "zeues-frontend/app/seleccionar-uniones/page.tsx"
      provides: "P5 union selection page"
      min_lines: 200
    - path: "zeues-frontend/components/UnionTable.tsx"
      provides: "Full union table with selection logic"
      exports: ["UnionTable"]
  key_links:
    - from: "zeues-frontend/app/seleccionar-uniones/page.tsx"
      to: "zeues-frontend/components/UnionTable.tsx"
      via: "import statement"
      pattern: "import.*UnionTable.*from"
    - from: "zeues-frontend/app/seleccionar-uniones/page.tsx"
      to: "zeues-frontend/components/Modal.tsx"
      via: "import statement"
      pattern: "import.*Modal.*from"
---

<objective>
Implement P5 union selection page with checkbox table and live counter

Purpose: Create the core v4.0 UI for workers to select individual unions to complete, with real-time feedback on selected count and pulgadas-diámetro metric
Output: Complete P5 page at app/seleccionar-uniones/page.tsx with union selection table, sticky counter, and zero-selection modal
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-frontend-union-selection-ux/12-CONTEXT.md
@.planning/phases/12-frontend-union-selection-ux/12-RESEARCH.md
@.planning/phases/12-frontend-union-selection-ux/12-01-SUMMARY.md
@.planning/phases/12-frontend-union-selection-ux/12-02-SUMMARY.md
@.planning/phases/12-frontend-union-selection-ux/12-03-SUMMARY.md

# Reference existing pages for navigation pattern
@zeues-frontend/app/seleccionar-spool/page.tsx
@zeues-frontend/app/confirmar/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create P5 union selection page</name>
  <files>zeues-frontend/app/seleccionar-uniones/page.tsx</files>
  <action>
    Create new page at app/seleccionar-uniones/page.tsx for union selection:

    ```typescript
    'use client';

    import { useState, useEffect, useMemo } from 'react';
    import { useRouter } from 'next/navigation';
    import { useApp } from '@/lib/context';
    import { UnionTable } from '@/components/UnionTable';
    import { Modal } from '@/components/Modal';
    import { Button } from '@/components/Button';
    import { getDisponiblesUnions } from '@/lib/api';
    import type { Union } from '@/lib/types';

    export default function SeleccionarUnionesPage() {
      const router = useRouter();
      const {
        selectedSpool,
        operacion,
        selectedUnions,
        setSelectedUnions,
        setPulgadasCompletadas
      } = useApp();

      const [unions, setUnions] = useState<Union[]>([]);
      const [loading, setLoading] = useState(true);
      const [showZeroModal, setShowZeroModal] = useState(false);
      const [error, setError] = useState<string | null>(null);

      // Page implementation...
    }
    ```

    Key features:
    1. Load unions on mount via getDisponiblesUnions(selectedSpool.tag, operacion)
    2. Sticky counter at top:
       - Container: `sticky top-0 z-10 bg-white border-b p-4`
       - Text: `text-lg font-medium`
       - Format: "Seleccionadas: {selected}/{available} | Pulgadas: {sum.toFixed(1)}"
    3. "Seleccionar Todas" button below counter:
       - Only selects available (non-completed) unions
       - Position: Below counter, above table
    4. UnionTable component for checkbox selection
    5. Continue button at bottom:
       - Sticky: `sticky bottom-0 z-10 bg-white p-4 border-t`
       - Size: `h-20` to match existing buttons
       - Label: "Continuar"
    6. Zero-selection modal:
       - Triggered when continuing with 0 unions selected
       - Text: "¿Liberar sin registrar?"
       - Buttons: "Liberar Spool" (confirm) and "Cancelar"

    Selection logic:
    - Calculate available unions: unions.filter(u => !u.is_completed)
    - Calculate selected pulgadas: unions.filter(u => selectedUnions.includes(u.n_union)).reduce((sum, u) => sum + u.dn_union, 0)
    - Update context on selection change
    - Disable backdrop click on modal (onBackdropClick={null})

    Navigation:
    - If no selectedSpool or operacion, redirect to P1
    - On continue with selections: navigate to confirmar page
    - On "Liberar Spool": set selectedUnions to empty array and navigate to confirmar
  </action>
  <verify>cd zeues-frontend && npx tsc --noEmit</verify>
  <done>P5 page created with union selection table and sticky counter</done>
</task>

<task type="auto">
  <name>Task 2: Implement full UnionTable selection logic</name>
  <files>zeues-frontend/components/UnionTable.tsx</files>
  <action>
    Update UnionTable.tsx from shell (Plan 02) to full implementation with selection:

    1. Add checkbox selection handling:
    ```typescript
    const handleCheckboxChange = (n_union: number, isChecked: boolean) => {
      if (onSelectionChange) {
        const newSelection = isChecked
          ? [...selectedUnions, n_union]
          : selectedUnions.filter(n => n !== n_union);
        onSelectionChange(newSelection);
      }
    };
    ```

    2. Checkbox column implementation:
    ```typescript
    <td className="w-16 text-center">
      <input
        type="checkbox"
        className="w-14 h-14 cursor-pointer"  // 56x56px for gloved hands
        checked={selectedUnions.includes(union.n_union)}
        onChange={(e) => handleCheckboxChange(union.n_union, e.target.checked)}
        disabled={disabled || union.is_completed}
        aria-label={`Seleccionar unión ${union.n_union}`}
      />
    </td>
    ```

    3. Visual states for completed unions:
    - Row classes when completed: `opacity-50 cursor-not-allowed`
    - Text decoration: `line-through` on union number
    - Badge in last column:
      ```typescript
      {union.is_completed && (
        <span className="inline-flex items-center px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded">
          {operacion === 'ARM' ? '✓ Armada' : '✓ Soldada'}
        </span>
      )}
      ```

    4. Table header styling:
    ```typescript
    <thead className="bg-gray-50 border-b sticky top-0 z-10">
      <tr>
        <th className="w-16 py-3">Seleccionar</th>
        <th className="px-4 py-3 text-left">N° Unión</th>
        <th className="px-4 py-3 text-left">DN</th>
        <th className="px-4 py-3 text-left">Tipo</th>
      </tr>
    </thead>
    ```

    5. Row hover effect (only for available unions):
    ```typescript
    <tr className={`
      border-b min-h-[64px]
      ${union.is_completed ? 'opacity-50' : 'hover:bg-gray-50 transition-colors'}
    `}>
    ```

    IMPORTANT:
    - Checkbox animation: Use Tailwind transition-opacity (150ms)
    - Sort unions by n_union ascending before rendering
    - Handle empty state: "No hay uniones disponibles"
  </action>
  <verify>cd zeues-frontend && npm run lint</verify>
  <done>UnionTable fully implemented with checkbox selection and completion badges</done>
</task>

<task type="auto">
  <name>Task 3: Implement zero-selection modal flow</name>
  <files>zeues-frontend/app/seleccionar-uniones/page.tsx</files>
  <action>
    Complete the zero-selection modal implementation in P5:

    1. Modal content structure:
    ```typescript
    <Modal
      isOpen={showZeroModal}
      onClose={() => setShowZeroModal(false)}
      onBackdropClick={null}  // Disable backdrop dismiss
    >
      <div className="text-center">
        <h3 className="text-lg font-semibold mb-4">¿Liberar sin registrar?</h3>
        <p className="text-gray-600 mb-6">
          No has seleccionado ninguna unión. El spool será liberado sin registrar trabajo.
        </p>
        <div className="flex gap-4 justify-center">
          <Button
            variant="secondary"
            onClick={() => setShowZeroModal(false)}
            className="h-14 px-6"
          >
            Cancelar
          </Button>
          <Button
            variant="primary"
            onClick={handleLiberarSpool}
            className="h-14 px-6"
          >
            Liberar Spool
          </Button>
        </div>
      </div>
    </Modal>
    ```

    2. Handle continue button logic:
    ```typescript
    const handleContinue = () => {
      if (selectedUnions.length === 0) {
        setShowZeroModal(true);
      } else {
        // Calculate and set pulgadas before navigation
        const pulgadas = calculateSelectedPulgadas();
        setPulgadasCompletadas(pulgadas);
        router.push('/confirmar');
      }
    };
    ```

    3. Handle "Liberar Spool" confirmation:
    ```typescript
    const handleLiberarSpool = () => {
      setSelectedUnions([]);  // Empty array signals cancellation
      setPulgadasCompletadas(0);
      router.push('/confirmar');
    };
    ```

    4. Loading state while fetching unions:
    ```typescript
    {loading && (
      <div className="flex items-center justify-center h-64">
        <div className="text-gray-500">Cargando uniones...</div>
      </div>
    )}
    ```

    5. Error handling:
    ```typescript
    {error && (
      <div className="bg-red-50 border border-red-200 rounded p-4 mb-4">
        <p className="text-red-700">{error}</p>
      </div>
    )}
    ```

    Button sizes for modal: 56px height (h-14) for consistency with touch targets
  </action>
  <verify>cd zeues-frontend && npm run build</verify>
  <done>Zero-selection modal flow complete with proper navigation and state management</done>
</task>

</tasks>

<verification>
1. Page loads unions on mount
2. Checkboxes are 56x56px for touch targets
3. Counter updates in real-time with selection changes
4. "Seleccionar Todas" button works correctly
5. Completed unions show badges and are disabled
6. Zero-selection modal appears when appropriate
7. Navigation to confirmar page works
8. Build completes successfully
</verification>

<success_criteria>
- [ ] P5 page created at app/seleccionar-uniones/page.tsx
- [ ] Union table displays with checkbox selection
- [ ] Sticky counter shows "Seleccionadas: X/Y | Pulgadas: Z"
- [ ] Counter updates instantly on checkbox toggle
- [ ] "Seleccionar Todas" button selects only available unions
- [ ] Completed unions show green badges ("✓ Armada" or "✓ Soldada")
- [ ] Zero-selection modal with "¿Liberar sin registrar?" confirmation
- [ ] Modal backdrop click disabled (no accidental dismiss)
- [ ] Proper navigation to confirmar page
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-union-selection-ux/12-04-SUMMARY.md`
</output>