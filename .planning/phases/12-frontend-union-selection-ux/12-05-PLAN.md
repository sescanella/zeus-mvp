---
phase: 12-frontend-union-selection-ux
plan: 05
type: execute
wave: 2
depends_on: ["12-04"]
files_modified:
  - zeues-frontend/app/seleccionar-uniones/page.tsx
  - zeues-frontend/app/confirmar/page.tsx
autonomous: true

must_haves:
  truths:
    - "P5 connects to v4.0 API endpoints for loading and submitting unions"
    - "409 conflicts trigger automatic reload with fresh data"
    - "403 ownership errors show clear error message"
    - "Network errors display retry button"
  artifacts:
    - path: "zeues-frontend/app/seleccionar-uniones/page.tsx"
      provides: "API integration and error handling"
      min_lines: 250
    - path: "zeues-frontend/app/confirmar/page.tsx"
      provides: "Updated confirmation page for FINALIZAR flow"
      min_lines: 150
  key_links:
    - from: "zeues-frontend/app/seleccionar-uniones/page.tsx"
      to: "zeues-frontend/lib/api.ts"
      via: "import statement"
      pattern: "import.*finalizarSpool.*from.*api"
---

<objective>
Connect P5 to v4.0 API endpoints with comprehensive error handling

Purpose: Wire up the union selection page to backend APIs for loading available unions and submitting selections, with proper error recovery for 409/403 scenarios
Output: Complete API integration in P5 with loading states, error modals, and automatic conflict resolution
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-frontend-union-selection-ux/12-CONTEXT.md
@.planning/phases/12-frontend-union-selection-ux/12-RESEARCH.md
@.planning/phases/12-frontend-union-selection-ux/12-01-SUMMARY.md
@.planning/phases/12-frontend-union-selection-ux/12-04-SUMMARY.md

# Reference existing error handling patterns
@zeues-frontend/app/confirmar/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API loading and error handling to P5</name>
  <files>zeues-frontend/app/seleccionar-uniones/page.tsx</files>
  <action>
    Enhance P5 with complete API integration:

    1. Load unions on mount:
    ```typescript
    useEffect(() => {
      const loadUnions = async () => {
        if (!selectedSpool || !operacion || operacion === 'METROLOGIA') {
          router.push('/');
          return;
        }

        try {
          setLoading(true);
          setError(null);

          const response = await getDisponiblesUnions(selectedSpool.tag, operacion);

          // Sort by n_union ascending
          const sorted = response.uniones.sort((a, b) => a.n_union - b.n_union);
          setUnions(sorted);

          // Mark completed unions based on operation type
          const withCompletion = sorted.map(u => ({
            ...u,
            is_completed: operacion === 'ARM'
              ? Boolean(u.arm_fecha_fin)
              : Boolean(u.sol_fecha_fin)
          }));
          setUnions(withCompletion);

        } catch (err) {
          console.error('Error loading unions:', err);
          setError('Error cargando uniones. Por favor intenta nuevamente.');
        } finally {
          setLoading(false);
        }
      };

      loadUnions();
    }, [selectedSpool, operacion, router]);
    ```

    2. Add loading bar during submission:
    ```typescript
    const [submitting, setSubmitting] = useState(false);

    // In the UI, show loading bar when submitting
    {submitting && (
      <div className="fixed top-0 left-0 right-0 z-50">
        <div className="bg-blue-500 text-white text-center py-2">
          Guardando...
        </div>
        <div className="h-1 bg-blue-600 animate-pulse" />
      </div>
    )}
    ```

    3. Add network error retry:
    ```typescript
    {error && (
      <div className="bg-red-50 border border-red-200 rounded p-4 mb-4">
        <p className="text-red-700 mb-2">{error}</p>
        <Button
          variant="secondary"
          onClick={() => window.location.reload()}
          className="h-12"
        >
          Reintentar
        </Button>
      </div>
    )}
    ```

    4. Session storage for preserving selection on error:
    ```typescript
    // Save selection to session storage on change
    useEffect(() => {
      if (selectedSpool) {
        sessionStorage.setItem(
          `unions_selection_${selectedSpool.tag}`,
          JSON.stringify(selectedUnions)
        );
      }
    }, [selectedUnions, selectedSpool]);

    // Restore selection on mount if exists
    useEffect(() => {
      if (selectedSpool) {
        const saved = sessionStorage.getItem(`unions_selection_${selectedSpool.tag}`);
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            setSelectedUnions(parsed);
          } catch (e) {
            // Invalid JSON, ignore
          }
        }
      }
    }, [selectedSpool]);
    ```

    5. Clear session storage on successful submission
  </action>
  <verify>cd zeues-frontend && npx tsc --noEmit</verify>
  <done>API loading and error handling complete with session storage for resilience</done>
</task>

<task type="auto">
  <name>Task 2: Update confirmar page for FINALIZAR flow</name>
  <files>zeues-frontend/app/confirmar/page.tsx</files>
  <action>
    Update the confirmation page to handle v4.0 FINALIZAR action:

    1. Import v4.0 API function:
    ```typescript
    import { finalizarSpool } from '@/lib/api';
    ```

    2. Add conditional logic for v4.0 vs v3.0 submission:
    ```typescript
    const handleConfirm = async () => {
      try {
        setLoading(true);

        if (accion === 'FINALIZAR') {
          // v4.0 FINALIZAR flow
          const payload = {
            tag_spool: selectedSpool.tag,
            worker_id: worker.id,
            worker_nombre: `${worker.nombre}(${worker.id})`,
            operacion: operacion as 'ARM' | 'SOLD',
            selected_unions: selectedUnions,
            fecha_operacion: new Date().toISOString().split('T')[0] // YYYY-MM-DD
          };

          const response = await finalizarSpool(payload);

          // Store result for success page
          setPulgadasCompletadas(response.pulgadas_completadas || 0);

          // Navigate to success
          router.push('/exito');

        } else {
          // Existing v3.0 logic for TOMAR/PAUSAR/COMPLETAR
          // ... (keep existing code)
        }
      } catch (error: any) {
        handleApiError(error);
      } finally {
        setLoading(false);
      }
    };
    ```

    3. Add 409 conflict handling:
    ```typescript
    const handleApiError = (error: any) => {
      if (error.status === 409) {
        // Race condition - unions changed
        setErrorModal({
          title: 'Datos desactualizados',
          message: 'Las uniones disponibles han cambiado. Recargando...',
          action: () => {
            // Navigate back to P5 to reload
            router.push('/seleccionar-uniones');
          }
        });
        // Auto-reload after 2 seconds
        setTimeout(() => {
          router.push('/seleccionar-uniones');
        }, 2000);
      } else if (error.status === 403) {
        // Ownership validation failed - use clearer message per locked decision
        setErrorModal({
          title: 'Error de permisos',
          message: 'No eres el due침o de este spool. Este spool est치 ocupado por otro trabajador.',
          action: () => router.push('/seleccionar-spool')
        });
      } else {
        // Generic error
        setErrorModal({
          title: 'Error',
          message: error.message || 'Ocurri칩 un error. Por favor intenta nuevamente.',
          action: () => setErrorModal(null)
        });
      }
    };
    ```

    4. Display selected unions count on confirmation:
    ```typescript
    {accion === 'FINALIZAR' && (
      <div className="bg-gray-50 rounded p-4 mb-4">
        <p className="text-sm text-gray-600">Uniones seleccionadas:</p>
        <p className="text-lg font-semibold">{selectedUnions.length} uniones</p>
        <p className="text-sm text-gray-600 mt-1">
          {pulgadasCompletadas.toFixed(1)} pulgadas-di치metro
        </p>
      </div>
    )}
    ```

    5. Add loading state during submission:
    ```typescript
    <Button
      onClick={handleConfirm}
      disabled={loading}
      className="h-20 w-full"
    >
      {loading ? 'Procesando...' : 'Confirmar'}
    </Button>
    ```
  </action>
  <verify>cd zeues-frontend && npm run lint</verify>
  <done>Confirmar page updated to handle FINALIZAR with error recovery</done>
</task>

<task type="auto">
  <name>Task 3: Add error modal component</name>
  <files>zeues-frontend/app/confirmar/page.tsx</files>
  <action>
    Add error modal using the Modal component for 409/403 errors:

    1. Import Modal component:
    ```typescript
    import { Modal } from '@/components/Modal';
    ```

    2. Add error modal state:
    ```typescript
    interface ErrorModalState {
      title: string;
      message: string;
      action: () => void;
    }

    const [errorModal, setErrorModal] = useState<ErrorModalState | null>(null);
    ```

    3. Render error modal:
    ```typescript
    {errorModal && (
      <Modal
        isOpen={true}
        onClose={() => setErrorModal(null)}
        onBackdropClick={null}  // Force button click
      >
        <div className="text-center">
          <h3 className="text-lg font-semibold mb-4 text-red-600">
            {errorModal.title}
          </h3>
          <p className="text-gray-600 mb-6">
            {errorModal.message}
          </p>
          <Button
            variant="primary"
            onClick={errorModal.action}
            className="h-14 px-8"
          >
            {errorModal.title === 'Datos desactualizados' ? 'Recargar' : 'Aceptar'}
          </Button>
        </div>
      </Modal>
    )}
    ```

    4. Clear error modal on unmount:
    ```typescript
    useEffect(() => {
      return () => {
        setErrorModal(null);
      };
    }, []);
    ```

    5. Add visual feedback for auto-reload (409 case):
    ```typescript
    // In the 409 handler, add countdown
    const [countdown, setCountdown] = useState<number | null>(null);

    useEffect(() => {
      if (countdown !== null && countdown > 0) {
        const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
        return () => clearTimeout(timer);
      } else if (countdown === 0) {
        router.push('/seleccionar-uniones');
      }
    }, [countdown, router]);

    // In 409 error modal message:
    message: `Las uniones disponibles han cambiado. Recargando${countdown !== null ? ` en ${countdown}s` : ''}...`
    ```

    Mobile-friendly modal sizing and button heights (56px minimum)
  </action>
  <verify>cd zeues-frontend && npm run build</verify>
  <done>Error modal integrated for comprehensive error handling</done>
</task>

</tasks>

<verification>
1. API calls work correctly with loading states
2. 409 error triggers auto-reload to P5
3. 403 error shows ownership message
4. Network errors show retry button
5. Session storage preserves selection
6. Confirmar page handles both v3.0 and v4.0 flows
7. Build completes successfully
</verification>

<success_criteria>
- [ ] P5 loads unions via GET /api/v4/uniones/{tag}/disponibles
- [ ] Loading state shows "Cargando uniones..."
- [ ] Submitting state shows "Guardando..." progress bar
- [ ] 409 conflict shows modal and auto-reloads P5
- [ ] 403 forbidden shows clear ownership error
- [ ] Network errors display retry button
- [ ] Session storage preserves selection on error
- [ ] Confirmar page calls finalizarSpool for v4.0 flow
- [ ] Error modal properly styled for mobile
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-union-selection-ux/12-05-SUMMARY.md`
</output>