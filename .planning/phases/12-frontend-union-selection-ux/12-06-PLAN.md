---
phase: 12-frontend-union-selection-ux
plan: 06
type: execute
wave: 3
depends_on: ["12-01", "12-02", "12-03"]
files_modified:
  - zeues-frontend/app/tipo-interaccion/page.tsx
autonomous: true

must_haves:
  truths:
    - "P3 detects spool version via API call to /api/v4/uniones/{tag}/metricas"
    - "v4.0 spools show 2 buttons: INICIAR and FINALIZAR"
    - "v3.0 spools show 3 buttons: TOMAR, PAUSAR, COMPLETAR"
    - "Version detection result is cached in session storage"
  artifacts:
    - path: "zeues-frontend/app/tipo-interaccion/page.tsx"
      provides: "Dual workflow support based on version"
      min_lines: 150
  key_links:
    - from: "zeues-frontend/app/tipo-interaccion/page.tsx"
      to: "zeues-frontend/lib/api.ts"
      via: "import statement"
      pattern: "import.*getUnionMetricas.*from"
    - from: "zeues-frontend/app/tipo-interaccion/page.tsx"
      to: "zeues-frontend/lib/version.ts"
      via: "import statement"
      pattern: "import.*detectSpoolVersion.*from"
---

<objective>
Add version detection and dual button sets to P3 tipo-interaccion page

Purpose: Enable P3 to show the appropriate workflow buttons based on spool version - 2 buttons for v4.0 (INICIAR/FINALIZAR) or 3 buttons for v3.0 (TOMAR/PAUSAR/COMPLETAR)
Output: Updated P3 page with version detection logic and conditional button rendering
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-frontend-union-selection-ux/12-CONTEXT.md
@.planning/phases/12-frontend-union-selection-ux/12-RESEARCH.md
@.planning/phases/12-frontend-union-selection-ux/12-01-SUMMARY.md
@.planning/phases/12-frontend-union-selection-ux/12-02-SUMMARY.md
@.planning/phases/12-frontend-union-selection-ux/12-03-SUMMARY.md

# Reference existing P3 implementation
@zeues-frontend/app/tipo-interaccion/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add version detection to P3</name>
  <files>zeues-frontend/app/tipo-interaccion/page.tsx</files>
  <action>
    Add spool version detection logic to P3:

    1. Import required functions:
    ```typescript
    import { getUnionMetricas } from '@/lib/api';
    import { detectSpoolVersion, cacheSpoolVersion, getCachedVersion } from '@/lib/version';
    ```

    2. Add state for version:
    ```typescript
    const [spoolVersion, setSpoolVersion] = useState<'v3.0' | 'v4.0' | null>(null);
    const [loadingVersion, setLoadingVersion] = useState(true);
    ```

    3. Detect version on mount:
    ```typescript
    useEffect(() => {
      const detectVersion = async () => {
        if (!selectedSpool) {
          router.push('/seleccionar-spool');
          return;
        }

        // Check cache first
        const cached = getCachedVersion(selectedSpool.tag);
        if (cached) {
          setSpoolVersion(cached);
          setLoadingVersion(false);
          return;
        }

        try {
          setLoadingVersion(true);

          // Call metricas endpoint
          const metrics = await getUnionMetricas(selectedSpool.tag);
          const version = detectSpoolVersion(metrics);

          setSpoolVersion(version);
          cacheSpoolVersion(selectedSpool.tag, version);

        } catch (error) {
          console.error('Error detecting version:', error);
          // Default to v3.0 on error (backward compatible)
          setSpoolVersion('v3.0');
        } finally {
          setLoadingVersion(false);
        }
      };

      detectVersion();
    }, [selectedSpool, router]);
    ```

    4. Show loading state while detecting:
    ```typescript
    {loadingVersion && (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-gray-500">Detectando versión...</div>
      </div>
    )}
    ```

    IMPORTANT: Handle edge cases (network failure defaults to v3.0 for backward compatibility)
  </action>
  <verify>cd zeues-frontend && npx tsc --noEmit</verify>
  <done>Version detection integrated with caching and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Implement dual button rendering</name>
  <files>zeues-frontend/app/tipo-interaccion/page.tsx</files>
  <action>
    Add conditional button rendering based on detected version:

    1. Import context setters for v4.0:
    ```typescript
    const {
      // existing imports...
      setAccion,  // Add this for v4.0
      resetV4State  // Add this for cleanup
    } = useApp();
    ```

    2. Create v4.0 button handlers:
    ```typescript
    const handleIniciar = () => {
      setAccion('INICIAR');
      router.push('/seleccionar-spool');
    };

    const handleFinalizar = () => {
      setAccion('FINALIZAR');
      // Skip P4 - worker already knows which spool they're working on
      router.push('/seleccionar-uniones');
    };
    ```

    3. Conditional button rendering:
    ```typescript
    {!loadingVersion && spoolVersion === 'v4.0' && (
      <div className="space-y-4">
        <h2 className="text-xl font-semibold mb-6">¿Qué deseas hacer?</h2>

        <Button
          onClick={handleIniciar}
          variant="primary"
          className="h-20 w-full text-lg"
        >
          INICIAR
        </Button>

        <Button
          onClick={handleFinalizar}
          variant="primary"
          className="h-20 w-full text-lg"
        >
          FINALIZAR
        </Button>

        <p className="text-sm text-gray-500 mt-4">
          Versión 4.0 - Trabajo por uniones
        </p>
      </div>
    )}

    {!loadingVersion && spoolVersion === 'v3.0' && (
      <div className="space-y-4">
        <h2 className="text-xl font-semibold mb-6">Selecciona la acción</h2>

        {/* Existing v3.0 buttons - TOMAR, PAUSAR, COMPLETAR */}
        {/* Keep existing implementation unchanged */}

        <p className="text-sm text-gray-500 mt-4">
          Versión 3.0 - Trabajo por spool completo
        </p>
      </div>
    )}
    ```

    4. Update page title based on version:
    ```typescript
    <h1 className="text-2xl font-bold mb-4">
      {spoolVersion === 'v4.0' ? 'Acción' : 'Tipo de Interacción'}
    </h1>
    ```

    5. Clean up v4.0 state when navigating back:
    ```typescript
    const handleBack = () => {
      resetV4State();  // Clear v4.0 state
      router.push('/operacion');
    };
    ```

    CRITICAL: Both button sets must be the same size (h-20) and style (primary) for consistency
  </action>
  <verify>cd zeues-frontend && npm run lint</verify>
  <done>Dual button sets implemented with proper v4.0 context updates</done>
</task>

<task type="auto">
  <name>Task 3: Add visual version indicator</name>
  <files>zeues-frontend/app/tipo-interaccion/page.tsx</files>
  <action>
    Add visual indicators for version detection:

    1. Add version badge component:
    ```typescript
    const VersionBadge = ({ version }: { version: 'v3.0' | 'v4.0' }) => (
      <span className={`
        inline-flex items-center px-2 py-1 text-xs font-medium rounded
        ${version === 'v4.0'
          ? 'text-green-700 bg-green-100'
          : 'text-gray-700 bg-gray-100'}
      `}>
        {version}
      </span>
    );
    ```

    2. Display spool info with version:
    ```typescript
    {selectedSpool && spoolVersion && (
      <div className="bg-gray-50 rounded p-4 mb-6">
        <div className="flex justify-between items-start">
          <div>
            <p className="text-sm text-gray-600">Spool seleccionado:</p>
            <p className="text-lg font-semibold">{selectedSpool.tag}</p>
          </div>
          <VersionBadge version={spoolVersion} />
        </div>
      </div>
    )}
    ```

    3. Add help text for each version:
    ```typescript
    {spoolVersion === 'v4.0' && (
      <div className="mt-6 p-4 bg-blue-50 rounded">
        <p className="text-sm text-blue-800">
          <strong>INICIAR:</strong> Ocupar spool para comenzar trabajo
        </p>
        <p className="text-sm text-blue-800 mt-1">
          <strong>FINALIZAR:</strong> Registrar uniones completadas y liberar spool
        </p>
      </div>
    )}

    {spoolVersion === 'v3.0' && (
      <div className="mt-6 p-4 bg-gray-50 rounded">
        <p className="text-sm text-gray-600">
          Flujo tradicional: trabajo a nivel de spool completo
        </p>
      </div>
    )}
    ```

    4. Ensure proper spacing and mobile layout:
    ```typescript
    <div className="container mx-auto max-w-md p-4">
      {/* All content wrapped in mobile-friendly container */}
    </div>
    ```

    5. Add error boundary for version detection failure:
    ```typescript
    {!loadingVersion && !spoolVersion && (
      <div className="bg-red-50 border border-red-200 rounded p-4">
        <p className="text-red-700">
          Error detectando versión. Usando modo v3.0.
        </p>
        <Button
          onClick={() => window.location.reload()}
          variant="secondary"
          className="mt-4 h-12"
        >
          Reintentar
        </Button>
      </div>
    )}
    ```

    Visual consistency: Match existing ZEUES color scheme and button sizes
  </action>
  <verify>cd zeues-frontend && npm run build</verify>
  <done>Visual version indicators added with help text and error handling</done>
</task>

</tasks>

<verification>
1. Version detection API call works
2. Session storage caches version
3. v4.0 spools show 2 buttons
4. v3.0 spools show 3 buttons
5. Loading state displays during detection
6. Error defaults to v3.0 safely
7. Version badge shows correctly
8. Build completes successfully
</verification>

<success_criteria>
- [ ] P3 calls GET /api/v4/uniones/{tag}/metricas on mount
- [ ] Version detected based on total_uniones > 0
- [ ] v4.0 spools display INICIAR and FINALIZAR buttons
- [ ] v3.0 spools display TOMAR, PAUSAR, COMPLETAR buttons
- [ ] Version cached in session storage
- [ ] Loading state shows "Detectando versión..."
- [ ] Version badge (green for v4.0, gray for v3.0)
- [ ] Context updated with accion for v4.0 flow
- [ ] Both button sets styled consistently (h-20, primary)
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-union-selection-ux/12-06-SUMMARY.md`
</output>