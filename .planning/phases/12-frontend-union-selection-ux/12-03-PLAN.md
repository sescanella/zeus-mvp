---
phase: 12-frontend-union-selection-ux
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - zeues-frontend/lib/context.tsx
autonomous: true

must_haves:
  truths:
    - "AppContext includes v4.0 state fields (accion, selectedUnions, pulgadasCompletadas)"
    - "Helper functions exist for v4.0 state management"
    - "Context properly handles both v3.0 and v4.0 workflows"
  artifacts:
    - path: "zeues-frontend/lib/context.tsx"
      provides: "Extended context with v4.0 state"
      exports: ["AppContext", "AppProvider", "useApp"]
  key_links:
    - from: "zeues-frontend/lib/context.tsx"
      to: "react"
      via: "createContext import"
      pattern: "createContext.*from.*react"
---

<objective>
Extend React Context with v4.0 state management fields

Purpose: Add the new state fields required for v4.0 union-level workflows to the existing AppContext, ensuring both v3.0 and v4.0 workflows can coexist
Output: Extended context.tsx with accion, selectedUnions, pulgadasCompletadas fields and helper functions
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-frontend-union-selection-ux/12-CONTEXT.md
@.planning/phases/12-frontend-union-selection-ux/12-RESEARCH.md

# Reference existing context implementation
@zeues-frontend/lib/context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add v4.0 fields to AppContext interface</name>
  <files>zeues-frontend/lib/context.tsx</files>
  <action>
    Extend the existing AppContext interface with v4.0 fields:

    1. Add to the AppContextType interface:
    ```typescript
    // Existing v3.0 fields (DO NOT MODIFY)
    worker: Worker | null;
    selectedSpool: Spool | null;
    operacion: 'ARM' | 'SOLD' | 'METROLOGIA' | null;
    // ... other existing fields ...

    // New v4.0 fields (ADD THESE)
    accion: 'INICIAR' | 'FINALIZAR' | null;          // Action type for v4.0 workflow
    selectedUnions: number[];                         // Array of N_UNION values [1, 3, 5, 7]
    pulgadasCompletadas: number;                      // Sum of DN_UNION for selected unions

    // New setter functions for v4.0 (ADD THESE)
    setAccion: (accion: 'INICIAR' | 'FINALIZAR' | null) => void;
    setSelectedUnions: (unions: number[]) => void;
    setPulgadasCompletadas: (pulgadas: number) => void;
    ```

    2. Initialize new fields in the context provider's state:
    ```typescript
    const [accion, setAccion] = useState<'INICIAR' | 'FINALIZAR' | null>(null);
    const [selectedUnions, setSelectedUnions] = useState<number[]>([]);
    const [pulgadasCompletadas, setPulgadasCompletadas] = useState<number>(0);
    ```

    3. Add the new fields and setters to the context value object

    IMPORTANT: Do not break existing v3.0 functionality - only add new fields
  </action>
  <verify>cd zeues-frontend && npx tsc --noEmit</verify>
  <done>Context interface extended with v4.0 fields, TypeScript compilation passes</done>
</task>

<task type="auto">
  <name>Task 2: Add v4.0 helper functions</name>
  <files>zeues-frontend/lib/context.tsx</files>
  <action>
    Add helper functions for v4.0 state management within the AppProvider component:

    1. Add resetV4State function:
    ```typescript
    const resetV4State = useCallback(() => {
      setAccion(null);
      setSelectedUnions([]);
      setPulgadasCompletadas(0);
    }, []);
    ```

    2. Add calculatePulgadas helper:
    ```typescript
    const calculatePulgadas = useCallback((unions: Array<{ n_union: number; dn_union: number }>, selected: number[]): number => {
      return unions
        .filter(u => selected.includes(u.n_union))
        .reduce((sum, u) => sum + u.dn_union, 0);
    }, []);
    ```

    3. Add toggleUnionSelection helper:
    ```typescript
    const toggleUnionSelection = useCallback((unionNumber: number, isSelected: boolean) => {
      setSelectedUnions(prev => {
        if (isSelected) {
          return [...prev, unionNumber];
        } else {
          return prev.filter(n => n !== unionNumber);
        }
      });
    }, []);
    ```

    4. Add selectAllAvailableUnions helper:
    ```typescript
    const selectAllAvailableUnions = useCallback((availableUnionNumbers: number[]) => {
      setSelectedUnions(availableUnionNumbers);
    }, []);
    ```

    5. Export these helper functions through the context value:
    ```typescript
    // Add to context value object
    resetV4State,
    calculatePulgadas,
    toggleUnionSelection,
    selectAllAvailableUnions,
    ```

    Make sure all functions are properly typed and use useCallback for performance
  </action>
  <verify>cd zeues-frontend && npm run lint</verify>
  <done>Helper functions added for v4.0 state management, ESLint passes</done>
</task>

<task type="auto">
  <name>Task 3: Add workflow reset logic</name>
  <files>zeues-frontend/lib/context.tsx</files>
  <action>
    Modify existing reset function to handle v4.0 state cleanup:

    1. Find the existing reset or clear function (likely called when workflow completes)

    2. Add v4.0 state reset to it:
    ```typescript
    // In the existing reset/clear function, add:
    setAccion(null);
    setSelectedUnions([]);
    setPulgadasCompletadas(0);
    ```

    3. Ensure v4.0 state is cleared when:
       - User completes a workflow (P6 success page)
       - User starts a new workflow (P1 worker selection)
       - User navigates away or refreshes

    4. If using useEffect for cleanup, add v4.0 fields:
    ```typescript
    useEffect(() => {
      // Existing cleanup logic...

      return () => {
        // Clean up v4.0 state on unmount
        setAccion(null);
        setSelectedUnions([]);
        setPulgadasCompletadas(0);
      };
    }, []);
    ```

    CRITICAL: Ensure backward compatibility - v3.0 workflows should not be affected
  </action>
  <verify>cd zeues-frontend && npm run build</verify>
  <done>Reset logic properly handles both v3.0 and v4.0 state, build succeeds</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` - no errors
2. ESLint: `npm run lint` - no warnings
3. Build: `npm run build` - successful
4. Context properly exports all new fields and functions
</verification>

<success_criteria>
- [ ] accion field added ('INICIAR' | 'FINALIZAR' | null)
- [ ] selectedUnions array field added for tracking selected union numbers
- [ ] pulgadasCompletadas number field added for sum tracking
- [ ] Setter functions added for all new fields
- [ ] Helper functions: resetV4State, calculatePulgadas, toggleUnionSelection, selectAllAvailableUnions
- [ ] v4.0 state properly cleared on workflow reset
- [ ] Existing v3.0 functionality remains unchanged
- [ ] TypeScript types properly defined for all new additions
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-union-selection-ux/12-03-SUMMARY.md`
</output>