---
phase: 12-frontend-union-selection-ux
plan: 07
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - zeues-frontend/app/seleccionar-spool/page.tsx
  - zeues-frontend/components/SpoolTable.tsx
autonomous: true

must_haves:
  truths:
    - "P4 filters spools based on action type (INICIAR vs FINALIZAR)"
    - "INICIAR shows only disponibles spools"
    - "FINALIZAR shows only spools occupied by current worker"
    - "SpoolTable displays version badges for each spool"
  artifacts:
    - path: "zeues-frontend/app/seleccionar-spool/page.tsx"
      provides: "Filtered spool selection based on action"
      min_lines: 150
    - path: "zeues-frontend/components/SpoolTable.tsx"
      provides: "Version badge column"
      min_lines: 120
  key_links:
    - from: "zeues-frontend/app/seleccionar-spool/page.tsx"
      to: "zeues-frontend/lib/context.tsx"
      via: "useApp import"
      pattern: "import.*useApp.*from.*context"
---

<objective>
Add spool filtering and version badges to P4 seleccionar-spool page

Purpose: Filter the spool list based on v4.0 action type (INICIAR shows disponibles, FINALIZAR shows ocupados) and add visual version badges to the spool table
Output: Updated P4 page with action-based filtering and SpoolTable with version column
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-frontend-union-selection-ux/12-CONTEXT.md
@.planning/phases/12-frontend-union-selection-ux/12-RESEARCH.md
@.planning/phases/12-frontend-union-selection-ux/12-01-SUMMARY.md
@.planning/phases/12-frontend-union-selection-ux/12-02-SUMMARY.md

# Reference existing implementations
@zeues-frontend/app/seleccionar-spool/page.tsx
@zeues-frontend/components/SpoolTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add action-based filtering to P4</name>
  <files>zeues-frontend/app/seleccionar-spool/page.tsx</files>
  <action>
    Modify P4 to filter spools based on action type:

    1. Import context for v4.0:
    ```typescript
    const {
      // existing imports...
      accion,  // Add this for v4.0
      worker,  // Need this for FINALIZAR filtering
    } = useApp();
    ```

    2. Modify spool fetching logic to filter based on action:
    ```typescript
    useEffect(() => {
      const fetchSpools = async () => {
        try {
          setLoading(true);

          // Fetch spools (existing API call)
          const spools = await getAvailableSpools(operacion);

          // Apply filtering based on action
          let filtered = spools;

          if (accion === 'INICIAR') {
            // Show only disponibles
            // Criteria: STATUS_NV='ABIERTA' AND Status_Spool='EN_PROCESO' AND Ocupado_Por IN ('','DISPONIBLE')
            filtered = spools.filter(spool =>
              spool.STATUS_NV === 'ABIERTA' &&
              spool.Status_Spool === 'EN_PROCESO' &&
              (!spool.Ocupado_Por || spool.Ocupado_Por === 'DISPONIBLE' || spool.Ocupado_Por === '')
            );
          } else if (accion === 'FINALIZAR') {
            // Show only occupied by current worker
            // Criteria: Ocupado_Por contains worker_id
            if (worker) {
              const workerPattern = `(${worker.id})`;
              filtered = spools.filter(spool =>
                spool.Ocupado_Por && spool.Ocupado_Por.includes(workerPattern)
              );
            } else {
              filtered = [];
            }
          }
          // For v3.0 actions (TOMAR, PAUSAR, COMPLETAR) or null, show all (existing behavior)

          setSpools(filtered);

        } catch (error) {
          console.error('Error fetching spools:', error);
          setError('Error cargando spools');
        } finally {
          setLoading(false);
        }
      };

      fetchSpools();
    }, [operacion, accion, worker]);
    ```

    3. Update page title based on action:
    ```typescript
    <h1 className="text-2xl font-bold mb-4">
      {accion === 'INICIAR' && 'Seleccionar Spool para Iniciar'}
      {accion === 'FINALIZAR' && 'Seleccionar Spool para Finalizar'}
      {!accion && 'Seleccionar Spool'}
    </h1>
    ```

    4. Add helpful message when no spools match filter:
    ```typescript
    {spools.length === 0 && !loading && (
      <div className="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
        <p className="text-yellow-800">
          {accion === 'INICIAR' && 'No hay spools disponibles para iniciar.'}
          {accion === 'FINALIZAR' && 'No tienes spools ocupados actualmente.'}
          {!accion && 'No hay spools disponibles.'}
        </p>
      </div>
    )}
    ```

    5. Handle INICIAR navigation (skip union selection):
    ```typescript
    const handleSpoolSelect = async (spool: Spool) => {
      setSelectedSpool(spool);

      if (accion === 'INICIAR') {
        // For INICIAR, go directly to API call
        try {
          const response = await iniciarSpool({
            tag_spool: spool.tag,
            worker_id: worker.id,
            worker_nombre: `${worker.nombre}(${worker.id})`,
            operacion: operacion as 'ARM' | 'SOLD'
          });

          // Navigate to success
          router.push('/exito');
        } catch (error) {
          // Handle error
          console.error('Error iniciando spool:', error);
        }
      } else {
        // Existing navigation logic
        router.push('/confirmar');
      }
    };
    ```

    IMPORTANT: Preserve existing v3.0 behavior when accion is null
  </action>
  <verify>cd zeues-frontend && npx tsc --noEmit</verify>
  <done>P4 filters spools based on action type with proper navigation logic</done>
</task>

<task type="auto">
  <name>Task 2: Add version column to SpoolTable</name>
  <files>zeues-frontend/components/SpoolTable.tsx</files>
  <action>
    Modify SpoolTable component to display version badges:

    1. Add version detection to spool interface:
    ```typescript
    interface SpoolTableProps {
      spools: Array<Spool & { version?: 'v3.0' | 'v4.0' }>;
      onSelectSpool: (spool: Spool) => void;
      loading?: boolean;
    }
    ```

    2. Add VERSION column to table header:
    ```typescript
    <thead className="bg-gray-50 border-b">
      <tr>
        <th className="px-4 py-3 text-left">Tag</th>
        <th className="px-4 py-3 text-left">Estado</th>
        <th className="px-4 py-3 text-left">Ocupado Por</th>
        <th className="px-4 py-3 text-left">Versión</th>  {/* New column */}
      </tr>
    </thead>
    ```

    3. Create version badge component:
    ```typescript
    const VersionBadge = ({ version }: { version?: 'v3.0' | 'v4.0' }) => {
      if (!version) return <span className="text-gray-400">-</span>;

      return (
        <span className={`
          inline-flex items-center px-2 py-1 text-xs font-medium rounded
          ${version === 'v4.0'
            ? 'text-green-700 bg-green-100'
            : 'text-gray-700 bg-gray-100'}
        `}>
          {version}
        </span>
      );
    };
    ```

    4. Add version badge to table rows:
    ```typescript
    <tbody>
      {spools.map((spool) => (
        <tr
          key={spool.tag}
          onClick={() => onSelectSpool(spool)}
          className="border-b hover:bg-gray-50 cursor-pointer transition-colors"
        >
          <td className="px-4 py-4">{spool.tag}</td>
          <td className="px-4 py-4">{spool.Status_Spool}</td>
          <td className="px-4 py-4">
            {spool.Ocupado_Por || 'DISPONIBLE'}
          </td>
          <td className="px-4 py-4">
            <VersionBadge version={spool.version} />
          </td>
        </tr>
      ))}
    </tbody>
    ```

    5. Add responsive design for mobile:
    ```typescript
    // Make version column optional on small screens
    <th className="px-4 py-3 text-left hidden sm:table-cell">Versión</th>

    // Hide version on mobile
    <td className="px-4 py-4 hidden sm:table-cell">
      <VersionBadge version={spool.version} />
    </td>
    ```

    6. Add visual distinction for occupied spools:
    ```typescript
    <tr className={`
      border-b cursor-pointer transition-colors
      ${spool.Ocupado_Por && spool.Ocupado_Por !== 'DISPONIBLE'
        ? 'bg-yellow-50 hover:bg-yellow-100'
        : 'hover:bg-gray-50'}
    `}>
    ```

    Visual consistency: Green badge for v4.0, gray for v3.0 (matches P3 design)
  </action>
  <verify>cd zeues-frontend && npm run lint</verify>
  <done>SpoolTable displays version badges with responsive design</done>
</task>

<task type="auto">
  <name>Task 3: Detect spool versions in P4</name>
  <files>zeues-frontend/app/seleccionar-spool/page.tsx</files>
  <action>
    Add version detection for each spool in the list:

    1. Import version utilities:
    ```typescript
    import { getUnionMetricas } from '@/lib/api';
    import { detectSpoolVersion, getCachedVersion, cacheSpoolVersion } from '@/lib/version';
    ```

    2. Add version detection after fetching spools:
    ```typescript
    // After filtering spools, detect versions
    const spoolsWithVersions = await Promise.all(
      filtered.map(async (spool) => {
        // Check cache first
        const cached = getCachedVersion(spool.tag);
        if (cached) {
          return { ...spool, version: cached };
        }

        try {
          // Fetch metrics for version detection
          const metrics = await getUnionMetricas(spool.tag);
          const version = detectSpoolVersion(metrics);

          // Cache the result
          cacheSpoolVersion(spool.tag, version);

          return { ...spool, version };
        } catch (error) {
          // Default to v3.0 on error
          console.error(`Error detecting version for ${spool.tag}:`, error);
          return { ...spool, version: 'v3.0' as const };
        }
      })
    );

    setSpools(spoolsWithVersions);
    ```

    3. Optimize with parallel requests (limit concurrency):
    ```typescript
    // Helper to batch promises
    const batchPromises = async <T,>(
      items: T[],
      batchSize: number,
      fn: (item: T) => Promise<any>
    ) => {
      const results = [];
      for (let i = 0; i < items.length; i += batchSize) {
        const batch = items.slice(i, i + batchSize);
        const batchResults = await Promise.all(batch.map(fn));
        results.push(...batchResults);
      }
      return results;
    };

    // Use batching to avoid overwhelming the API
    const spoolsWithVersions = await batchPromises(
      filtered,
      5,  // Process 5 spools at a time
      async (spool) => {
        // Version detection logic from above
      }
    );
    ```

    4. Show loading indicator during version detection:
    ```typescript
    const [detectingVersions, setDetectingVersions] = useState(false);

    // In the fetch function
    setDetectingVersions(true);
    // ... version detection ...
    setDetectingVersions(false);

    // In the UI
    {detectingVersions && (
      <div className="text-sm text-gray-500 mb-2">
        Detectando versiones...
      </div>
    )}
    ```

    5. Handle case where all spools are same version:
    ```typescript
    // After version detection, check if all are same version
    const allSameVersion = spoolsWithVersions.every(
      s => s.version === spoolsWithVersions[0]?.version
    );

    // If all same version, show simplified message
    {allSameVersion && spoolsWithVersions.length > 0 && (
      <div className="text-sm text-gray-500 mb-4">
        Todos los spools son versión {spoolsWithVersions[0].version}
      </div>
    )}
    ```

    Performance: Use session storage cache to minimize API calls
  </action>
  <verify>cd zeues-frontend && npm run build</verify>
  <done>Version detection integrated with caching and batch processing</done>
</task>

</tasks>

<verification>
1. INICIAR action filters to show only disponibles
2. FINALIZAR action filters to show only worker's occupied spools
3. Version badges display correctly (green v4.0, gray v3.0)
4. Session storage caches versions
5. INICIAR navigates directly to API call then success
6. Responsive design hides version column on mobile
7. Build completes successfully
</verification>

<success_criteria>
- [ ] P4 filters spools based on accion value
- [ ] INICIAR shows only available spools (Ocupado_Por empty/DISPONIBLE)
- [ ] FINALIZAR shows only spools occupied by current worker
- [ ] SpoolTable has VERSION column with badges
- [ ] Green badge for v4.0, gray badge for v3.0
- [ ] Version detection uses cached values when available
- [ ] INICIAR calls API directly (skips union selection)
- [ ] Responsive design for mobile screens
- [ ] Batch processing prevents API overload
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-union-selection-ux/12-07-SUMMARY.md`
</output>