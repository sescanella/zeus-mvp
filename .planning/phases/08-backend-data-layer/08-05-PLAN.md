# Plan: Integration Tests and Performance Validation

---
phase: 08-backend-data-layer
plan: 05
type: execute
wave: 2
depends_on: ["08-01-PLAN.md", "08-02-PLAN.md", "08-03-PLAN.md", "08-04-PLAN.md"]
files_modified:
- backend/models/union.py
- tests/integration/test_union_repository_integration.py
- tests/integration/test_metadata_batch_integration.py
- tests/integration/test_performance_target.py
- tests/fixtures/mock_uniones_data.py
autonomous: true

must_haves:
  truths:
    - "10-union batch operations complete in < 1 second"
    - "Union model has all 18 required fields"
    - "Integration tests cover complete workflows"
  artifacts:
    - path: "backend/models/union.py"
      provides: "Union model with 18 fields"
      contains: "class Union.*BaseModel"
    - path: "tests/fixtures/mock_uniones_data.py"
      provides: "Mock data for testing"
      min_lines: 100
    - path: "tests/integration/test_performance_target.py"
      provides: "Performance validation"
      contains: "assert.*<.*1"
  key_links:
    - from: "integration tests"
      to: "batch operations"
      via: "single API calls"
      pattern: "batch_update.*once"
    - from: "performance test"
      to: "1 second target"
      via: "timing assertion"
      pattern: "total_time.*<.*1"
---

<objective>
Validate the entire data layer with integration tests and ensure performance targets are met.

Purpose: Confirm all repository methods work together and meet <1 second performance for 10-union operations.
Output: Comprehensive integration test suite with mock data and performance validation.
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-backend-data-layer/08-CONTEXT.md
@backend/models/union.py
@backend/repositories/union_repository.py
@backend/repositories/metadata_repository.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing 'ot' field to Union model (REPO-09)</name>
  <files>backend/models/union.py</files>
  <action>
    Fix missing 'ot' field in Union model to meet REPO-09 requirement:
    - The Union model exists from Phase 7 with 17 fields, but is MISSING the critical 'ot' field
    - ADD the 'ot' field as the SECOND field (after id, before tag_spool):
      ```python
      ot: str = Field(
          ...,
          description="Work order number (Column B in Uniones) - PRIMARY FK relationship to Operaciones.OT (Column C)",
          min_length=1,
          examples=["OT-123", "OT-456"]
      )
      ```
    - This makes the model have 18 fields total as required
    - Update the model's docstring to clarify:
      - "Foreign Key: OT → Operaciones.OT (Column C) - PRIMARY relationship"
      - "TAG_SPOOL exists in both sheets but OT is the querying field"
    - CRITICAL: The OT field is THE foreign key for querying unions, NOT TAG_SPOOL
    - TAG_SPOOL remains in the model (Column C) but is NOT the primary FK
    - The architectural decision is to query unions by OT, not by TAG_SPOOL
  </action>
  <verify>grep "ot: str = Field" backend/models/union.py</verify>
  <done>REPO-09 requirement met: Union model has all 18 fields with OT as the primary FK</done>
</task>

<task type="auto">
  <name>Task 2: Create mock Uniones data fixture</name>
  <files>tests/fixtures/mock_uniones_data.py</files>
  <action>
    Create comprehensive mock data fixture:
    - Generate 100 mock union rows with realistic data
    - Include 10 different OTs with 10 unions each
    - CRITICAL: Include OT column (Column B) as the PRIMARY relationship field
    - OT is THE foreign key for querying (e.g., "OT-123"), NOT TAG_SPOOL
    - TAG_SPOOL (Column C) exists but is NOT used for relationship queries
    - Mix of completion states (ARM complete, SOLD complete, pending)
    - Use realistic DN_UNION values (4.5, 6.0, 8.0, 10.0, 12.0)
    - Include mix of TIPO_UNION (Brida, Socket, Acople, Codo)
    - Add helper functions: get_by_state(), get_by_ot(), get_disponibles()
    - Format dates using Chile timezone (DD-MM-YYYY HH:MM:SS)
  </action>
  <verify>Mock data includes OT column and realistic union data</verify>
  <done>Mock fixture provides 100 unions with OT relationship</done>
</task>

<task type="auto">
  <name>Task 3: Create UnionRepository integration tests</name>
  <files>tests/integration/test_union_repository_integration.py</files>
  <action>
    Create integration test file:
    - Test complete flow: get_by_ot → batch_update_arm → calculate_metrics
    - Test SOLD workflow with ARM prerequisite validation
    - Test batch update with mix of valid/invalid unions (partial success)
    - Test OT with no unions (graceful empty handling)
    - Test concurrent updates with version/optimistic locking
    - Mock Google Sheets structure with headers including OT column
    - Verify cache invalidation between operations
    - CRITICAL: Verify all operations use OT, not TAG_SPOOL
  </action>
  <verify>pytest tests/integration/test_union_repository_integration.py -xvs passes</verify>
  <done>Integration tests validate complete repository workflows</done>
</task>

<task type="auto">
  <name>Task 4: Create Metadata batch integration tests</name>
  <files>tests/integration/test_metadata_batch_integration.py</files>
  <action>
    Create Metadata integration tests:
    - Test logging 10 union events + 1 spool event together
    - Test auto-chunking with 1000+ events
    - Verify n_union field written to column K
    - Test mixed v3.0 and v4.0 events in same batch
    - Mock append_rows to verify chunking (900 rows per chunk)
    - Test each chunk is exactly 900 rows (except last)
  </action>
  <verify>pytest tests/integration/test_metadata_batch_integration.py -xvs passes</verify>
  <done>Metadata batch tests validate chunking and union granularity</done>
</task>

<task type="auto">
  <name>Task 5: Create performance validation test</name>
  <files>tests/integration/test_performance_target.py</files>
  <action>
    Create performance test:
    - Simulate FINALIZAR operation with 10 unions
    - Time complete flow:
      1. Fetch disponibles by OT
      2. Batch update ARM/SOLD for 10 unions
      3. Batch log 11 Metadata events (10 union + 1 spool)
      4. Calculate updated metrics
    - Assert total_time < 1.0 second
    - Run 5 iterations and calculate average
    - Log breakdown of time per operation
    - Mock API calls to simulate realistic latency (200-500ms)
  </action>
  <verify>Performance test confirms <1 second for 10-union operation</verify>
  <done>10-union batch operations complete in <1 second (performance target met)</done>
</task>

<task type="auto">
  <name>Task 6: Add end-to-end workflow test</name>
  <files>tests/integration/test_union_repository_integration.py</files>
  <action>
    Add comprehensive workflow test:
    - Test INICIAR → work on unions → FINALIZAR flow
    - Start with fresh spool (all 10 unions pending)
    - Perform ARM batch update for 7/10 unions
    - Verify metrics show partial completion (7 ARM, 0 SOLD)
    - Perform SOLD batch update for 5 of the 7 ARM-complete unions
    - Verify final metrics (7 ARM, 5 SOLD, correct pulgadas sums)
    - Verify Metadata audit trail has all events
    - Ensure all operations use batch methods (not loops)
    - Verify batch operations generate 1 API call per batch, not N
  </action>
  <verify>End-to-end test validates complete user workflow</verify>
  <done>Complete workflow from INICIAR to FINALIZAR works correctly</done>
</task>

</tasks>

<verification>
Run all integration tests:
```bash
source venv/bin/activate
python -m pytest tests/integration/test_union_repository_integration.py -xvs
python -m pytest tests/integration/test_metadata_batch_integration.py -xvs
python -m pytest tests/integration/test_performance_target.py -xvs
```

Verify requirements met:
- REPO-09: Union model has all 18 required fields
- Performance: 10-union FINALIZAR completes in < 1 second
- Batch operations use single API calls (not N calls)
</verification>

<success_criteria>
- [ ] Union model verified to have all 18 required fields (REPO-09)
- [ ] Mock data fixture provides 100 realistic union rows with OT column
- [ ] Integration tests cover complete workflows from OT query to metrics
- [ ] Performance test validates <1 second target for 10-union batch
- [ ] Batch operations confirmed to use single API calls, not N calls
</success_criteria>

<output>
After completion, create `.planning/phases/08-backend-data-layer/08-05-SUMMARY.md`
</output>