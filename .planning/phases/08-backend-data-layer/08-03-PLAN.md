# Plan: Implement Metrics Aggregation Methods for Union Tracking

---
phase: 08-backend-data-layer
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
- backend/repositories/union_repository.py
- tests/unit/test_union_repository_metrics.py
autonomous: true

must_haves:
  truths:
    - "Metrics are calculated on-demand from fresh data"
    - "Pulgadas sums use 2 decimal precision (18.50 not 18.5)"
    - "Empty OT returns zeros gracefully"
  artifacts:
    - path: "backend/repositories/union_repository.py"
      provides: "Metrics calculation methods"
      contains: "count_completed_arm|sum_pulgadas_arm|calculate_metrics"
    - path: "tests/unit/test_union_repository_metrics.py"
      provides: "Unit tests for metrics"
      min_lines: 100
  key_links:
    - from: "metrics methods"
      to: "get_by_ot"
      via: "fetch unions then calculate"
      pattern: "get_by_ot\\(ot\\)"
    - from: "sum_pulgadas methods"
      to: "2 decimal precision"
      via: "round(total, 2)"
      pattern: "round\\(.*,\\s*2\\)"
---

<objective>
Implement metrics aggregation methods for v4.0 pulgadas-di√°metro tracking with 2 decimal precision.

Purpose: Calculate union-level metrics on-demand to support Operaciones columns 68-72.
Output: UnionRepository with count and sum methods that provide accurate metrics with proper precision.
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-backend-data-layer/08-CONTEXT.md
@backend/repositories/union_repository.py
@backend/models/union.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement count_completed_arm method</name>
  <files>backend/repositories/union_repository.py</files>
  <action>
    Add count_completed_arm method:
    - Method signature: count_completed_arm(ot: str) -> int
    - Use get_by_ot(ot) to fetch all unions for the work order
    - Count unions where arm_fecha_fin is not None
    - Return 0 if no unions exist for the OT (graceful handling)
    - No caching - always calculate fresh for consistency
  </action>
  <verify>Method counts ARM-completed unions correctly</verify>
  <done>count_completed_arm returns accurate count based on arm_fecha_fin</done>
</task>

<task type="auto">
  <name>Task 2: Implement count_completed_sold method</name>
  <files>backend/repositories/union_repository.py</files>
  <action>
    Add count_completed_sold method:
    - Method signature: count_completed_sold(ot: str) -> int
    - Use get_by_ot(ot) to fetch all unions for the work order
    - Count unions where sol_fecha_fin is not None
    - Return 0 if no unions exist for the OT
    - Ensure consistency with ARM prerequisite
  </action>
  <verify>Method counts SOLD-completed unions correctly</verify>
  <done>count_completed_sold returns accurate count based on sol_fecha_fin</done>
</task>

<task type="auto">
  <name>Task 3: Update sum_pulgadas methods to 2 decimal precision</name>
  <files>backend/repositories/union_repository.py</files>
  <action>
    Update/implement sum_pulgadas methods:
    - Modify existing sum_pulgadas_arm(ot: str) -> float
    - BREAKING CHANGE: Change from round(total, 1) to round(total, 2)
    - Sum DN_UNION for unions where arm_fecha_fin is not None
    - Return 0.00 (not 0.0) for empty results - use round(0, 2)
    - Implement sum_pulgadas_sold with same 2-decimal pattern
    - NOTE: This changes output format from "18.5" to "18.50"
    - All downstream code must expect 2 decimal precision
  </action>
  <verify>Methods return 2 decimal precision (18.50 not 18.5)</verify>
  <done>sum_pulgadas methods return values with exactly 2 decimal places</done>
</task>

<task type="auto">
  <name>Task 4: Add get_total_uniones method</name>
  <files>backend/repositories/union_repository.py</files>
  <action>
    Add get_total_uniones method:
    - Method signature: get_total_uniones(ot: str) -> int
    - Count ALL unions for an OT regardless of completion state
    - This represents the total work scope for a spool
    - Return 0 if OT not found or has no unions
    - Uses get_by_ot(ot) and returns len(unions)
  </action>
  <verify>Method counts all unions regardless of state</verify>
  <done>get_total_uniones returns total count of all unions for OT</done>
</task>

<task type="auto">
  <name>Task 5: Implement calculate_metrics bulk method</name>
  <files>backend/repositories/union_repository.py</files>
  <action>
    Add calculate_metrics method for efficiency:
    - Method signature: calculate_metrics(ot: str) -> dict
    - Single call to get_by_ot(ot), then calculate all metrics
    - Return dict with all metrics:
      - total_uniones: int
      - arm_completadas: int
      - sold_completadas: int
      - pulgadas_arm: float (2 decimals via round(sum, 2))
      - pulgadas_sold: float (2 decimals via round(sum, 2))
    - More efficient than calling 5 separate methods
    - Handle invalid DN_UNION values (skip with warning)
  </action>
  <verify>Method returns all 5 metrics with correct types and precision</verify>
  <done>calculate_metrics provides all metrics in single efficient call</done>
</task>

<task type="auto">
  <name>Task 6: Create comprehensive unit tests</name>
  <files>tests/unit/test_union_repository_metrics.py</files>
  <action>
    Create test file with full coverage:
    - Test count_completed_arm with 0, 5, 10 completed unions
    - Test count_completed_sold with various completion states
    - CRITICAL: Test sum_pulgadas_arm returns 2 decimals (e.g., 18.50)
    - Test sum_pulgadas_sold with mixed completion states
    - Test get_total_uniones counts all unions
    - Test calculate_metrics returns all values correctly
    - Test graceful handling of empty OT (0/0.00 returns)
    - Test invalid DN_UNION values are skipped with warning
    - Mock get_by_ot to return controlled test data
    - Verify no caching (fresh calculation each time)
    - Assert precision: 18.50 not 18.5, 0.00 not 0.0
  </action>
  <verify>pytest tests/unit/test_union_repository_metrics.py -xvs passes</verify>
  <done>All metrics tests pass with 2 decimal precision validation</done>
</task>

</tasks>

<verification>
Run unit tests for metrics calculation:
```bash
source venv/bin/activate
python -m pytest tests/unit/test_union_repository_metrics.py -xvs
```

Verify metrics calculation accuracy:
- Check 2 decimal precision for pulgadas sums (18.50, not 18.5)
- Confirm counts match expected values for various states
- Validate graceful handling returns 0/0.00 for empty results
</verification>

<success_criteria>
- [ ] count_completed_arm and count_completed_sold return accurate counts
- [ ] sum_pulgadas_arm and sum_pulgadas_sold use 2 decimal precision (18.50)
- [ ] get_total_uniones counts ALL unions regardless of state
- [ ] All methods return 0 or 0.00 for empty/missing OT data
- [ ] calculate_metrics provides all 5 metrics in single method call
</success_criteria>

<output>
After completion, create `.planning/phases/08-backend-data-layer/08-03-SUMMARY.md`
</output>