---
phase: 09-redis-version-detection
plan: 05
type: execute
wave: 3
depends_on: ["09-01", "09-02", "09-03", "09-04"]
files_modified:
  - tests/integration/test_persistent_locks_e2e.py
  - tests/integration/test_version_detection_e2e.py
autonomous: true

must_haves:
  truths:
    - "Persistent locks survive for hours without TTL"
    - "Abandoned locks are cleaned up eventually"
    - "Version detection correctly identifies v3.0 and v4.0 spools"
  artifacts:
    - path: "tests/integration/test_persistent_locks_e2e.py"
      provides: "End-to-end lock persistence tests"
      min_lines: 150
    - path: "tests/integration/test_version_detection_e2e.py"
      provides: "End-to-end version detection tests"
      min_lines: 100
  key_links:
    - from: "test_persistent_locks_e2e.py"
      to: "redis_lock_service.py"
      via: "Integration test"
      pattern: "acquire_lock.*persist"
---

<objective>
Create comprehensive integration tests for persistent locks and version detection.

Purpose: Validate end-to-end behavior of persistent locks, cleanup, reconciliation, and version detection.
Output: Integration test suite that verifies all Phase 9 requirements are met.
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-redis-version-detection/09-CONTEXT.md
@.planning/phases/09-redis-version-detection/09-01-SUMMARY.md
@.planning/phases/09-redis-version-detection/09-02-SUMMARY.md
@.planning/phases/09-redis-version-detection/09-03-SUMMARY.md
@.planning/phases/09-redis-version-detection/09-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create persistent lock integration tests</name>
  <files>tests/integration/test_persistent_locks_e2e.py</files>
  <action>
    Create end-to-end tests for persistent lock behavior:

    1. Test lock persistence without TTL:
       - Acquire lock with REDIS_PERSISTENT_LOCKS=True
       - Verify TTL is -1 (no expiration)
       - Wait simulated 5 hours (mock time)
       - Verify lock still exists
    2. Test lazy cleanup flow:
       - Create abandoned lock (>24h old, no Sheets match)
       - Call INICIAR/tomar endpoint
       - Verify abandoned lock was cleaned
       - Verify new lock was acquired
    3. Test startup reconciliation:
       - Set Sheets.Ocupado_Por without Redis lock
       - Restart app (call startup_event)
       - Verify Redis lock was recreated
    4. Test cleanup doesn't remove valid locks:
       - Create lock with matching Sheets.Ocupado_Por
       - Call lazy cleanup
       - Verify lock still exists

    Use real Redis test instance and mock Sheets data.
    Mock time functions to simulate aging.
  </action>
  <verify>pytest tests/integration/test_persistent_locks_e2e.py -v</verify>
  <done>Integration tests validate persistent lock lifecycle</done>
</task>

<task type="auto">
  <name>Task 2: Create version detection integration tests</name>
  <files>tests/integration/test_version_detection_e2e.py</files>
  <action>
    Create end-to-end tests for version detection:

    1. Test v4.0 detection (Total_Uniones > 0):
       - Mock spool with Total_Uniones = 10
       - Call /api/diagnostic/{tag}/version
       - Verify returns version: "v4.0"
    2. Test v3.0 detection (Total_Uniones = 0):
       - Mock spool with Total_Uniones = 0 or None
       - Call endpoint
       - Verify returns version: "v3.0"
    3. Test retry on Sheets failure:
       - Mock Sheets to fail twice, succeed third time
       - Call detect_version()
       - Verify retries and eventual success
    4. Test default to v3.0 after failures:
       - Mock Sheets to always fail
       - Call detect_version()
       - Verify returns v3.0 with error in detection_logic
    5. Test diagnostic endpoint response:
       - Call /api/diagnostic/TEST-01/version
       - Verify response includes all fields
       - Verify detection_logic explains decision

    Use TestClient from FastAPI for API testing.
  </action>
  <verify>pytest tests/integration/test_version_detection_e2e.py -v</verify>
  <done>Integration tests validate version detection accuracy</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify coverage</name>
  <files>tests/</files>
  <action>
    Run complete test suite and check coverage:

    1. Run all Phase 9 tests:
       ```bash
       pytest tests/unit/test_redis_lock_service.py \
              tests/unit/test_lazy_cleanup.py \
              tests/integration/test_startup_reconciliation.py \
              tests/integration/test_persistent_locks_e2e.py \
              tests/integration/test_version_detection_e2e.py \
              -v --tb=short
       ```
    2. Generate coverage report for Phase 9 modules:
       ```bash
       pytest tests/ --cov=backend.services.redis_lock_service \
                     --cov=backend.services.version_detection_service \
                     --cov=backend.routers.diagnostic \
                     --cov-report=term-missing
       ```
    3. Verify all success criteria from roadmap are tested:
       - Redis locks have NO TTL ✓
       - Lazy cleanup removes abandoned locks ✓
       - Startup reconciles from Sheets ✓
       - Version detection by union count ✓
       - v4.0 endpoints reject v3.0 spools ✓

    Fix any test failures or missing coverage.
  </action>
  <verify>pytest tests/ -k "redis or version" --tb=short</verify>
  <done>All Phase 9 tests pass with good coverage</done>
</task>

</tasks>

<verification>
- Persistent locks verified to have no TTL
- Lazy cleanup tested with 24-hour threshold
- Startup reconciliation tested with timeout
- Version detection tested for v3.0 and v4.0 cases
- Retry logic tested with simulated failures
- All Phase 9 requirements have test coverage
</verification>

<success_criteria>
- [ ] Persistent lock tests verify TTL = -1 (no expiration)
- [ ] Cleanup tests verify only abandoned locks removed
- [ ] Reconciliation tests verify Sheets → Redis sync
- [ ] Version tests verify Total_Uniones logic (>0 = v4.0, 0 = v3.0)
- [ ] All tests pass in CI/CD environment
</success_criteria>

<output>
After completion, create `.planning/phases/09-redis-version-detection/09-05-SUMMARY.md`
</output>