---
phase: 09-redis-version-detection
plan: 06
type: execute
wave: 4
depends_on: ["09-04"]
files_modified:
  - zeues-frontend/lib/api.ts
  - zeues-frontend/lib/types.ts
  - zeues-frontend/app/seleccionar-spool/page.tsx
  - zeues-frontend/components/SpoolCard.tsx
autonomous: true

must_haves:
  truths:
    - "Frontend detects spool version by union count"
    - "Version badges appear on spool cards"
    - "Frontend routes to correct workflow based on version"
  artifacts:
    - path: "zeues-frontend/lib/api.ts"
      provides: "Version detection API call"
      exports: ["getSpoolVersion"]
    - path: "zeues-frontend/lib/types.ts"
      provides: "Version type definitions"
      contains: "VersionInfo"
    - path: "zeues-frontend/app/seleccionar-spool/page.tsx"
      provides: "Version detection at P4"
      contains: "getSpoolVersion"
    - path: "zeues-frontend/components/SpoolCard.tsx"
      provides: "Version badge display"
      contains: "version badge"
  key_links:
    - from: "seleccionar-spool/page.tsx"
      to: "api.ts"
      via: "getSpoolVersion call"
      pattern: "getSpoolVersion\\(tag\\)"
    - from: "SpoolCard.tsx"
      to: "version prop"
      via: "conditional rendering"
      pattern: "version.*v4\\.0.*v3\\.0"
---

<objective>
Implement frontend version detection to identify v3.0 vs v4.0 spools and display version badges.

Purpose: Enable frontend to detect spool version by union count and route to appropriate workflow.
Output: Frontend components that fetch version info, display badges, and support dual workflows.
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-redis-version-detection/09-CONTEXT.md
@.planning/phases/09-redis-version-detection/09-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add version types to TypeScript</name>
  <files>zeues-frontend/lib/types.ts</files>
  <action>
    Add TypeScript interfaces for version detection:

    1. VersionInfo interface:
       ```typescript
       export interface VersionInfo {
         version: 'v3.0' | 'v4.0';
         union_count: number;
         detection_logic: string;
         tag_spool: string;
       }
       ```

    2. VersionResponse interface:
       ```typescript
       export interface VersionResponse {
         success: boolean;
         data: VersionInfo;
       }
       ```

    3. Update Spool interface to include version detection:
       ```typescript
       export interface Spool {
         tag_spool: string;
         // ... existing fields ...
         total_uniones?: number;  // Column 68
         version?: 'v3.0' | 'v4.0';  // Derived from total_uniones
       }
       ```

    4. Version detection logic comment:
       ```typescript
       // Version detection: count > 0 = v4.0, count = 0 = v3.0
       ```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>TypeScript types define version structures with no type errors</done>
</task>

<task type="auto">
  <name>Task 2: Add version detection API call</name>
  <files>zeues-frontend/lib/api.ts</files>
  <action>
    Add API function to fetch spool version:

    1. getSpoolVersion function:
       ```typescript
       export async function getSpoolVersion(tag: string): Promise<VersionInfo> {
         try {
           const response = await fetch(
             `${API_BASE_URL}/api/diagnostic/${tag}/version`,
             {
               method: 'GET',
               headers: {
                 'Content-Type': 'application/json',
               },
             }
           );

           if (!response.ok) {
             // Default to v3.0 on error
             return {
               version: 'v3.0',
               union_count: 0,
               detection_logic: 'Error fetching version, defaulting to v3.0',
               tag_spool: tag,
             };
           }

           const data: VersionResponse = await response.json();
           return data.data;
         } catch (error) {
           console.error('Version detection failed:', error);
           // Default to v3.0 on network error
           return {
             version: 'v3.0',
             union_count: 0,
             detection_logic: 'Network error, defaulting to v3.0',
             tag_spool: tag,
           };
         }
       }
       ```

    2. Alternative: Detect from spool data directly:
       ```typescript
       export function detectVersionFromSpool(spool: Spool): 'v3.0' | 'v4.0' {
         // Frontend detection logic: count > 0 = v4.0, count = 0 = v3.0
         return (spool.total_uniones && spool.total_uniones > 0) ? 'v4.0' : 'v3.0';
       }
       ```

    Note: User decision states "Frontend detects by union count" - provide both API and local detection.
  </action>
  <verify>grep "getSpoolVersion\|detectVersionFromSpool" zeues-frontend/lib/api.ts</verify>
  <done>API functions for version detection are implemented</done>
</task>

<task type="auto">
  <name>Task 3: Display version badges on spool cards</name>
  <files>zeues-frontend/components/SpoolCard.tsx</files>
  <action>
    Add version badge to SpoolCard component:

    1. Accept version prop:
       ```typescript
       interface SpoolCardProps {
         spool: Spool;
         version?: 'v3.0' | 'v4.0';
         // ... other props
       }
       ```

    2. Display version badge:
       ```typescript
       return (
         <div className="...existing classes...">
           {/* Version badge - top right corner */}
           {version && (
             <div className={`absolute top-2 right-2 px-2 py-1 text-xs font-semibold rounded
               ${version === 'v4.0'
                 ? 'bg-green-100 text-green-800 border border-green-300'
                 : 'bg-gray-100 text-gray-700 border border-gray-300'
               }`}>
               {version}
             </div>
           )}

           {/* Rest of card content */}
           <h3>{spool.tag_spool}</h3>
           {/* ... */}
         </div>
       );
       ```

    3. Style considerations:
       - Small, non-intrusive badge
       - Different colors for v3.0 (gray) vs v4.0 (green)
       - Positioned to not obstruct spool information

    Reference: User decision "Show version badge ('v3.0' or 'v4.0') on spool cards for transparency"
  </action>
  <verify>grep "version badge\|v4.0.*v3.0" zeues-frontend/components/SpoolCard.tsx</verify>
  <done>SpoolCard displays version badge with appropriate styling</done>
</task>

<task type="auto">
  <name>Task 4: Integrate version detection in spool selection</name>
  <files>zeues-frontend/app/seleccionar-spool/page.tsx</files>
  <action>
    Add version detection to P4 (spool selection page):

    1. Detect version for each spool:
       ```typescript
       // In page component
       useEffect(() => {
         const fetchSpoolsWithVersion = async () => {
           const spools = await getAvailableSpools(operacion);

           // Detect version for each spool (local detection)
           const spoolsWithVersion = spools.map(spool => ({
             ...spool,
             version: detectVersionFromSpool(spool)
           }));

           setSpools(spoolsWithVersion);
         };

         fetchSpoolsWithVersion();
       }, [operacion]);
       ```

    2. Pass version to SpoolCard:
       ```typescript
       {spools.map((spool) => (
         <SpoolCard
           key={spool.tag_spool}
           spool={spool}
           version={spool.version}
           onClick={() => handleSpoolSelect(spool)}
         />
       ))}
       ```

    3. Cache version per session:
       ```typescript
       // Store in context or session storage
       const handleSpoolSelect = (spool: Spool) => {
         sessionStorage.setItem(`spool_version_${spool.tag_spool}`, spool.version);
         // ... continue with selection
       };
       ```

    4. Auto-redirect logic (if needed):
       ```typescript
       // Check if workflow mismatch
       if (spool.version === 'v4.0' && currentWorkflow === 'v3') {
         // Redirect to v4.0 workflow
         router.push('/iniciar-union');
       }
       ```

    Note: User decision "Fetch version at P4 (spool selection) â€” just-in-time detection"
  </action>
  <verify>grep "detectVersionFromSpool\|version:" zeues-frontend/app/seleccionar-spool/page.tsx</verify>
  <done>Spool selection page detects and displays version for each spool</done>
</task>

</tasks>

<verification>
- Frontend detects version using Total_Uniones count (>0 = v4.0, 0 = v3.0)
- Version badges appear on spool cards with appropriate styling
- Version detection happens at P4 (spool selection)
- Version is cached per session for reuse
- TypeScript types are properly defined with no errors
</verification>

<success_criteria>
- [ ] VersionInfo and VersionResponse types defined in types.ts
- [ ] getSpoolVersion() fetches from diagnostic endpoint
- [ ] detectVersionFromSpool() uses union count logic locally
- [ ] SpoolCard displays version badge (green for v4.0, gray for v3.0)
- [ ] P4 detects version for each spool on load
- [ ] Version detection respects user decision for frontend detection by union count
</success_criteria>

<output>
After completion, create `.planning/phases/09-redis-version-detection/09-06-SUMMARY.md`
</output>