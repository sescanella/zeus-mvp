---
phase: 02-core-location-tracking
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - backend/services/conflict_service.py
  - backend/repositories/sheets_repository.py
  - backend/services/occupation_service.py
  - backend/models/conflict.py
autonomous: true
must_haves:
  truths:
    - "Every spool update checks version token for conflicts"
    - "Version conflicts trigger retry with exponential backoff"
    - "Concurrent updates detect and handle version mismatches"
    - "System generates unique version tokens for each change"
  artifacts:
    - path: "backend/services/conflict_service.py"
      provides: "Optimistic locking with version token management"
      exports: ["ConflictService", "update_with_version_check", "generate_version_token"]
    - path: "backend/models/conflict.py"
      provides: "Version conflict models and retry configuration"
      contains: "class VersionConflict"
  key_links:
    - from: "backend/services/conflict_service.py"
      to: "sheets_repository"
      via: "Version token validation before update"
      pattern: "if.*version.*!=.*expected"
    - from: "backend/services/occupation_service.py"
      to: "conflict_service"
      via: "Retry logic integration"
      pattern: "@retry.*VersionConflictError"
---

<objective>
Implement optimistic locking with version tokens to handle concurrent sheet updates safely

Purpose: Secondary defense against race conditions through version validation at database layer
Output: ConflictService that detects and retries version conflicts automatically
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-location-tracking/02-CONTEXT.md
@.planning/phases/02-core-location-tracking/02-RESEARCH.md

# Reference implementations from previous plans
@.planning/phases/02-core-location-tracking/02-01-SUMMARY.md
@.planning/phases/02-core-location-tracking/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conflict models and retry configuration</name>
  <files>backend/models/conflict.py</files>
  <action>
    Define models for version conflict handling:

    1. VersionConflict model:
       - tag_spool: str
       - expected_version: str
       - actual_version: str
       - operation: str (TOMAR/PAUSAR/COMPLETAR)
       - retry_count: int
       - max_retries: int = 3

    2. RetryConfig:
       - max_attempts: int = 3
       - base_delay_ms: int = 100
       - max_delay_ms: int = 10000
       - exponential_base: float = 2.0
       - jitter: bool = True

    3. ConflictResolution enum:
       - RETRY: Attempt operation again
       - ABORT: Give up and return error
       - MERGE: Attempt to merge changes (future enhancement)

    Follow Pydantic patterns from existing models.
    Include validation for retry parameters.
  </action>
  <verify>grep "class VersionConflict" backend/models/conflict.py shows model definition</verify>
  <done>Conflict models define version tracking and retry behavior</done>
</task>

<task type="auto">
  <name>Task 2: Extend sheets repository with version column</name>
  <files>backend/repositories/sheets_repository.py</files>
  <action>
    Add version token support to SheetsRepository:

    1. Extend column mapping to include "version" column (column 66 in v3.0 schema)

    2. Add version-aware update method:
       - update_spool_with_version(tag_spool, updates: dict, expected_version: str)
       - Read current version from sheet
       - Compare with expected_version
       - If mismatch: raise VersionConflictError
       - If match: update row including new version token
       - Use batch_update for atomic multi-cell updates

    3. Add version reading:
       - get_spool_version(tag_spool): Return current version token
       - Include version in Spool model as optional field

    4. Handle missing version column gracefully:
       - If version column empty, treat as version "0"
       - First update adds initial version token

    Maintain backward compatibility with existing update_spool method.
    Use UUID4 for version tokens (no sequential counters).
  </action>
  <verify>grep "update_spool_with_version" backend/repositories/sheets_repository.py shows method</verify>
  <done>Sheets repository supports version-aware updates with conflict detection</done>
</task>

<task type="auto">
  <name>Task 3: Implement ConflictService with retry logic</name>
  <files>backend/services/conflict_service.py, backend/services/occupation_service.py</files>
  <action>
    1. Create ConflictService class:
       - generate_version_token(): Return UUID4 string
       - calculate_retry_delay(attempt: int, config: RetryConfig): Exponential backoff with jitter

       - update_with_retry(repository, tag_spool, updates, max_attempts=3):
         * Loop up to max_attempts
         * Read current version
         * Attempt update with version check
         * On VersionConflictError: wait with backoff, retry
         * On success: return new version
         * After max_attempts: raise final error

       - detect_conflict_pattern(conflicts: List[VersionConflict]):
         * Analyze if conflicts are on same spools (hot spots)
         * Return recommendations for conflict reduction

    2. Integrate with OccupationService:
       - Wrap sheet updates in update_with_retry
       - Use tenacity @retry decorator for clean syntax:
         ```python
         @retry(
             stop=stop_after_attempt(3),
             wait=wait_exponential(multiplier=0.1, max=10),
             retry=retry_if_exception_type(VersionConflictError),
             before_sleep=log_retry_attempt
         )
         ```
       - Log conflict metrics for monitoring
       - Return clear messages on permanent conflicts

    3. Add conflict metrics:
       - Track retry success rate
       - Log hot spot spools with frequent conflicts
       - Alert on high conflict rates (>10%)

    Use dependency injection for ConflictService in OccupationService.
  </action>
  <verify>grep "@retry" backend/services/occupation_service.py shows retry decorator usage</verify>
  <done>ConflictService provides automatic retry with exponential backoff for version conflicts</done>
</task>

</tasks>

<verification>
1. Version tokens generated as UUID4 strings
2. Sheet updates validate version before writing
3. Version conflicts trigger automatic retry with backoff
4. Maximum 3 retry attempts before failing
5. Conflict patterns detected and logged
6. OccupationService integrates version checking seamlessly
</verification>

<success_criteria>
- Every sheet update includes version validation
- Concurrent updates detect version mismatches
- Retry logic handles transient conflicts
- System maintains consistency under concurrent load
- Clear error messages after max retries exceeded
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-location-tracking/02-03-SUMMARY.md`
</output>