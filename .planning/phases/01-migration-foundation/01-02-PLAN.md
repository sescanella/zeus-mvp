# Plan 01-02: Column Mapping Infrastructure for v3.0

---
phase: 01-migration-foundation
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - backend/core/column_map_cache.py (update)
  - backend/repositories/sheets_repository.py (update)
  - backend/models/spool.py (update)
  - backend/models/enums.py (update)
  - tests/conftest.py (update)
autonomous: true

must_haves:
  truths:
    - "System recognizes and maps all 68 columns (65 v2.1 + 3 v3.0)"
    - "v3.0 fields accessible through Spool model without breaking v2.1 access"
    - "Backward compatibility mode preserves v2.1 functionality completely"
  artifacts:
    - path: "backend/core/column_map_cache.py"
      provides: "Dynamic column mapping for v3.0"
      contains: "ocupadopor|fechaocupacion|version"
    - path: "backend/models/spool.py"
      provides: "v3.0 field definitions"
      contains: "ocupado_por|fecha_ocupacion|version"
    - path: "backend/models/enums.py"
      provides: "v3.0 event types"
      contains: "TOMAR_SPOOL|PAUSAR_SPOOL"
  key_links:
    - from: "backend/repositories/sheets_repository.py"
      to: "column_map_cache"
      via: "column index lookup"
      pattern: "get_column_index.*ocupado"
    - from: "backend/models/spool.py"
      to: "esta_ocupado property"
      via: "computed field"
      pattern: "@property.*esta_ocupado"
---

<objective>
Update the dynamic column mapping infrastructure to handle v3.0's new columns while maintaining backward compatibility with v2.1 column access patterns.

Purpose: Enable code to access new v3.0 columns without breaking existing v2.1 functionality
Output: Updated column mapping, Spool model, and repository methods for v3.0 fields
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-migration-foundation/01-01-SUMMARY.md
@backend/core/column_map_cache.py
@backend/models/spool.py
@backend/models/enums.py
@backend/repositories/sheets_repository.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend column mapping and models</name>
  <files>backend/core/column_map_cache.py, backend/models/spool.py, backend/models/enums.py</files>
  <action>
    Update backend/core/column_map_cache.py:
    - Add v3.0 column name normalization:
      * "Ocupado_Por" -> "ocupadopor"
      * "Fecha_Ocupacion" -> "fechaocupacion"
      * "version" -> "version"
    - Extend get_column_index() to handle v3.0 columns
    - Add validation that v3.0 columns exist when in v3 mode

    Extend backend/models/spool.py:
    - Add fields: ocupado_por: Optional[str], fecha_ocupacion: Optional[str], version: int = 0
    - Add @property esta_ocupado that returns True if ocupado_por is not None
    - Keep all v2.1 fields unchanged

    Update backend/models/enums.py:
    - Add EventoTipo: TOMAR_SPOOL, PAUSAR_SPOOL
    - Add EstadoOcupacion enum: DISPONIBLE, OCUPADO
  </action>
  <verify>python -c "from backend.models.spool import Spool; s = Spool(tag_spool='TEST'); print(hasattr(s, 'ocupado_por'))"</verify>
  <done>Spool model has v3.0 fields, column mapping recognizes new columns, enums include v3.0 event types</done>
</task>

<task type="auto">
  <name>Task 2: Add repository v3.0 methods with compatibility mode</name>
  <files>backend/repositories/sheets_repository.py, tests/conftest.py</files>
  <action>
    Update backend/repositories/sheets_repository.py:
    - Add read methods: get_ocupado_por(), get_fecha_ocupacion(), get_version()
    - Add write methods: set_ocupado_por(), set_fecha_ocupacion(), increment_version()
    - Implement compatibility_mode flag (v2.1 or v3.0)
    - In v2.1 mode: return None/0 for v3.0 columns
    - In v3.0 mode: read/write both old and new columns
    - Default to v2.1 mode until migration complete

    Update tests/conftest.py:
    - Add to mock_column_map: "ocupadopor": 66, "fechaocupacion": 67, "version": 68
    - Add v3_mode flag to test fixtures
    - Ensure test isolation with clear_column_map_cache
  </action>
  <verify>grep -q "ocupadopor" tests/conftest.py 2>/dev/null && echo "Fixture updated" || echo "Ready to update fixture"</verify>
  <done>Repository has v3.0 methods, compatibility mode works, test fixtures include v3.0 columns</done>
</task>

<task type="auto">
  <name>Task 3: Verify backward compatibility</name>
  <files>backend/repositories/sheets_repository.py</files>
  <action>
    Run subset of existing v2.1 tests to verify compatibility:
    - Test that v2.1 column access still works
    - Verify compatibility_mode="v2.1" ignores v3.0 columns
    - Confirm no v3.0 code breaks v2.1 functionality
    - Check that batch_update handles both column sets

    Create simple test script that:
    1. Sets compatibility_mode="v2.1"
    2. Attempts v3.0 column access (should return safe defaults)
    3. Verifies v2.1 operations work
    4. Switches to compatibility_mode="v3.0"
    5. Verifies both column sets accessible
  </action>
  <verify>python -c "from backend.repositories.sheets_repository import SheetsRepository; print('v2.1 compatibility preserved')"</verify>
  <done>v2.1 functionality unaffected, compatibility mode switches correctly, all column sets accessible</done>
</task>

</tasks>

<verification>
Test ColumnMapCache with 68 columns mock.
Verify Spool model includes v3.0 fields.
Confirm repository v3.0 methods work.
Validate backward compatibility mode.
</verification>

<success_criteria>
1. ColumnMapCache maps all 68 columns correctly
2. Spool model has v3.0 fields without breaking v2.1
3. SheetsRepository provides v3.0 column access
4. Backward compatibility ensures v2.1 continues working
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration-foundation/01-02-SUMMARY.md`
</output>