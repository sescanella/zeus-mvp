# Plan 01-04: Migration Coordinator and Rollback System

---
phase: 01-migration-foundation
plan: 04
type: execute
wave: 4
depends_on: [01-01, 01-02, 01-03]
files_modified:
  - backend/scripts/migration_coordinator.py (new)
  - backend/scripts/rollback_migration.py (new)
  - backend/scripts/verify_migration.py (new)
  - backend/migration_config.json (new)
  - backend/logs/ (new directory)
autonomous: true

must_haves:
  truths:
    - "Migration executes atomically with checkpoints"
    - "Rollback restores v2.1 state completely"
    - "Migration success is objectively verifiable"
  artifacts:
    - path: "backend/scripts/migration_coordinator.py"
      provides: "Master migration orchestration"
      min_lines: 100
    - path: "backend/scripts/rollback_migration.py"
      provides: "Safe rollback capability"
      min_lines: 60
    - path: "backend/scripts/verify_migration.py"
      provides: "Migration validation"
      min_lines: 50
  key_links:
    - from: "migration_coordinator.py"
      to: "backup_sheet.py"
      via: "subprocess call"
      pattern: "subprocess.*backup_sheet"
    - from: "migration_coordinator.py"
      to: "add_v3_columns.py"
      via: "subprocess call"
      pattern: "subprocess.*add_v3_columns"
---

<objective>
Create a master migration coordinator script that orchestrates the entire v2.1 â†’ v3.0 migration process with checkpoints, verification, and rollback capability.

Purpose: Ensure migration is atomic, verifiable, and reversible
Output: Coordinator script with checkpoint system and rollback capability
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-migration-foundation/01-01-SUMMARY.md
@.planning/phases/01-migration-foundation/01-02-SUMMARY.md
@.planning/phases/01-migration-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration configuration and coordinator</name>
  <files>backend/migration_config.json, backend/scripts/migration_coordinator.py, backend/logs/</files>
  <action>
    Create backend/migration_config.json:
    ```json
    {
      "production_sheet_id": "17iOaq2sv4mSOuJY4B8dGQIsWTTUKPspCtb7gk6u-MaQ",
      "backup_folder_id": null,
      "migration_steps": [
        "create_backup",
        "add_v3_columns",
        "verify_schema",
        "initialize_versions",
        "test_smoke"
      ],
      "rollback_window_days": 7,
      "dry_run": false,
      "log_level": "INFO"
    }
    ```

    Implement migration_coordinator.py:
    - Load migration_config.json
    - Execute steps: backup, add columns, verify, initialize, test
    - Create checkpoint after each step in backend/logs/checkpoints/
    - If any step fails, stop and show rollback instructions
    - Log to backend/logs/migration_TIMESTAMP.log
    - Show progress bar with step counter
    - Generate final migration report
  </action>
  <verify>[ -f backend/scripts/migration_coordinator.py ] && python backend/scripts/migration_coordinator.py --help || mkdir -p backend/logs && ls -la backend/logs/</verify>
  <done>Coordinator script exists with help, logs directory created, checkpoint system ready</done>
</task>

<task type="auto">
  <name>Task 2: Implement verification and rollback scripts</name>
  <files>backend/scripts/verify_migration.py, backend/scripts/rollback_migration.py</files>
  <action>
    Implement verify_migration.py:
    - Check column count = 68
    - Verify new column headers exist
    - Sample 10 random rows, verify version=0
    - Confirm Ocupado_Por and Fecha_Ocupacion empty
    - Validate v2.1 data intact (spot check)
    - Test column mapping cache recognizes new columns
    - Return JSON report with pass/fail

    Implement rollback_migration.py:
    - Restore sheet from backup (requires backup_id)
    - Remove v3.0 columns if partially added
    - Clear column mapping cache
    - Restore v2.1 test suite from archive
    - Log all rollback operations
    - Include 7-day rollback window check
    - Generate rollback confirmation report
  </action>
  <verify>[ -f backend/scripts/verify_migration.py ] && python backend/scripts/verify_migration.py --dry-run || [ -f backend/scripts/rollback_migration.py ] && python backend/scripts/rollback_migration.py --help || echo "Scripts ready"</verify>
  <done>Verification script validates migration, rollback script can restore v2.1 state</done>
</task>

<task type="auto">
  <name>Task 3: Test checkpoint recovery and error handling</name>
  <files>backend/scripts/migration_coordinator.py</files>
  <action>
    Add checkpoint recovery to coordinator:
    - On restart, check backend/logs/checkpoints/ for completed steps
    - Skip completed steps automatically
    - Add --force flag to override checkpoints
    - Clean checkpoints after successful migration

    Test with simulated failures:
    - Kill coordinator after step 2
    - Restart and verify it continues from step 3
    - Test --force flag restarts from beginning
    - Verify error messages are clear and actionable
  </action>
  <verify>[ -f backend/scripts/migration_coordinator.py ] && python backend/scripts/migration_coordinator.py --dry-run || [ -d backend/logs/checkpoints/ ] && ls backend/logs/checkpoints/ || echo "Checkpoints ready"</verify>
  <done>Checkpoint system enables safe restart, error recovery tested, --force flag works</done>
</task>

</tasks>

<verification>
Test dry-run mode shows all steps without changes.
Run against test sheet and verify all steps complete.
Test checkpoint recovery after interruption.
Verify rollback restores v2.1 state.
</verification>

<success_criteria>
1. Migration coordinator executes atomically
2. Checkpoint system enables safe restart
3. Verification confirms migration success
4. Rollback restores v2.1 completely
5. Comprehensive logging for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration-foundation/01-04-SUMMARY.md`
</output>