# Plan 01-05: End-to-End Migration Verification Suite

---
phase: 01-migration-foundation
plan: 05
type: execute
wave: 5
depends_on: [01-04]
files_modified:
  - tests/v3.0/test_migration_e2e.py (new)
  - tests/v3.0/test_rollback.py (new)
  - backend/scripts/test_migration_harness.py (new)
  - .github/workflows/migration_test.yml (new)
autonomous: true

must_haves:
  truths:
    - "Full migration works end-to-end with realistic data"
    - "Rollback is tested and proven safe"
    - "CI pipeline prevents breaking changes"
    - "Production readiness metrics are green"
  artifacts:
    - path: "tests/v3.0/test_migration_e2e.py"
      provides: "Full migration flow tests"
      min_lines: 60
    - path: "tests/v3.0/test_rollback.py"
      provides: "Rollback scenario tests"
      min_lines: 40
    - path: "backend/scripts/test_migration_harness.py"
      provides: "Test environment orchestration"
      min_lines: 80
  key_links:
    - from: "test_migration_harness.py"
      to: "migration_coordinator.py"
      via: "subprocess execution"
      pattern: "subprocess.*migration_coordinator"
    - from: ".github/workflows/migration_test.yml"
      to: "test_migration_harness.py"
      via: "CI execution"
      pattern: "python.*test_migration_harness"
---

<objective>
Create comprehensive end-to-end tests that verify the entire migration process works correctly, including rollback scenarios and production-readiness checks.

Purpose: Ensure migration is thoroughly tested before production deployment
Output: E2E test suite with CI integration and production readiness validation
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-migration-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E migration and rollback tests</name>
  <files>tests/v3.0/test_migration_e2e.py, tests/v3.0/test_rollback.py</files>
  <action>
    Implement test_migration_e2e.py:
    - test_full_migration_flow() - Run coordinator, verify all steps
    - test_migration_with_active_operations() - Migrate with v2.1 ops in progress
    - test_large_sheet_migration() - Test with 1000+ spools
    - test_migration_idempotency() - Run twice, verify no errors
    - test_concurrent_access_during_migration() - v2.1 API works during migration

    Implement test_rollback.py:
    - test_rollback_after_backup() - Can rollback after step 1
    - test_rollback_after_columns_added() - Can rollback after step 2
    - test_rollback_preserves_v21_data() - No data loss during rollback
    - test_rollback_cleans_v3_artifacts() - All v3.0 traces removed
    - test_cannot_rollback_after_window() - After 7 days, rollback blocked
  </action>
  <verify>[ -f tests/v3.0/test_migration_e2e.py ] && pytest tests/v3.0/test_migration_e2e.py::test_full_migration_flow -v || echo "E2E tests ready"</verify>
  <done>E2E tests verify full migration flow, rollback tested at each checkpoint</done>
</task>

<task type="auto">
  <name>Task 2: Create test harness and CI pipeline</name>
  <files>backend/scripts/test_migration_harness.py, .github/workflows/migration_test.yml</files>
  <action>
    Implement test_migration_harness.py:
    - Create isolated test environment with sheet copy
    - Populate with realistic test data (100+ spools)
    - Run migration_coordinator.py against test sheet
    - Execute all E2E tests
    - Generate test report with coverage metrics
    - Clean up test artifacts
    - Return pass/fail status code

    Create .github/workflows/migration_test.yml:
    ```yaml
    name: Migration Test Suite
    on:
      pull_request:
        branches: [v3.0-dev]
    jobs:
      test-migration:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v3
          - uses: actions/setup-python@v4
          - run: pip install -r backend/requirements.txt
          - run: python backend/scripts/test_migration_harness.py
          - uses: actions/upload-artifact@v3
            with:
              name: migration-test-report
              path: backend/logs/test_report.json
    ```
  </action>
  <verify>[ -f backend/scripts/test_migration_harness.py ] && python backend/scripts/test_migration_harness.py --help || [ -f .github/workflows/migration_test.yml ] && cat .github/workflows/migration_test.yml || echo "Harness ready"</verify>
  <done>Test harness orchestrates full test environment, CI pipeline configured</done>
</task>

<task type="auto">
  <name>Task 3: Add production readiness validation</name>
  <files>tests/v3.0/test_migration_e2e.py</files>
  <action>
    Add production readiness checks to test_migration_e2e.py:
    - API health check returns v3.0 schema info
    - Performance: < 2 seconds for 50-spool batch
    - Memory usage stable over 1000 operations
    - Error rate < 0.1% on migration operations
    - All critical v2.1 workflows still function

    Run full test suite and verify:
    ```bash
    pytest tests/v3.0/ -v --tb=short
    ```

    All tests pass, execution time < 60 seconds total
  </action>
  <verify>pytest tests/v3.0/ --collect-only | grep "test session" | grep -o "[0-9]* items"</verify>
  <done>Production readiness metrics verified, all tests pass, performance within SLA</done>
</task>

</tasks>

<verification>
Run E2E migration tests and verify all pass.
Execute test harness against test sheet.
Trigger CI pipeline with test PR.
Confirm production readiness metrics.
</verification>

<success_criteria>
1. Full migration E2E test passes
2. Rollback tested and proven safe
3. CI pipeline prevents breaking changes
4. Production readiness metrics green
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration-foundation/01-05-SUMMARY.md`
</output>