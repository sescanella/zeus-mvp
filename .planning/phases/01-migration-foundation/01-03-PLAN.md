# Plan 01-03: Test Migration and v3.0 Smoke Tests

---
phase: 01-migration-foundation
plan: 03
type: execute
wave: 3
depends_on: [01-01, 01-02]
files_modified:
  - tests/v2.1-archive/ (new directory)
  - tests/v3.0/ (new directory)
  - tests/v3.0/test_migration_smoke.py (new)
  - tests/v3.0/test_v3_columns.py (new)
  - tests/v3.0/test_backward_compatibility.py (new)
  - pytest.ini (update)
  - backend/scripts/archive_v2_tests.py (new)
autonomous: true

must_haves:
  truths:
    - "244 v2.1 tests pass before archiving (BC-02 requirement)"
    - "Historical test knowledge is preserved for debugging"
    - "Migration changes are automatically validated"
    - "New v3.0 columns are proven functional"
    - "v2.1 API operations continue working unchanged"
  artifacts:
    - path: "tests/v3.0/test_migration_smoke.py"
      provides: "Core migration verification"
      min_lines: 50
    - path: "tests/v3.0/test_v3_columns.py"
      provides: "v3.0 column validation"
      min_lines: 40
    - path: "tests/v3.0/test_backward_compatibility.py"
      provides: "v2.1 compatibility checks"
      min_lines: 40
  key_links:
    - from: "backend/scripts/archive_v2_tests.py"
      to: "backend/scripts/"
      via: "directory existence check"
      pattern: "os.path.exists.*backend/scripts"
    - from: "tests/v3.0/"
      to: "conftest.py"
      via: "v3.0 fixtures"
      pattern: "from.*conftest.*import"
---

<objective>
Archive existing v2.1 tests to preserve them as reference and create focused v3.0 smoke tests that verify the migration foundation works correctly.

Purpose: Establish minimal test suite to verify migration success without maintaining all 244 v2.1 tests
Output: Archived v2.1 tests and new v3.0 smoke test suite
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-migration-foundation/01-01-SUMMARY.md
@.planning/phases/01-migration-foundation/01-02-SUMMARY.md
@tests/conftest.py
@pytest.ini
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify v2.1 tests pass then archive</name>
  <files>backend/scripts/archive_v2_tests.py, tests/v2.1-archive/, tests/v3.0/</files>
  <action>
    First run ALL v2.1 tests to satisfy BC-02 requirement:
    ```bash
    pytest tests/ -v --tb=short
    ```
    Verify all 244 tests pass. If any fail, stop and fix them before proceeding.

    Create backend/scripts/archive_v2_tests.py that:
    - First checks if backend/scripts/ directory exists (created in Plan 01-01)
    - If not exists, creates it
    - Validates all 244 v2.1 tests passed (reads pytest results)
    - Moves entire tests/ directory to tests/v2.1-archive/
    - Preserves directory structure and all test files
    - Creates timestamp marker: v2.1-archive/ARCHIVED_ON.txt
    - Records test pass count in v2.1-archive/TEST_RESULTS.txt
    - Logs all moved files

    Create new tests/v3.0/ structure:
    - tests/v3.0/__init__.py
    - tests/v3.0/conftest.py (v3.0-specific fixtures)

    Update pytest.ini:
    - Exclude tests/v2.1-archive/ from discovery
    - Add markers: @pytest.mark.v3, @pytest.mark.migration
    - Set default path to tests/v3.0/
  </action>
  <verify>[ -d tests/v3.0/ ] && echo "v3.0 ready" || echo "Ready to archive"</verify>
  <done>244 v2.1 tests passed (BC-02), archived with results, v3.0 test directory created</done>
</task>

<task type="auto">
  <name>Task 2: Implement core smoke tests</name>
  <files>tests/v3.0/test_migration_smoke.py, tests/v3.0/test_v3_columns.py</files>
  <action>
    Implement tests/v3.0/test_migration_smoke.py:
    1. test_can_read_v3_columns() - Verify Ocupado_Por, Fecha_Ocupacion, version readable
    2. test_can_write_v3_columns() - Verify new columns accept writes
    3. test_version_increments() - Verify version increments correctly
    4. test_v21_columns_still_readable() - Verify v2.1 columns work
    5. test_sheet_has_68_columns() - Verify schema expansion

    Implement tests/v3.0/test_v3_columns.py:
    - test_ocupado_por_format() - Verify "INICIALES(ID)" format
    - test_fecha_ocupacion_format() - Verify date format
    - test_version_starts_at_zero() - Verify initialization
    - test_column_positions() - Verify positions 66, 67, 68
    - test_column_names_normalized() - Verify normalization
  </action>
  <verify>[ -f tests/v3.0/test_migration_smoke.py ] && pytest tests/v3.0/test_migration_smoke.py::test_can_read_v3_columns -v || echo "Tests created"</verify>
  <done>Smoke tests verify v3.0 columns work, v2.1 columns preserved, 68 total columns</done>
</task>

<task type="auto">
  <name>Task 3: Add backward compatibility tests</name>
  <files>tests/v3.0/test_backward_compatibility.py</files>
  <action>
    Implement tests/v3.0/test_backward_compatibility.py:
    - test_v21_mode_ignores_v3_columns() - v2.1 mode returns None for v3 columns
    - test_v30_mode_reads_both() - v3.0 mode accesses all columns
    - test_v21_api_endpoints_work() - /api/iniciar-accion functions
    - test_metadata_accepts_new_events() - TOMAR_SPOOL, PAUSAR_SPOOL log correctly
    - test_existing_spool_data_intact() - Original 65 columns unmodified

    Run the smoke test suite:
    ```bash
    pytest tests/v3.0/ -v --tb=short
    ```

    Verify all tests pass and execute in < 10 seconds
  </action>
  <verify>[ -f tests/v3.0/test_backward_compatibility.py ] && pytest tests/v3.0/test_backward_compatibility.py -v --tb=short || echo "Compatibility tests ready"</verify>
  <done>Backward compatibility verified, v2.1 mode works, v3.0 mode accesses both column sets</done>
</task>

</tasks>

<verification>
Run archive script and verify tests/v2.1-archive/ created.
Execute v3.0 smoke tests and confirm all pass.
Check test isolation and speed (< 10 seconds).
</verification>

<success_criteria>
1. v2.1 tests archived without modification
2. 5+ v3.0 smoke tests verify migration
3. New columns testable
4. Backward compatibility verified
5. Tests run quickly for rapid iteration
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration-foundation/01-03-SUMMARY.md`
</output>