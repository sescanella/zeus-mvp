# Plan 01-01: Backup and Schema Expansion Scripts

---
phase: 01-migration-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/scripts/backup_sheet.py (new)
  - backend/scripts/add_v3_columns.py (new)
  - backend/scripts/__init__.py (new)
  - backend/config.py (update)
  - backend/requirements.txt (update)
autonomous: true

must_haves:
  truths:
    - "Production Google Sheet has complete backup copy with timestamp"
    - "Three new columns (Ocupado_Por, Fecha_Ocupacion, version) exist at end of sheet"
    - "All existing v2.1 data remains unmodified and accessible"
  artifacts:
    - path: "backend/scripts/backup_sheet.py"
      provides: "Google Sheet backup creation"
      min_lines: 50
    - path: "backend/scripts/add_v3_columns.py"
      provides: "Column addition with idempotency"
      min_lines: 80
    - path: "backend/config.py"
      provides: "V3 column configuration"
      contains: "V3_COLUMNS"
  key_links:
    - from: "backend/scripts/add_v3_columns.py"
      to: "SheetsRepository"
      via: "import and usage"
      pattern: "from.*repositories.*import.*SheetsRepository"
    - from: "backend/scripts/backup_sheet.py"
      to: "gspread"
      via: "Google Sheets API usage"
      pattern: "import gspread"
---

<objective>
Create automated scripts to safely backup production Google Sheet and add three new columns for v3.0 occupation tracking. Scripts must be idempotent and include rollback capability.

Purpose: Enable safe schema expansion without risking production data loss
Output: Backup script and column addition script with error recovery
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-migration-foundation/01-CONTEXT.md
@backend/repositories/sheets_repository.py
@backend/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backup and column scripts directory</name>
  <files>backend/scripts/__init__.py, backend/scripts/backup_sheet.py, backend/scripts/add_v3_columns.py</files>
  <action>
    Create backend/scripts/ directory with __init__.py for migration utilities.

    Implement backup_sheet.py that:
    - Uses gspread to create full copy of production spreadsheet
    - Names backup with format: ZEUES_v2.1_backup_YYYYMMDD_HHMMSS
    - Stores backup in Google Drive folder from config.BACKUP_FOLDER_ID
    - Returns backup spreadsheet ID for rollback reference
    - Includes error handling for API failures and permission issues
    - Adds retry logic with exponential backoff for rate limits
  </action>
  <verify>[ -f backend/scripts/backup_sheet.py ] && python backend/scripts/backup_sheet.py --dry-run || echo "Script created"</verify>
  <done>Script exists and dry-run completes without errors, showing backup would be created</done>
</task>

<task type="auto">
  <name>Task 2: Implement column addition with idempotency</name>
  <files>backend/scripts/add_v3_columns.py, backend/config.py</files>
  <action>
    Implement add_v3_columns.py that:
    - Connects to production sheet using existing SheetsRepository
    - Checks if v3.0 columns already exist (idempotency check)
    - If not present, adds three new columns at end (after column 65):
      * Ocupado_Por (string, initially empty)
      * Fecha_Ocupacion (date string, initially empty)
      * version (integer, initially 0)
    - Uses batch_update for efficient API usage
    - Includes dry-run mode for testing
    - Validates backup exists before proceeding
    - Logs all operations with timestamps

    Update backend/config.py to add:
    - BACKUP_FOLDER_ID environment variable
    - MIGRATION_DRY_RUN flag (default False)
    - V3_COLUMNS constant with new column names and types
  </action>
  <verify>[ -f backend/scripts/add_v3_columns.py ] && python backend/scripts/add_v3_columns.py --dry-run || grep "V3_COLUMNS" backend/config.py</verify>
  <done>Script detects current 65 columns, would add 3 new columns at positions 66-68, config has V3_COLUMNS defined</done>
</task>

<task type="auto">
  <name>Task 3: Test scripts with error recovery</name>
  <files>backend/requirements.txt</files>
  <action>
    Add required dependencies to requirements.txt if missing:
    - gspread>=5.10.0 (for Drive API support)
    - google-auth>=2.22.0

    Test both scripts against test sheet copy:
    1. Run backup_sheet.py and verify backup appears in Drive
    2. Run add_v3_columns.py and verify columns added
    3. Run add_v3_columns.py again to test idempotency
    4. Simulate API rate limit to verify retry behavior
  </action>
  <verify>pip freeze | grep gspread && ([ -f backend/scripts/add_v3_columns.py ] && python backend/scripts/add_v3_columns.py --help || echo "Ready to test")</verify>
  <done>Dependencies installed, both scripts have --help and --dry-run options, idempotency verified</done>
</task>

</tasks>

<verification>
Run backup_sheet.py against test sheet and verify backup appears with correct naming.
Run add_v3_columns.py in dry-run mode and verify column detection.
Execute add_v3_columns.py twice to confirm idempotency.
Check all existing v2.1 data remains accessible.
</verification>

<success_criteria>
1. Backup script creates complete spreadsheet copy
2. Column addition script adds exactly 3 columns at end
3. Scripts are idempotent - safe to run multiple times
4. Clear rollback path exists via backup
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration-foundation/01-01-SUMMARY.md`
</output>