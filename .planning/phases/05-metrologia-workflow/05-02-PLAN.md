---
phase: 05-metrologia-workflow
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - backend/routers/metrologia.py
  - backend/models/metrologia.py
  - backend/main.py
  - backend/services/estado_detalle_builder.py
autonomous: true

must_haves:
  truths:
    - "POST /api/metrologia/completar accepts tag_spool, worker_id, and resultado"
    - "Endpoint returns 200 on success, 400/409 on validation failure"
    - "Estado_Detalle displays inspection result clearly"
  artifacts:
    - path: "backend/routers/metrologia.py"
      provides: "REST endpoint for instant completion"
      exports: ["POST /api/metrologia/completar"]
    - path: "backend/models/metrologia.py"
      provides: "Pydantic models for request/response"
      exports: ["CompletarMetrologiaRequest", "ResultadoEnum"]
    - path: "backend/services/estado_detalle_builder.py"
      provides: "Extended builder for METROLOGIA states"
      contains: "METROLOGIA APROBADO|RECHAZADO"
  key_links:
    - from: "backend/routers/metrologia.py"
      to: "MetrologiaService"
      via: "dependency injection"
      pattern: "metrologia_service.*completar"
    - from: "backend/services/estado_detalle_builder.py"
      to: "metrologia_state"
      via: "state formatting logic"
      pattern: "APROBADO.*Listo|RECHAZADO.*Pendiente"
---

<objective>
Create REST endpoint for metrología instant completion with Estado_Detalle display integration.

Purpose: Expose binary inspection workflow via API with clear result communication
Output: POST endpoint, request/response models, and human-readable estado display
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-metrologia-workflow/05-CONTEXT.md
@.planning/phases/05-metrologia-workflow/05-RESEARCH.md
@.planning/phases/05-metrologia-workflow/05-01-SUMMARY.md

# Reference existing patterns
@backend/routers/actions.py
@backend/services/estado_detalle_builder.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pydantic models for metrología requests</name>
  <files>backend/models/metrologia.py</files>
  <action>
    Create request/response models for metrología endpoint:

    1. ResultadoEnum (str, Enum):
       - APROBADO = "APROBADO"
       - RECHAZADO = "RECHAZADO"

    2. CompletarMetrologiaRequest (BaseModel):
       - tag_spool: str
       - worker_id: int
       - resultado: ResultadoEnum

    3. CompletarMetrologiaResponse (BaseModel):
       - success: bool
       - tag_spool: str
       - resultado: str
       - estado_detalle: str
       - message: str

    Use Pydantic's strict validation to ensure resultado is exactly APROBADO or RECHAZADO.
    This prevents invalid values at API boundary.
  </action>
  <verify>python -c "from backend.models.metrologia import CompletarMetrologiaRequest, ResultadoEnum; print('Models imported successfully')"</verify>
  <done>Pydantic models created with ResultadoEnum enforcing binary values</done>
</task>

<task type="auto">
  <name>Task 2: Implement POST /api/metrologia/completar endpoint</name>
  <files>backend/routers/metrologia.py, backend/main.py</files>
  <action>
    Create metrología router with instant completion endpoint:

    1. In metrologia.py:
       ```python
       @router.post("/completar")
       async def completar_metrologia(
           request: CompletarMetrologiaRequest,
           metrologia_service: MetrologiaService = Depends()
       ):
       ```
       - Call metrologia_service.completar() with validated params
       - Handle exceptions: SpoolNotFoundError (404), ValidationError (400), SpoolOccupiedError (409)
       - Return CompletarMetrologiaResponse with success status

    2. In main.py:
       - Import and include metrologia_router with prefix="/api/metrologia"

    Key: Returns 409 for occupied spools (race condition detected), matching Phase 2 pattern.
  </action>
  <verify>python -c "from backend.routers.metrologia import router; print('Endpoint defined')"</verify>
  <done>POST /api/metrologia/completar endpoint created with proper error handling</done>
</task>

<task type="auto">
  <name>Task 3: Extend EstadoDetalleBuilder for metrología states</name>
  <files>backend/services/estado_detalle_builder.py</files>
  <action>
    Modify EstadoDetalleBuilder to handle METROLOGIA states:

    1. Add build_with_metrologia() method or extend existing build():
       - Check if metrologia_state provided (PENDIENTE/APROBADO/RECHAZADO)
       - Format display strings:
         * APROBADO: "METROLOGIA APROBADO ✓ - Listo para siguiente fase"
         * RECHAZADO: "METROLOGIA RECHAZADO - Pendiente reparación"
         * PENDIENTE: Show only if ARM+SOLD complete: "Metrología pendiente"

    2. Update logic to append metrología status after ARM/SOLD status:
       - Example: "Disponible - ARM completado, SOLD completado, METROLOGIA APROBADO ✓"

    This provides clear next-action guidance (especially for RECHAZADO → reparación).
  </action>
  <verify>python -c "from backend.services.estado_detalle_builder import EstadoDetalleBuilder; builder = EstadoDetalleBuilder(); print('Builder extended for METROLOGIA')"</verify>
  <done>EstadoDetalleBuilder displays APROBADO/RECHAZADO with clear next steps</done>
</task>

</tasks>

<verification>
Test endpoint with various scenarios:
- Valid APROBADO request → 200 response
- Valid RECHAZADO request → 200 response
- Missing prerequisites → 400 error
- Occupied spool → 409 conflict
- Invalid resultado value → 422 validation error
</verification>

<success_criteria>
- [ ] POST /api/metrologia/completar endpoint accepts binary resultado
- [ ] Proper HTTP status codes: 200 success, 400 validation, 409 conflict
- [ ] Estado_Detalle shows "METROLOGIA APROBADO" or "METROLOGIA RECHAZADO - Pendiente reparación"
- [ ] Request validation enforces APROBADO/RECHAZADO enum
- [ ] Endpoint integrated in main.py router
</success_criteria>

<output>
After completion, create `.planning/phases/05-metrologia-workflow/05-02-SUMMARY.md`
</output>