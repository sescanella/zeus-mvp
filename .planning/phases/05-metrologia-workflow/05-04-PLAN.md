---
phase: 05-metrologia-workflow
plan: 04
type: execute
wave: 4
depends_on: [05-03]
files_modified:
  - backend/services/redis_event_service.py
  - backend/services/metrologia_service.py
  - tests/integration/test_metrologia_flow.py
  - tests/unit/test_metrologia_validation.py
autonomous: true

must_haves:
  truths:
    - "Dashboard updates in real-time when metrología completes"
    - "Integration tests verify full inspection workflow"
    - "Empty state shows helpful message when no spools ready"
  artifacts:
    - path: "tests/integration/test_metrologia_flow.py"
      provides: "End-to-end validation of inspection flow"
      min_lines: 100
    - path: "tests/unit/test_metrologia_validation.py"
      provides: "Unit tests for prerequisite validation"
      min_lines: 80
  key_links:
    - from: "backend/services/metrologia_service.py"
      to: "redis_event_service"
      via: "event publishing after completion"
      pattern: "publish_event.*COMPLETAR_METROLOGIA"
---

<objective>
Integrate SSE events and create comprehensive test suite for metrología workflow.

Purpose: Ensure real-time visibility and validate all inspection scenarios
Output: Event publishing, integration tests, empty state handling
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-metrologia-workflow/05-CONTEXT.md
@.planning/phases/05-metrologia-workflow/05-RESEARCH.md
@.planning/phases/05-metrologia-workflow/05-01-SUMMARY.md
@.planning/phases/05-metrologia-workflow/05-02-SUMMARY.md
@.planning/phases/05-metrologia-workflow/05-03-SUMMARY.md

# Reference Phase 4 SSE patterns
@backend/services/redis_event_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSE event publishing for metrología completion</name>
  <files>backend/services/metrologia_service.py, backend/services/redis_event_service.py</files>
  <action>
    Integrate real-time event publishing into metrología flow:

    1. In redis_event_service.py, add COMPLETAR_METROLOGIA event type constant

    2. In metrologia_service.py completar() method:
       - After successful state transition and column updates
       - Call redis_event_service.publish_event() with:
         * event_type: "COMPLETAR_METROLOGIA"
         * tag_spool: from request
         * worker_id: from request
         * estado_detalle: updated estado string
         * metadata: {"resultado": "APROBADO" or "RECHAZADO"}

    3. Use best-effort pattern from Phase 4:
       - Try/except around publish_event
       - Log warning on failure but don't block operation
       - Return success even if SSE fails

    This ensures dashboard updates show inspected spools disappearing from ready list.
  </action>
  <verify>grep -r "COMPLETAR_METROLOGIA" backend/services/</verify>
  <done>SSE events published on metrología completion for real-time updates</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for full metrología flow</name>
  <files>tests/integration/test_metrologia_flow.py</files>
  <action>
    Write comprehensive integration tests covering:

    1. Happy path APROBADO:
       - Create spool with ARM + SOLD complete
       - Call POST /api/metrologia/completar with APROBADO
       - Verify Fecha_QC_Metrologia updated
       - Verify Estado_Detalle shows "METROLOGIA APROBADO"
       - Verify metadata event logged

    2. Happy path RECHAZADO:
       - Similar setup
       - Submit with RECHAZADO
       - Verify Estado_Detalle shows "Pendiente reparación"

    3. Validation failures:
       - ARM not complete → 400 error
       - SOLD not complete → 400 error
       - Already inspected → 400 error
       - Spool occupied → 409 conflict

    4. Empty state:
       - GET /api/spools/iniciar?operacion=METROLOGIA with no ready spools
       - Verify empty array returned

    Use pytest fixtures for test data setup.
  </action>
  <verify>python -m pytest tests/integration/test_metrologia_flow.py -v</verify>
  <done>Integration tests cover all metrología scenarios including edge cases</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for validation logic</name>
  <files>tests/unit/test_metrologia_validation.py</files>
  <action>
    Write unit tests for validar_puede_completar_metrologia():

    1. Test prerequisite validation:
       - fecha_armado None → raises DependenciasNoSatisfechasError
       - fecha_soldadura None → raises DependenciasNoSatisfechasError
       - fecha_qc_metrologia not None → raises OperacionYaCompletadaError
       - ocupado_por not None → raises SpoolOccupiedError

    2. Test role validation:
       - Worker without METROLOGIA role → raises RolNoAutorizadoError
       - Worker with METROLOGIA role → passes

    3. Test state machine transitions:
       - PENDIENTE can transition to APROBADO
       - PENDIENTE can transition to RECHAZADO
       - APROBADO cannot transition (terminal)
       - RECHAZADO cannot transition (terminal)

    Use mocks for dependencies to keep tests fast and isolated.
  </action>
  <verify>python -m pytest tests/unit/test_metrologia_validation.py::test_prerequisites -v</verify>
  <done>Unit tests validate all prerequisite checks and state transitions</done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
python -m pytest tests/unit/test_metrologia_* tests/integration/test_metrologia_* -v
```
All tests should pass with proper coverage of validation logic.
</verification>

<success_criteria>
- [ ] COMPLETAR_METROLOGIA events published to spools:updates channel
- [ ] Dashboard receives real-time updates when inspection completes
- [ ] Integration tests cover APROBADO, RECHAZADO, and error scenarios
- [ ] Unit tests validate all 4 prerequisites and role check
- [ ] Empty state handled gracefully with helpful message
</success_criteria>

<output>
After completion, create `.planning/phases/05-metrologia-workflow/05-04-SUMMARY.md`
</output>