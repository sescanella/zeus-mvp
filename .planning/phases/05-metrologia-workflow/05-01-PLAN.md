---
phase: 05-metrologia-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/domain/state_machines/metrologia_machine.py
  - backend/services/metrologia_service.py
  - backend/services/validation_service.py
  - backend/repositories/sheets_repository.py
autonomous: true

must_haves:
  truths:
    - "Metrólogo can see and select spools ready for inspection (ARM + SOLD complete, not occupied)"
    - "System validates prerequisites before allowing inspection"
    - "State machine transitions PENDIENTE → APROBADO or RECHAZADO based on resultado"
  artifacts:
    - path: "backend/domain/state_machines/metrologia_machine.py"
      provides: "3-state machine for binary inspection results"
      min_lines: 50
    - path: "backend/services/metrologia_service.py"
      provides: "Orchestration of instant completion flow"
      exports: ["MetrologiaService", "completar"]
    - path: "backend/services/validation_service.py"
      provides: "Prerequisite validation for metrología"
      exports: ["validar_puede_completar_metrologia"]
  key_links:
    - from: "backend/services/metrologia_service.py"
      to: "metrologia_machine"
      via: "instantiation and transition triggers"
      pattern: "MetrologiaStateMachine.*aprobar|rechazar"
    - from: "backend/services/metrologia_service.py"
      to: "validation_service"
      via: "prerequisite validation call"
      pattern: "validar_puede_completar_metrologia"
---

<objective>
Implement metrología state machine and service layer for instant binary inspection workflow.

Purpose: Enable quality inspection with APROBADO/RECHAZADO outcomes without occupation periods
Output: 3-state machine, MetrologiaService, validation methods, and prerequisite filters
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-metrologia-workflow/05-CONTEXT.md
@.planning/phases/05-metrologia-workflow/05-RESEARCH.md

# Reference Phase 3 state machine patterns
@backend/domain/state_machines/arm_machine.py
@backend/domain/state_machines/sold_machine.py
@backend/services/state_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create METROLOGIA state machine with 3 states</name>
  <files>backend/domain/state_machines/metrologia_machine.py</files>
  <action>
    Create simplified 3-state machine for metrología inspection:
    - States: PENDIENTE (initial), APROBADO (final), RECHAZADO (final)
    - Transitions: aprobar (PENDIENTE→APROBADO), rechazar (PENDIENTE→RECHAZADO)
    - No occupation states (no en_progreso equivalent)
    - One-way transitions only (terminals cannot transition back)

    Use python-statemachine==2.5.0 (already installed from Phase 3).
    Follow Phase 3 patterns but simpler - no TOMAR/PAUSAR/COMPLETAR split.

    Important: Both APROBADO and RECHAZADO must be marked as final=True to prevent re-inspection without reparación (Phase 6 domain).
  </action>
  <verify>python -m pytest tests/unit/test_metrologia_machine.py -v</verify>
  <done>MetrologiaStateMachine class exists with 3 states, 2 transitions, both terminals marked final</done>
</task>

<task type="auto">
  <name>Task 2: Implement MetrologiaService for instant completion</name>
  <files>backend/services/metrologia_service.py, backend/services/validation_service.py</files>
  <action>
    Create MetrologiaService that orchestrates the instant completion flow:

    1. In validation_service.py, add validar_puede_completar_metrologia() method:
       - Check fecha_armado != None (ARM complete)
       - Check fecha_soldadura != None (SOLD complete)
       - Check fecha_qc_metrologia == None (not already inspected)
       - Check ocupado_por == None (not occupied - prevents race conditions)
       - Verify worker has METROLOGIA role

    2. In metrologia_service.py, implement completar() method:
       - Accept tag_spool, worker_id, resultado (APROBADO/RECHAZADO)
       - Call validation_service.validar_puede_completar_metrologia()
       - Instantiate MetrologiaStateMachine
       - Trigger aprobar() or rechazar() based on resultado
       - Update Fecha_QC_Metrologia column via Sheets repository
       - Log metadata event with resultado in metadata_json
       - NO Redis locking needed (no TOMAR phase)

    Key difference from OccupationService: Skip occupation entirely, single atomic completion.
  </action>
  <verify>python -m pytest tests/unit/test_metrologia_service.py -v</verify>
  <done>MetrologiaService.completar() validates prerequisites, triggers state transitions, updates columns</done>
</task>

<task type="auto">
  <name>Task 3: Add metrología filtering to Sheets repository</name>
  <files>backend/repositories/sheets_repository.py</files>
  <action>
    Extend SheetsRepository with get_spools_for_metrologia() method:

    Filter criteria (ALL must be true):
    - fecha_armado != None (ARM completed)
    - fecha_soldadura != None (SOLD completed)
    - fecha_qc_metrologia == None (METROLOGIA not done)
    - ocupado_por == None (not occupied - critical for race prevention)

    Return filtered list of Spool objects ready for inspection.
    This will be used by GET /api/spools/iniciar?operacion=METROLOGIA endpoint.

    Empty result is valid (no spools ready) - frontend will show hint message.
  </action>
  <verify>python -c "from backend.repositories.sheets_repository import SheetsRepository; print('Filter method exists')"</verify>
  <done>SheetsRepository.get_spools_for_metrologia() filters by ARM+SOLD complete, not occupied, not inspected</done>
</task>

</tasks>

<verification>
Run unit tests to verify:
- MetrologiaStateMachine has exactly 3 states with correct transitions
- Both APROBADO and RECHAZADO are terminal (final=True)
- validar_puede_completar_metrologia() enforces all 4 prerequisites
- MetrologiaService.completar() handles both APROBADO and RECHAZADO paths
- Occupied spools are excluded from metrología filter
</verification>

<success_criteria>
- [ ] 3-state machine created with PENDIENTE → APROBADO/RECHAZADO transitions
- [ ] Prerequisites validated: ARM complete, SOLD complete, not occupied, not inspected
- [ ] Instant completion without TOMAR occupation phase
- [ ] Fecha_QC_Metrologia column updated on completion
- [ ] Metadata logged with resultado in metadata_json
</success_criteria>

<output>
After completion, create `.planning/phases/05-metrologia-workflow/05-01-SUMMARY.md`
</output>