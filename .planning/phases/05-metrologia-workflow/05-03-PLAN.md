---
phase: 05-metrologia-workflow
plan: 03
type: execute
wave: 3
depends_on: [05-02]
files_modified:
  - zeues-frontend/app/operacion/page.tsx
  - zeues-frontend/app/seleccionar-spool/page.tsx
  - zeues-frontend/app/resultado-metrologia/page.tsx
  - zeues-frontend/lib/api.ts
  - zeues-frontend/lib/context.tsx
autonomous: true

must_haves:
  truths:
    - "Worker selects METROLOGIA operation and goes directly to spool selection"
    - "After selecting spool, worker sees APROBADO/RECHAZADO buttons"
    - "Submission completes inspection and navigates to success page"
  artifacts:
    - path: "zeues-frontend/app/operacion/page.tsx"
      provides: "METROLOGIA option that skips tipo-interaccion"
      contains: "METROLOGIA.*seleccionar-spool"
    - path: "zeues-frontend/app/seleccionar-spool/page.tsx"
      provides: "Routing logic for METROLOGIA to resultado page"
      contains: "METROLOGIA.*resultado-metrologia"
    - path: "zeues-frontend/app/resultado-metrologia/page.tsx"
      provides: "Binary resultado selection page"
      min_lines: 80
    - path: "zeues-frontend/lib/api.ts"
      provides: "completarMetrologia function"
      exports: ["completarMetrologia"]
  key_links:
    - from: "zeues-frontend/app/operacion/page.tsx"
      to: "/seleccionar-spool"
      via: "router navigation"
      pattern: "METROLOGIA.*push.*seleccionar-spool"
    - from: "zeues-frontend/app/seleccionar-spool/page.tsx"
      to: "/resultado-metrologia"
      via: "conditional navigation"
      pattern: "operacion.*METROLOGIA.*resultado-metrologia"
    - from: "zeues-frontend/app/resultado-metrologia/page.tsx"
      to: "completarMetrologia"
      via: "API call on button click"
      pattern: "completarMetrologia.*resultado"
---

<objective>
Implement frontend flow for metrología inspection with binary resultado selection.

Purpose: Enable mobile-first UI for instant inspection approval/rejection
Output: Modified operation selection, new resultado page, API integration
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-metrologia-workflow/05-CONTEXT.md
@.planning/phases/05-metrologia-workflow/05-RESEARCH.md
@.planning/phases/05-metrologia-workflow/05-01-SUMMARY.md
@.planning/phases/05-metrologia-workflow/05-02-SUMMARY.md

# Reference existing frontend patterns
@zeues-frontend/app/operacion/page.tsx
@zeues-frontend/app/seleccionar-spool/page.tsx
@zeues-frontend/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify operation selection to skip tipo-interaccion for METROLOGIA</name>
  <files>zeues-frontend/app/operacion/page.tsx, zeues-frontend/app/seleccionar-spool/page.tsx</files>
  <action>
    Update operation selection page and spool selection page to handle METROLOGIA flow:

    1. In operacion/page.tsx:
       - Add METROLOGIA as third operation option (alongside ARM and SOLD)
       - In handleSelectOperation function:
         * If operation === 'METROLOGIA', navigate directly to '/seleccionar-spool'
         * ARM/SOLD continue to '/tipo-interaccion' as before
       - Visual: Add METROLOGIA button with appropriate icon/color
         * Use same h-20 height for mobile-first design
         * Consider purple or blue color to differentiate from ARM/SOLD

    2. In seleccionar-spool/page.tsx:
       - After spool selection, check the current operation from context
       - If operacion === 'METROLOGIA':
         * Navigate to '/resultado-metrologia' instead of '/confirmar'
       - Otherwise continue with existing flow to '/confirmar'
       - This ensures the METROLOGIA flow goes to the binary selection page

    This skips the INICIAR/COMPLETAR choice entirely for instant inspection and properly routes to resultado page.
  </action>
  <verify>npm run build && echo "TypeScript compilation successful"</verify>
  <done>METROLOGIA operation bypasses tipo-interaccion and routes to resultado page after spool selection</done>
</task>

<task type="auto">
  <name>Task 2: Create resultado selection page</name>
  <files>zeues-frontend/app/resultado-metrologia/page.tsx</files>
  <action>
    Create new page for binary APROBADO/RECHAZADO selection:

    1. Display selected spool info at top (TAG_SPOOL)
    2. Show two large buttons:
       - APROBADO button (green, h-32 for mobile)
       - RECHAZADO button (red, h-32 for mobile)

    3. On button click:
       - Call completarMetrologia API with resultado
       - Show loading state during API call
       - On success: navigate to /exito
       - On error: show error message (especially for 409 occupied conflict)

    4. Include "Cancelar" button to return to operation selection

    No confirmation screen - submit immediately on button press per user decision.
  </action>
  <verify>test -f zeues-frontend/app/resultado-metrologia/page.tsx && echo "Resultado page created"</verify>
  <done>Binary resultado selection page with APROBADO/RECHAZADO buttons</done>
</task>

<task type="auto">
  <name>Task 3: Add completarMetrologia API function</name>
  <files>zeues-frontend/lib/api.ts, zeues-frontend/lib/context.tsx</files>
  <action>
    Implement API integration for metrología completion:

    1. In api.ts, add completarMetrologia function:
       ```typescript
       export async function completarMetrologia(
         tagSpool: string,
         workerId: number,
         resultado: 'APROBADO' | 'RECHAZADO'
       ): Promise<Response>
       ```
       - POST to /api/metrologia/completar
       - Include all three parameters in body
       - Handle 409 specifically (show "Spool ocupado por otro trabajador")

    2. In context.tsx, add resultado to context state if needed

    Use native fetch (no axios) per project pattern.
  </action>
  <verify>npm run lint && echo "ESLint passes with no errors"</verify>
  <done>completarMetrologia API function integrated with proper error handling</done>
</task>

</tasks>

<verification>
Test the full flow:
1. Select METROLOGIA operation → goes to spool selection (skips tipo-interaccion)
2. Select a spool → goes to resultado page
3. Click APROBADO → success page
4. Try with occupied spool → 409 error message
</verification>

<success_criteria>
- [ ] METROLOGIA operation skips tipo-interaccion page entirely
- [ ] Spool selection page routes to resultado-metrologia for METROLOGIA flow
- [ ] Resultado page shows large APROBADO/RECHAZADO buttons
- [ ] API call submits resultado and handles responses
- [ ] 409 conflict shows friendly Spanish error message
- [ ] Success navigates to /exito page
</success_criteria>

<output>
After completion, create `.planning/phases/05-metrologia-workflow/05-03-SUMMARY.md`
</output>