# Plan: Integration Tests and Performance Validation

---
wave: 3
depends_on: ["10-01", "10-02", "10-03", "10-04"]
files_modified:
  - tests/integration/services/test_union_service_integration.py
  - tests/integration/services/test_occupation_v4_integration.py
  - tests/performance/test_batch_performance.py
  - backend/services/union_service.py
autonomous: true
---

## Goal

Create comprehensive integration tests that validate the full service orchestration flow with real repository interactions. Verify performance meets the <1 second requirement for 10-union batch operations and ensure all service components work together correctly.

## Tasks

<task id="1">
Create integration test for complete INICIAR->FINALIZAR flow:
- Test worker initiates ARM operation (INICIAR)
- Select 7 of 10 unions and FINALIZAR (should PAUSAR)
- Different worker completes remaining 3 unions (should COMPLETAR)
- Verify state transitions and metadata events
- Use real UnionRepository and MetadataRepository (mocked Sheets)
</task>

<task id="2">
Test ARM-to-SOLD workflow with validation:
- Complete some ARM unions
- Attempt INICIAR SOLD without ARM (should fail)
- Complete at least 1 ARM union
- INICIAR SOLD successfully
- Select SOLD unions and verify filtering
- Test mixed union types (FW excluded from SOLD)
</task>

<task id="3">
Test metrología auto-transition scenarios:
- Create spool with mixed union types (FW + BW/BR)
- Complete all FW unions via ARM
- Complete all SOLD-required unions
- Verify metrología triggers automatically
- Check Estado_Detalle updates correctly
- Validate METROLOGIA_AUTO_TRIGGERED event
</task>

<task id="4">
Test zero-union cancellation flow:
- INICIAR a spool
- FINALIZAR with empty selected_unions list
- Verify Redis lock released
- Check Ocupado_Por cleared
- Validate SPOOL_CANCELADO event logged
- Ensure spool returns to disponible state
</task>

<task id="5">
Create performance test for batch operations:
- Setup test with 10, 20, and 50 unions
- Measure batch_update execution time
- Verify <1s for 10-union operation (p95)
- Check <2s for larger batches (p99)
- Test concurrent FINALIZAR operations
- Monitor memory usage during batch operations
</task>

<task id="6">
Test error handling and race conditions:
- Simulate union becoming unavailable during selection
- Test version conflict with retry logic
- Verify partial batch success handling
- Test Redis connection failures with fallback
- Validate proper error messages and codes
- Check audit trail for failed operations
</task>

## Verification

Run integration and performance tests:
- All integration tests pass with real repositories
- 10-union batch completes in <1 second (p95)
- Race conditions handled gracefully with 409 errors
- Metrología triggers correctly for mixed spools
- Zero-union cancellation works end-to-end

## must_haves
- Complete INICIAR->FINALIZAR integration test
- ARM-before-SOLD validation test
- Metrología auto-transition test with mixed unions
- Zero-union cancellation test
- Performance test achieving <1s for 10 unions
- Race condition and error handling tests