# Plan: Add ARM-before-SOLD Validation

---
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - backend/services/validation_service.py
  - backend/services/occupation_service.py
  - backend/exceptions.py
  - tests/unit/services/test_validation_service_v4.py
autonomous: true
---

## Goal

Implement ARM-before-SOLD validation that enforces the business rule: SOLD operations require at least one union with ARM_FECHA_FIN != NULL. This validation occurs at INICIAR time to fail early and provide clear feedback.

## Tasks

<task id="1">
Add new exception to backend/exceptions.py:
- ArmPrerequisiteError: Custom exception for ARM-before-SOLD violations
- Include fields: tag_spool, unions_sin_armar count, message
- Clear error message: "Cannot start SOLD: No ARM unions completed for this spool"
</task>

<task id="2">
Enhance ValidationService with ARM prerequisite check:
- Add validate_arm_prerequisite() method
- Query unions via UnionRepository.get_by_ot()
- Check if ANY union has ARM_FECHA_FIN != NULL
- Raise ArmPrerequisiteError if no ARM unions found
- Return validation result with unions_armadas count
</task>

<task id="3">
Integrate validation into OccupationService.iniciar_spool():
- Add validation check when operacion == "SOLD"
- Call ValidationService.validate_arm_prerequisite()
- Return 403 Forbidden with clear error message on failure
- Log validation attempt to Metadata (optional event)
- Continue with lock acquisition if validation passes
</task>

<task id="4">
Update UnionRepository query filtering for SOLD:
- Modify get_disponibles_sold_by_ot() if needed
- Ensure it only returns unions where ARM_FECHA_FIN IS NOT NULL
- Filter out unions that haven't been ARM'd yet
- This prevents frontend from showing unavailable unions
</task>

<task id="5">
Add SOLD completion logic considering union types:
- Update determine_action() in OccupationService
- For SOLD: count only SOLD_REQUIRED_TYPES unions
- Total = count of BW/BR/SO/FILL/LET unions (not FW)
- COMPLETAR when selected SOLD unions == total SOLD-required
- Handle mixed union type spools correctly
</task>

<task id="6">
Write comprehensive unit tests for ARM validation:
- Test validate_arm_prerequisite with no ARM unions (should fail)
- Test with at least 1 ARM union (should pass)
- Test INICIAR SOLD with validation failure (403 response)
- Test SOLD disponibles filtering (only ARM'd unions)
- Test SOLD completion with mixed union types
- Mock UnionRepository responses for various scenarios
</task>

## Verification

Run unit tests and verify:
- INICIAR SOLD fails with 403 if no ARM unions completed
- Error message clearly states ARM prerequisite requirement
- SOLD disponibles only shows ARM-completed unions
- SOLD COMPLETAR logic counts only SOLD-required types
- All validation tests pass with proper error handling

## must_haves
- ArmPrerequisiteError exception class
- validate_arm_prerequisite() in ValidationService
- Integration in iniciar_spool() for SOLD operations
- 403 Forbidden with clear error message
- SOLD disponibles filtered to ARM-completed unions
- SOLD completion counts only BW/BR/SO/FILL/LET types