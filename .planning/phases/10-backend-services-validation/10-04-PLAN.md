# Plan: Implement Metrología Auto-Transition

---
wave: 2
depends_on: ["10-02"]
files_modified:
  - backend/services/occupation_service.py
  - backend/services/state_service.py
  - backend/models/enums.py
  - tests/unit/services/test_metrologia_transition.py
autonomous: true
---

## Goal

Implement automatic transition to metrología queue when all work is complete. The system detects mixed completion (all FW unions ARM'd, all SOLD-required unions completed) and triggers the state machine transition synchronously during FINALIZAR.

## Tasks

<task id="1">
Add metrología trigger detection method to OccupationService:
- should_trigger_metrologia(): Check if all work complete
- Separate FW unions (ARM-only) from SOLD-required unions
- Check all FW have ARM_FECHA_FIN != NULL
- Check all BW/BR/SO/FILL/LET have SOL_FECHA_FIN != NULL
- Return boolean indicating if metrología should trigger
</task>

<task id="2">
Integrate metrología trigger into finalizar_spool():
- After COMPLETAR determination, check should_trigger_metrologia()
- If true, call StateService to trigger transition
- Pass spool data to state machine for transition
- Update Estado_Detalle to "En Cola Metrología"
- Log METROLOGIA_AUTO_TRIGGERED event to Metadata
</task>

<task id="3">
Update StateService to handle metrología transition:
- Add trigger_metrologia_transition() method
- Load current state from spool data
- Trigger appropriate state machine event
- Handle state machine rejection gracefully (log warning)
- Return new state after transition
</task>

<task id="4">
Add new event type to backend/models/enums.py:
- EventoTipo.METROLOGIA_AUTO_TRIGGERED
- Update MetadataRepository to support new event type
- Include trigger reason and completion stats in event
</task>

<task id="5">
Update API response to include metrología notification:
- Add metrologia_triggered boolean to OccupationResponse
- Add new_state field when transition occurs
- Frontend can show specific success message
- Include completion statistics in response
</task>

<task id="6">
Write comprehensive tests for metrología auto-transition:
- Test trigger with all FW unions ARM-completed
- Test trigger with all SOLD-required unions completed
- Test mixed spool (FW + BW/BR) completion detection
- Test no trigger when work incomplete
- Test state machine integration
- Mock StateService and state machine responses
</task>

## Verification

Run unit tests and verify:
- Metrología triggers when ALL work complete
- Mixed union types handled correctly (FW vs SOLD-required)
- State transitions to PENDIENTE_METROLOGIA
- METROLOGIA_AUTO_TRIGGERED event logged
- API response includes metrologia_triggered flag

## must_haves
- should_trigger_metrologia() detection logic
- Integration in finalizar_spool() after COMPLETAR
- Synchronous state machine transition
- METROLOGIA_AUTO_TRIGGERED event type
- Response includes metrologia_triggered boolean
- Support for mixed union type spools (FW + SOLD-required)