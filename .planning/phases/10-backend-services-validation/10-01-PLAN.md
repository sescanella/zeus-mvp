# Plan: Create UnionService for Batch Operations

---
wave: 1
depends_on: []
files_modified:
  - backend/services/union_service.py
  - backend/services/__init__.py
  - tests/unit/services/test_union_service.py
autonomous: true
---

## Goal

Create the UnionService class that orchestrates union selection workflows with batch updates, metrics calculation, and metadata event building. This service bridges the API layer and the UnionRepository (Phase 8), handling business logic for union-level operations.

## Tasks

<task id="1">
Create the UnionService class with dependency injection constructor that accepts UnionRepository, MetadataRepository, and SheetsRepository instances. Import necessary models and repositories.
</task>

<task id="2">
Implement process_selection() method that orchestrates batch union updates:
- Validate selected union IDs exist and are available
- Determine operation type (ARM or SOLD)
- Call appropriate batch_update method from UnionRepository
- Build and log metadata events
- Return processing summary with union count and action taken
</task>

<task id="3">
Implement calcular_pulgadas() method to sum DN_UNION values:
- Accept list of Union objects
- Sum DN_UNION values with 1 decimal precision
- Handle None values gracefully
- Return float with 1 decimal place
</task>

<task id="4">
Implement build_eventos_metadata() method for audit trail:
- Create batch event at spool level (N_UNION=None)
- Create granular events per union (N_UNION=union_number)
- Support UNION_ARM_REGISTRADA and UNION_SOLD_REGISTRADA event types
- Include pulgadas calculation in batch event
- Return list of MetadataEvent objects ready for batch logging
</task>

<task id="5">
Add helper methods for union validation and filtering:
- validate_union_ownership(): Check all unions belong to same OT
- filter_available_unions(): Filter based on operation type (ARM vs SOLD)
- get_sold_required_types(): Return constant list ['BW', 'BR', 'SO', 'FILL', 'LET']
- Handle FW union type (ARM-only, no SOLD needed)
</task>

<task id="6">
Write comprehensive unit tests for UnionService:
- Test process_selection with valid unions (mock batch_update success)
- Test calcular_pulgadas with various decimal values
- Test build_eventos_metadata generates correct event structure
- Test union validation and filtering logic
- Test error handling for invalid union IDs
- Mock all repository dependencies
</task>

## Verification

Run unit tests and verify:
- UnionService correctly orchestrates batch updates
- Pulgadas calculation uses 1 decimal precision
- Metadata events include both batch and granular entries
- SOLD_REQUIRED_TYPES constant excludes FW unions
- All tests pass with 100% coverage of new service

## must_haves
- UnionService class with dependency injection
- process_selection() orchestrates batch operations
- calcular_pulgadas() sums with 1 decimal precision
- build_eventos_metadata() creates batch + granular events
- SOLD_REQUIRED_TYPES constant = ['BW', 'BR', 'SO', 'FILL', 'LET']
- Comprehensive unit tests with mocked dependencies