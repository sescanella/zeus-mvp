# Plan: Enhance OccupationService with INICIAR/FINALIZAR

---
wave: 1
depends_on: []
files_modified:
  - backend/services/occupation_service.py
  - backend/models/occupation.py
  - tests/unit/services/test_occupation_service_v4.py
autonomous: true
---

## Goal

Enhance OccupationService with v4.0 INICIAR and FINALIZAR operations that support union-level workflows. INICIAR occupies the spool without touching Uniones sheet. FINALIZAR processes union selection with auto-determination of PAUSAR vs COMPLETAR.

## Tasks

<task id="1">
Add new request models to backend/models/occupation.py:
- IniciarRequest: tag_spool, worker_id, worker_nombre, operacion
- FinalizarRequest: tag_spool, worker_id, worker_nombre, operacion, selected_unions (list of union IDs)
- Update OccupationResponse to include action_taken field and unions_processed count
</task>

<task id="2">
Implement iniciar_spool() method in OccupationService:
- Validate spool exists and is available
- Acquire Redis lock using RedisLockService (persistent, no TTL)
- Update Ocupado_Por and Fecha_Ocupacion in Operaciones
- Log SPOOL_INICIADO event to Metadata
- Return success response with lock token
- DO NOT touch Uniones sheet at all
</task>

<task id="3">
Implement finalizar_spool() method with auto-determination:
- Validate worker owns the spool (check Redis lock)
- Get fresh union totals from UnionRepository
- Calculate if action is PAUSAR or COMPLETAR based on selected vs total
- For COMPLETAR: check if should trigger metrologia transition
- Release Redis lock and clear Ocupado_Por
- Return response with action_taken and unions_processed
</task>

<task id="4">
Add auto-determination logic helper method:
- determine_action(): Compare selected count vs total available
- Independent evaluation for ARM and SOLD operations
- ARM counts all unions, SOLD counts only SOLD_REQUIRED_TYPES
- Return "PAUSAR" or "COMPLETAR" based on comparison
- Fail with 409 Conflict if union became unavailable (race condition)
</task>

<task id="5">
Implement zero-union cancellation support:
- If selected_unions is empty list, handle as cancellation
- Release Redis lock via RedisLockService
- Clear Ocupado_Por and Fecha_Ocupacion
- Log SPOOL_CANCELADO event to Metadata
- Return response with action_taken="CANCELADO"
- DO NOT update version token or other fields
</task>

<task id="6">
Write comprehensive unit tests for v4.0 operations:
- Test iniciar_spool with valid spool (mock lock acquisition)
- Test finalizar_spool with PAUSAR outcome (partial selection)
- Test finalizar_spool with COMPLETAR outcome (full selection)
- Test zero-union cancellation flow
- Test race condition handling (union unavailable)
- Mock UnionService, RedisLockService, repositories
</task>

## Verification

Run unit tests and verify:
- INICIAR creates Redis lock without touching Uniones
- FINALIZAR correctly auto-determines PAUSAR vs COMPLETAR
- Zero-union selection triggers cancellation flow
- Race conditions return 409 Conflict
- All v4.0 endpoints integrate with existing services

## must_haves
- IniciarRequest and FinalizarRequest models
- iniciar_spool() occupies without touching Uniones
- finalizar_spool() with auto-determination logic
- Zero-union cancellation support
- Action_taken field in response ("PAUSAR"/"COMPLETAR"/"CANCELADO")
- Comprehensive unit tests for new workflows