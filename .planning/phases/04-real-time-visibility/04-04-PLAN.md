---
phase: 04-real-time-visibility
plan: 04
type: execute
wave: 4
depends_on: [04-02, 04-03]
files_modified:
  - zeues-frontend/app/dashboard/page.tsx
  - zeues-frontend/app/page.tsx
  - backend/tests/load/test_sse_load.py
  - backend/tests/load/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Dashboard shows all occupied spools with owner names"
    - "Dashboard updates in real-time via SSE"
    - "30 concurrent workers stay under API quota"
  artifacts:
    - path: "zeues-frontend/app/dashboard/page.tsx"
      provides: "Who has what dashboard"
      contains: "useSSE"
    - path: "backend/tests/load/test_sse_load.py"
      provides: "Load test for 30 concurrent users"
      min_lines: 100
    - path: "backend/tests/load/requirements.txt"
      provides: "Load test dependencies"
      contains: "locust"
  key_links:
    - from: "zeues-frontend/app/dashboard/page.tsx"
      to: "/api/dashboard/occupied"
      via: "REST fetch for initial load"
      pattern: "fetch.*dashboard/occupied"
    - from: "zeues-frontend/app/dashboard/page.tsx"
      to: "useSSE"
      via: "Real-time updates"
      pattern: "useSSE.*stream"
---

<objective>
Create "who has what" dashboard and verify system performance with load testing

Purpose: Deliver real-time visibility dashboard and ensure system meets performance requirements
Output: Dashboard page showing occupied spools, load test proving < 80 API requests/min
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-visibility/04-CONTEXT.md
@.planning/phases/04-real-time-visibility/04-RESEARCH.md
@.planning/phases/04-real-time-visibility/04-02-SUMMARY.md
@.planning/phases/04-real-time-visibility/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard page</name>
  <files>zeues-frontend/app/dashboard/page.tsx, zeues-frontend/app/page.tsx</files>
  <action>
    Implement "who has what" dashboard showing occupied spools.

    1. zeues-frontend/app/dashboard/page.tsx:
       - Initial load: fetch('/api/dashboard/occupied')
       - Display each occupied spool in a card:
         - TAG_SPOOL (prominent)
         - Worker name (e.g., "MR(93)" or full name)
         - Estado_Detalle (ARM/SOLD progress)
         - Time occupied (calculated from fecha_ocupacion)
       - Real-time updates via useSSE:
         - TOMAR: Add spool to list
         - PAUSAR: Remove spool from list
         - STATE_CHANGE: Update estado_detalle
       - Empty state: "No hay carretes ocupados actualmente"
       - ConnectionStatus in top-right
       - Simple list view, no colors (per CONTEXT.md)
       - Mobile-optimized with large text

    2. zeues-frontend/app/page.tsx:
       - Add link/button to navigate to dashboard

    Based on research pattern from 04-RESEARCH.md lines 759-868.
  </action>
  <verify>grep "No hay carretes ocupados" zeues-frontend/app/dashboard/page.tsx</verify>
  <done>Dashboard displays occupied spools with real-time updates</done>
</task>

<task type="auto">
  <name>Task 2: Create load test harness</name>
  <files>backend/tests/load/test_sse_load.py, backend/tests/load/requirements.txt</files>
  <action>
    Create load test to verify performance with 30 concurrent workers.

    1. backend/tests/load/requirements.txt:
       - locust==2.17.0
       - Add any other load test dependencies

    2. backend/tests/load/test_sse_load.py:
       - Use Locust framework for load testing
       - Simulate 30 concurrent workers:
         - Each opens SSE connection to /api/sse/stream
         - Each performs TOMAR/PAUSAR/COMPLETAR operations
         - 5 actions per minute per worker (150 total/min)
       - Measure:
         - SSE latency (time from publish to receive)
         - Google Sheets API calls (should stay < 80/min)
         - Connection stability over 8-hour simulation
         - Memory usage (no leaks from unclosed subscriptions)
       - Success criteria:
         - All SSE updates arrive within 10 seconds
         - API quota not exceeded
         - No connection drops over 8 hours

    Include instructions for running: locust -f test_sse_load.py --host=http://localhost:8000
  </action>
  <verify>grep "class WorkerUser" backend/tests/load/test_sse_load.py</verify>
  <done>Load test simulates 30 concurrent workers with SSE connections</done>
</task>

<task type="auto">
  <name>Task 3: Verify performance requirements</name>
  <files>backend/tests/load/test_sse_load.py</files>
  <action>
    Add verification logic to load test for success criteria.

    Add assertions/checks for Phase 4 requirements:
    1. SSE updates arrive within 10 seconds (measure publish â†’ receive latency)
    2. Dashboard shows all occupied spools (verify completeness)
    3. SSE connection stays alive for 8 hours (test reconnection logic)
    4. 30 workers generate < 80 Sheets API requests/min (monitor quota)

    Log results clearly:
    - Average SSE latency: X ms (must be < 10,000ms)
    - Max SSE latency: Y ms
    - Total API requests: Z per minute (must be < 80)
    - Connection uptime: N hours
    - Memory usage: stable/growing

    Create summary report showing PASS/FAIL for each criterion.
  </action>
  <verify>python backend/tests/load/test_sse_load.py --check-only</verify>
  <done>Load test verifies all Phase 4 success criteria</done>
</task>

</tasks>

<verification>
1. Dashboard displays all occupied spools with worker names
2. Real-time updates arrive within 10 seconds
3. SSE connections handle 8-hour shifts with auto-reconnect
4. 30 concurrent workers stay under Google Sheets API quota (80 req/min)
</verification>

<success_criteria>
- Dashboard shows "who has what" with live updates
- Load test passes all performance requirements
- No memory leaks or connection storms
- Mobile-friendly with connection status indicator
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-visibility/04-04-SUMMARY.md`
</output>