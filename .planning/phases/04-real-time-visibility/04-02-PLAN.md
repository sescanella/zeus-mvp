---
phase: 04-real-time-visibility
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - backend/services/occupation_service.py
  - backend/services/state_service.py
  - backend/routers/dashboard_router.py
  - backend/core/dependency.py
  - backend/main.py
autonomous: true

must_haves:
  truths:
    - "TOMAR/PAUSAR/COMPLETAR trigger Redis events"
    - "State machine transitions publish STATE_CHANGE events"
    - "Dashboard REST endpoint returns occupied spools"
  artifacts:
    - path: "backend/services/occupation_service.py"
      provides: "Event publishing in TOMAR/PAUSAR/COMPLETAR"
      contains: "redis_event_service.publish_spool_update"
    - path: "backend/services/state_service.py"
      provides: "Event publishing in state transitions"
      contains: "redis_event_service.publish_spool_update"
    - path: "backend/routers/dashboard_router.py"
      provides: "GET /api/dashboard/occupied endpoint"
      exports: ["router"]
  key_links:
    - from: "backend/services/occupation_service.py"
      to: "redis_event_service"
      via: "dependency injection"
      pattern: "self\\.redis_event_service"
    - from: "backend/services/state_service.py"
      to: "redis_event_service"
      via: "dependency injection"
      pattern: "self\\.redis_event_service"
---

<objective>
Integrate event publishing into existing services and create dashboard REST endpoint

Purpose: Trigger real-time events on all state changes and provide initial data for dashboard
Output: Services publish events to Redis, dashboard endpoint returns occupied spools
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-visibility/04-CONTEXT.md
@.planning/phases/04-real-time-visibility/04-RESEARCH.md
@.planning/phases/04-real-time-visibility/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event publishing to OccupationService</name>
  <files>backend/services/occupation_service.py, backend/core/dependency.py</files>
  <action>
    Integrate RedisEventService into OccupationService for TOMAR/PAUSAR/COMPLETAR events.

    1. Update OccupationService constructor to accept redis_event_service parameter
    2. In tomar_spool() method:
       - AFTER line with `await self.sheets_repository.update_spool()` (successful Sheets write)
       - BEFORE the return statement
       - Call: `await self.redis_event_service.publish_spool_update("TOMAR", tag_spool, worker_nombre, estado_detalle)`
       - This location is inside the tenacity retry logic, after successful metadata logging
    3. In pausar_spool() method:
       - AFTER releasing lock with `await self.redis_service.release_lock()`
       - BEFORE the return statement
       - Call: `await self.redis_event_service.publish_spool_update("PAUSAR", tag_spool, None, estado_detalle)`
    4. In completar_operacion() method:
       - AFTER the call to `self.state_service.completar()` (state update successful)
       - BEFORE the return statement
       - Call: `await self.redis_event_service.publish_spool_update("COMPLETAR", tag_spool, worker_nombre, nuevo_estado_detalle)`

    Update get_occupation_service() in dependency.py to inject RedisEventService.

    Based on research pattern from 04-RESEARCH.md lines 577-625.
  </action>
  <verify>grep "publish_spool_update" backend/services/occupation_service.py | wc -l</verify>
  <done>OccupationService publishes TOMAR/PAUSAR/COMPLETAR events</done>
</task>

<task type="auto">
  <name>Task 2: Add event publishing to StateService</name>
  <files>backend/services/state_service.py</files>
  <action>
    Add event publishing to StateService for state machine transitions.

    1. Update StateService constructor to accept redis_event_service parameter
    2. In completar() method:
       - AFTER the line where estado_detalle is built: `nuevo_estado_detalle = EstadoDetalleBuilder.build(...)`
       - BEFORE updating the spool in sheets_repository
       - Call: `await self.redis_event_service.publish_spool_update("STATE_CHANGE", tag_spool, worker_nombre, nuevo_estado_detalle)`
       - This publishes the new state immediately after state machine transition
    3. Update get_state_service() in dependency.py to inject RedisEventService

    The STATE_CHANGE event notifies clients when ARM/SOLD progress changes,
    separate from occupation changes.
  </action>
  <verify>grep "STATE_CHANGE" backend/services/state_service.py</verify>
  <done>StateService publishes STATE_CHANGE events on transitions</done>
</task>

<task type="auto">
  <name>Task 3: Create dashboard REST endpoint</name>
  <files>backend/routers/dashboard_router.py, backend/main.py</files>
  <action>
    Create REST endpoint for initial dashboard data load.

    1. backend/routers/dashboard_router.py:
       - GET /api/dashboard/occupied endpoint
       - Query SheetsRepository for spools where Ocupado_Por is not empty
       - Return list of occupied spools with:
         - tag_spool, worker_nombre (from Ocupado_Por)
         - estado_detalle (from Estado_Detalle column)
         - fecha_ocupacion (from Fecha_Ocupacion column)
       - Sort by fecha_ocupacion DESC (newest first)

    2. backend/main.py:
       - Add dashboard_router to app.include_router()

    This provides initial state for dashboard, SSE handles updates.
  </action>
  <verify>curl http://localhost:8000/api/dashboard/occupied | jq .</verify>
  <done>Dashboard endpoint returns list of occupied spools</done>
</task>

</tasks>

<verification>
1. OccupationService publishes events on TOMAR/PAUSAR/COMPLETAR
2. StateService publishes STATE_CHANGE on transitions
3. Dashboard endpoint returns occupied spools with estado_detalle
4. Events contain complete data (no additional Sheets fetches needed)
</verification>

<success_criteria>
- All state changes trigger Redis pub/sub events
- Dashboard REST endpoint returns current occupied spools
- Events include worker name, estado_detalle, timestamp
- No performance impact on existing operations
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-visibility/04-02-SUMMARY.md`
</output>