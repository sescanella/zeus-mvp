---
phase: 04-real-time-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/services/sse_service.py
  - backend/services/redis_event_service.py
  - backend/routers/sse_router.py
  - backend/main.py
autonomous: true

must_haves:
  truths:
    - "Worker sees available spools update within 10 seconds"
    - "Connection status shows when updates are flowing"
    - "Multiple workers see same state changes simultaneously"
  artifacts:
    - path: "backend/services/sse_service.py"
      provides: "SSE streaming logic with Redis subscription"
      min_lines: 60
    - path: "backend/services/redis_event_service.py"
      provides: "Event publishing to Redis channels"
      exports: ["RedisEventService"]
    - path: "backend/routers/sse_router.py"
      provides: "GET /api/sse/stream endpoint"
      exports: ["router"]
  key_links:
    - from: "backend/routers/sse_router.py"
      to: "sse_service.py"
      via: "EventSourceResponse"
      pattern: "EventSourceResponse.*event_generator"
    - from: "backend/services/sse_service.py"
      to: "redis.pubsub"
      via: "Redis subscription"
      pattern: "redis\\.pubsub.*subscribe"
---

<objective>
Implement SSE backend infrastructure with Redis pub/sub for real-time event streaming

Purpose: Enable server-to-client push notifications for spool state changes
Output: SSE endpoint that streams Redis pub/sub events to connected clients
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-visibility/04-CONTEXT.md
@.planning/phases/04-real-time-visibility/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install SSE dependencies</name>
  <files>backend/requirements.txt</files>
  <action>
    Add sse-starlette==3.2.0 to requirements.txt for SSE implementation.
    The redis dependency already exists from Phase 2 (redis[hiredis]==5.0.1).

    Run pip install to update dependencies.
  </action>
  <verify>grep "sse-starlette==3.2.0" backend/requirements.txt</verify>
  <done>sse-starlette added to requirements and installed</done>
</task>

<task type="auto">
  <name>Task 2: Create Redis event publisher service</name>
  <files>backend/services/redis_event_service.py</files>
  <action>
    Create RedisEventService class that publishes state change events to Redis pub/sub.

    Key methods:
    - publish_spool_update(event_type, tag_spool, worker_nombre, estado_detalle, additional_data)
      - event_type: "TOMAR", "PAUSAR", "COMPLETAR", "STATE_CHANGE"
      - Publishes JSON message to "spools:updates" channel
      - Include timestamp in ISO format

    Use redis.asyncio (already imported as aioredis in Phase 2).
    Inject Redis client via constructor.

    Based on research pattern from 04-RESEARCH.md lines 513-565.
  </action>
  <verify>pytest backend/tests/unit/test_redis_event_service.py -v</verify>
  <done>RedisEventService publishes events to Redis pub/sub channel</done>
</task>

<task type="auto">
  <name>Task 3: Implement SSE streaming endpoint</name>
  <files>backend/routers/sse_router.py, backend/services/sse_service.py, backend/main.py</files>
  <action>
    Create SSE endpoint that subscribes to Redis channel and streams events.

    1. backend/services/sse_service.py:
       - Create event_generator async generator that subscribes to "spools:updates"
       - Use async with redis.pubsub() context manager for cleanup
       - Check request.is_disconnected() to detect client drops
       - Yield SSE events with "spool_update" event name

    2. backend/routers/sse_router.py:
       - GET /api/sse/stream endpoint
       - Return EventSourceResponse with event_generator
       - Add headers: X-Accel-Buffering: no, Cache-Control: no-cache
       - Set ping=15 for keepalive, send_timeout=30 for dead connection detection

    3. backend/main.py:
       - Add sse_router to app.include_router()

    Based on research patterns from 04-RESEARCH.md lines 428-509.
  </action>
  <verify>curl -N http://localhost:8000/api/sse/stream 2>&1 | head -5</verify>
  <done>SSE endpoint streams events from Redis pub/sub to clients</done>
</task>

</tasks>

<verification>
1. SSE endpoint accessible at GET /api/sse/stream
2. Redis pub/sub channel "spools:updates" created
3. EventSourceResponse streams events with proper headers
4. Client disconnect triggers cleanup
</verification>

<success_criteria>
- SSE endpoint returns EventSource stream with ping keepalive
- Redis events published to channel are streamed to clients
- No buffering issues (X-Accel-Buffering header set)
- Connection cleanup on client disconnect
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-visibility/04-01-SUMMARY.md`
</output>