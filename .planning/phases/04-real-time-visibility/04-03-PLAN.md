---
phase: 04-real-time-visibility
plan: 03
type: execute
wave: 3
depends_on: [04-01]
files_modified:
  - zeues-frontend/lib/hooks/useSSE.ts
  - zeues-frontend/components/ConnectionStatus.tsx
  - zeues-frontend/app/seleccionar-spool/page.tsx
  - zeues-frontend/lib/types.ts
autonomous: true

must_haves:
  truths:
    - "Frontend connects to SSE endpoint with auto-reconnect"
    - "Connection status indicator shows red/green"
    - "Spool selection updates in real-time"
  artifacts:
    - path: "zeues-frontend/lib/hooks/useSSE.ts"
      provides: "React hook for EventSource with reconnection"
      exports: ["useSSE"]
    - path: "zeues-frontend/components/ConnectionStatus.tsx"
      provides: "Visual connection status indicator"
      exports: ["ConnectionStatus"]
    - path: "zeues-frontend/app/seleccionar-spool/page.tsx"
      provides: "Real-time spool selection"
      contains: "useSSE"
  key_links:
    - from: "zeues-frontend/lib/hooks/useSSE.ts"
      to: "EventSource"
      via: "native browser API"
      pattern: "new EventSource"
    - from: "zeues-frontend/lib/hooks/useSSE.ts"
      to: "Page Visibility API"
      via: "visibilitychange event"
      pattern: "document\\.addEventListener.*visibilitychange"
---

<objective>
Implement frontend real-time integration with SSE and connection status

Purpose: Enable client-side real-time updates with mobile-optimized lifecycle management
Output: React hook for SSE, connection indicator, real-time spool selection
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-visibility/04-CONTEXT.md
@.planning/phases/04-real-time-visibility/04-RESEARCH.md
@.planning/phases/04-real-time-visibility/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSSE React hook</name>
  <files>zeues-frontend/lib/hooks/useSSE.ts, zeues-frontend/lib/types.ts</files>
  <action>
    Implement custom React hook for EventSource with exponential backoff and Page Visibility API.

    1. zeues-frontend/lib/types.ts:
       - Add SSEEvent interface: type, tag_spool, worker, estado_detalle, timestamp
       - Add UseSSEOptions interface: onMessage, onError, onConnectionChange, openWhenHidden

    2. zeues-frontend/lib/hooks/useSSE.ts:
       - useSSE(url, options) hook
       - EventSource connection with auto-reconnect
       - Exponential backoff: 1s, 2s, 4s... max 30s
       - Page Visibility API: close on hidden, reconnect on visible (unless openWhenHidden=true)
       - Listen for 'spool_update' events
       - Return { isConnected, disconnect }
       - Max 10 retries before giving up

    Based on research pattern from 04-RESEARCH.md lines 629-758.
  </action>
  <verify>grep "visibilitychange" zeues-frontend/lib/hooks/useSSE.ts</verify>
  <done>useSSE hook implements EventSource with mobile lifecycle support</done>
</task>

<task type="auto">
  <name>Task 2: Create connection status component</name>
  <files>zeues-frontend/components/ConnectionStatus.tsx</files>
  <action>
    Create visual indicator for SSE connection status.

    ConnectionStatus component:
    - Props: { connected: boolean }
    - Display: Small dot (green when connected, red when disconnected)
    - Position: Fixed top-right corner, unobtrusive
    - Text: "Conectado" or "Desconectado" in Spanish
    - Styling: Tailwind classes for mobile-friendly size
    - Animation: None (instant update per CONTEXT.md)

    Component should be simple and focused on clear visual feedback.
  </action>
  <verify>grep "bg-green-500.*bg-red-500" zeues-frontend/components/ConnectionStatus.tsx</verify>
  <done>ConnectionStatus component shows red/green connection indicator</done>
</task>

<task type="auto">
  <name>Task 3: Add real-time updates to spool selection</name>
  <files>zeues-frontend/app/seleccionar-spool/page.tsx</files>
  <action>
    Integrate SSE real-time updates into spool selection page.

    1. Import useSSE hook and ConnectionStatus component
    2. Connect to SSE endpoint: /api/sse/stream
    3. Handle events:
       - TOMAR: Remove spool from available list (another worker took it)
       - PAUSAR: Add spool back to available list (if matches current operation)
       - STATE_CHANGE: Update estado_detalle for context display
    4. Show ConnectionStatus in top-right
    5. On race condition (user selects already-taken spool):
       - Show friendly error: "Este carrete fue tomado por {worker}"
       - Auto-refresh list

    Remember: Page already filters by operation type from context.
  </action>
  <verify>grep "useSSE" zeues-frontend/app/seleccionar-spool/page.tsx</verify>
  <done>Spool selection updates in real-time with SSE events</done>
</task>

</tasks>

<verification>
1. useSSE hook connects to EventSource with auto-reconnect
2. Page Visibility API closes connection on background
3. Connection status shows green when connected, red when disconnected
4. Spool selection list updates within 10 seconds of changes
</verification>

<success_criteria>
- EventSource connection established with exponential backoff
- Mobile lifecycle handled (close on background, reconnect on foreground)
- Connection status visible to users
- Available spools update in real-time (< 10s latency)
- Race condition handled with friendly error message
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-visibility/04-03-SUMMARY.md`
</output>