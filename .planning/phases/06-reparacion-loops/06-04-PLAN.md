---
phase: 06-reparacion-loops
plan: 04
type: execute
wave: 4
depends_on: [06-03]
files_modified:
  - backend/services/reparacion_service.py
  - backend/services/estado_detalle_service.py
  - backend/services/__init__.py
  - tests/integration/test_reparacion_flow.py
  - tests/unit/test_reparacion_service.py
  - tests/unit/test_supervisor_override.py
autonomous: true

must_haves:
  truths:
    - "SSE events publish for TOMAR/PAUSAR/COMPLETAR reparación"
    - "System detects supervisor override when BLOQUEADO changes to RECHAZADO"
    - "Integration tests verify complete repair cycle workflow"
    - "3-cycle limit enforced end-to-end"
  artifacts:
    - path: "backend/services/estado_detalle_service.py"
      provides: "Supervisor override detection"
      exports: ["EstadoDetalleService"]
    - path: "tests/integration/test_reparacion_flow.py"
      provides: "End-to-end reparación tests"
      min_lines: 300
    - path: "tests/unit/test_supervisor_override.py"
      provides: "Override detection tests"
      min_lines: 150
  key_links:
    - from: "reparacion_service.py"
      to: "redis_event_service.py"
      via: "publish SSE events"
      pattern: "publish_spool_update"
    - from: "estado_detalle_service.py"
      to: "metadata_repository.py"
      via: "log override event"
      pattern: "SUPERVISOR_OVERRIDE"
---

<objective>
Complete reparación workflow with SSE event integration, supervisor override detection, and comprehensive test suite validating the 3-cycle limit.

Purpose: Ensure real-time visibility of repair work and automatic audit logging of supervisor interventions
Output: Full reparación workflow with SSE events, override detection, and 95% test coverage
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reparacion-loops/06-CONTEXT.md
@.planning/phases/06-reparacion-loops/06-RESEARCH.md

# Reference SSE patterns
@backend/services/redis_event_service.py
@backend/services/occupation_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSE event publishing to reparación</name>
  <files>backend/services/reparacion_service.py</files>
  <action>
    Integrate SSE events following Phase 4 patterns:

    1. Make ReparacionService async (like MetrologiaService in Phase 5)

    2. Update tomar_reparacion to publish event:
       ```python
       await self.redis_event_service.publish_spool_update(
           event_type="TOMAR_REPARACION",
           tag_spool=tag_spool,
           worker_id=worker_id,
           worker_nombre=worker_nombre,
           estado_detalle=new_estado_detalle,
           metadata={"cycle": cycle, "action": "TOMAR", "operacion": "REPARACION"}
       )
       ```

    3. Add events for pausar, completar, cancelar similarly

    4. Use best-effort pattern:
       - Try/except around publish
       - Log warning on failure
       - Don't block operation

    5. Include cycle info in event metadata for dashboard display

    Reference: Phase 4-5 SSE integration patterns
    Make service methods async to support event publishing
  </action>
  <verify>python -c "import asyncio; from backend.services import ReparacionService; print('Async service ready')"</verify>
  <done>ReparacionService publishes SSE events for all actions</done>
</task>

<task type="auto">
  <name>Task 2: Create supervisor override detection service</name>
  <files>backend/services/estado_detalle_service.py, backend/services/__init__.py</files>
  <action>
    Create service to detect manual Estado_Detalle changes:

    1. Create EstadoDetalleService class:
       - Inject sheets_repo and metadata_repo dependencies

    2. Implement detect_supervisor_override(tag_spool):
       - Read current Estado_Detalle from Sheets
       - Get last metadata event for spool
       - If last event shows BLOQUEADO and current is RECHAZADO:
         * Log SUPERVISOR_OVERRIDE event to Metadata
         * Include previous/new estado in metadata_json
         * Use worker_id=0 for system events

    3. Call from spool reading operations:
       - When fetching spools for reparación
       - During periodic state checks

    4. Export from __init__.py

    Reference: Phase 1 metadata logging patterns
    This provides audit trail without building admin UI
  </action>
  <verify>python -m pytest tests/unit/test_supervisor_override.py::test_detects_bloqueado_to_rechazado_change -xvs</verify>
  <done>EstadoDetalleService detects and logs supervisor overrides automatically</done>
</task>

<task type="auto">
  <name>Task 3: Create integration tests for repair cycle</name>
  <files>tests/integration/test_reparacion_flow.py</files>
  <action>
    Create comprehensive integration tests for full workflow:

    1. Test complete repair cycle:
       - test_complete_repair_cycle_success:
         * Metrología rejects → RECHAZADO (Ciclo 1/3)
         * Worker repairs → PENDIENTE_METROLOGIA
         * Metrología approves → APROBADO (cycle reset)

    2. Test 3-cycle blocking:
       - test_three_rejections_blocks_spool:
         * First rejection → RECHAZADO (Ciclo 1/3)
         * Repair + Second rejection → RECHAZADO (Ciclo 2/3)
         * Repair + Third rejection → BLOQUEADO
         * Fourth TOMAR attempt → 403 SpoolBloqueadoError

    3. Test PAUSAR/resume workflow:
       - test_pausar_and_resume_repair

    4. Test CANCELAR returns to RECHAZADO

    5. Test supervisor override:
       - test_supervisor_override_detected:
         * Manually change BLOQUEADO → RECHAZADO
         * System logs SUPERVISOR_OVERRIDE event

    6. Test SSE events:
       - Mock redis_event_service
       - Verify events published for each action

    Use async test patterns from Phase 5
    Mock all external dependencies
  </action>
  <verify>python -m pytest tests/integration/test_reparacion_flow.py -v</verify>
  <done>Integration tests verify complete 3-cycle workflow with blocking</done>
</task>

<task type="auto">
  <name>Task 4: Create unit tests for services</name>
  <files>tests/unit/test_reparacion_service.py, tests/unit/test_supervisor_override.py</files>
  <action>
    Create unit tests for reparación and override detection:

    test_reparacion_service.py:
    1. Test TOMAR with cycle extraction
    2. Test PAUSAR clears occupation
    3. Test COMPLETAR sets PENDIENTE_METROLOGIA
    4. Test CANCELAR returns to RECHAZADO
    5. Test SSE event publishing (mock redis_event_service)
    6. Test best-effort pattern (SSE failure doesn't block)

    test_supervisor_override.py:
    1. Test override detection logic:
       - test_detects_bloqueado_to_rechazado_change
       - test_ignores_normal_transitions
       - test_logs_supervisor_override_event

    2. Test metadata logging:
       - test_override_event_includes_metadata
       - test_system_worker_id_zero

    3. Test edge cases:
       - test_no_previous_event
       - test_multiple_overrides

    Use AsyncMock for async methods
    Mock sheets and metadata repositories
  </action>
  <verify>python -m pytest tests/unit/test_supervisor_override.py::test_detects_bloqueado_to_rechazado_change -xvs</verify>
  <done>All unit tests pass with 95% coverage of reparación logic</done>
</task>

</tasks>

<verification>
# Run all reparación tests
python -m pytest tests/ -k "reparacion" -v

# Check supervisor override detection with specific test
python -m pytest tests/unit/test_supervisor_override.py::test_detects_bloqueado_to_rechazado_change -xvs

# Verify integration tests
python -m pytest tests/integration/test_reparacion_flow.py::test_three_rejections_blocks_spool -xvs

# Check async patterns work
python -c "import asyncio; from backend.services import ReparacionService"

# Test SSE event structure
python -c "from backend.services.reparacion_service import ReparacionService; print('SSE integration ready')"
</verification>

<success_criteria>
- [ ] ReparacionService publishes SSE events for all actions
- [ ] EstadoDetalleService detects BLOQUEADO → RECHAZADO changes
- [ ] Integration tests verify 3-cycle limit enforcement
- [ ] Supervisor override automatically logged to Metadata
- [ ] All tests pass with >95% coverage
- [ ] Best-effort SSE pattern prevents blocking on failures
</success_criteria>

<output>
After completion, create `.planning/phases/06-reparacion-loops/06-04-SUMMARY.md`
</output>