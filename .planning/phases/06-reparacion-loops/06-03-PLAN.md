---
phase: 06-reparacion-loops
plan: 03
type: execute
wave: 2
depends_on: [06-01, 06-02]
files_modified:
  - backend/routers/spools.py
  - backend/routers/actions.py
  - backend/main.py
  - zeues-frontend/app/operacion/page.tsx
  - zeues-frontend/app/seleccionar-spool/page.tsx
  - zeues-frontend/lib/api.ts
  - zeues-frontend/components/SpoolCard.tsx
autonomous: true

must_haves:
  truths:
    - "REPARACI√ìN appears as 4th operation button on frontend"
    - "Spool selection shows RECHAZADO spools with cycle info"
    - "BLOQUEADO spools visible but disabled in UI"
    - "API endpoint filters and returns reparaci√≥n spools correctly"
  artifacts:
    - path: "backend/routers/spools.py"
      provides: "GET /api/spools/reparacion endpoint"
      min_lines: 40
    - path: "backend/routers/actions.py"
      provides: "POST /completar-reparacion endpoint"
      min_lines: 30
    - path: "zeues-frontend/app/operacion/page.tsx"
      provides: "REPARACI√ìN button in operation selection"
      min_lines: 20
  key_links:
    - from: "zeues-frontend/lib/api.ts"
      to: "/api/spools/reparacion"
      via: "fetch with operation filter"
      pattern: "fetch.*reparacion"
    - from: "SpoolCard.tsx"
      to: "spool.bloqueado"
      via: "conditional styling"
      pattern: "bloqueado.*cursor-not-allowed"
---

<objective>
Create REST endpoints for reparaci√≥n workflow and integrate frontend with 4th operation module, showing RECHAZADO spools with cycle info and BLOQUEADO state.

Purpose: Enable workers to select and repair rejected spools through the UI with proper visual feedback
Output: Working REST API and frontend integration for reparaci√≥n workflow
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reparacion-loops/06-CONTEXT.md
@.planning/phases/06-reparacion-loops/06-RESEARCH.md

# Reference existing endpoints
@backend/routers/spools.py
@backend/routers/actions.py
@backend/main.py

# Frontend patterns
@zeues-frontend/app/operacion/page.tsx
@zeues-frontend/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create REST endpoints for reparaci√≥n</name>
  <files>backend/routers/spools.py, backend/routers/actions.py, backend/main.py</files>
  <action>
    Add reparaci√≥n endpoints following existing patterns:

    1. In routers/spools.py, add GET /api/spools/reparacion:
       - Filter spools where estado_detalle contains "RECHAZADO" or "BLOQUEADO"
       - Skip occupied spools (ocupado_por != None)
       - For each spool:
         * Parse cycle using CycleCounterService
         * Add bloqueado flag (True if BLOQUEADO in estado)
         * Include fecha_rechazo (from Fecha_QC_Metrologia)
       - Return format:
         ```json
         {
           "spools": [...],
           "total": N,
           "bloqueados": M,
           "filtro_aplicado": "RECHAZADO + BLOQUEADO visibles (no ocupados)"
         }
         ```

    2. In routers/actions.py, add reparaci√≥n actions:
       - POST /api/tomar-reparacion: Call ReparacionService.tomar_reparacion()
       - POST /api/pausar-reparacion: Call ReparacionService.pausar_reparacion()
       - POST /api/completar-reparacion: Call ReparacionService.completar_reparacion()
       - POST /api/cancelar-reparacion: Call ReparacionService.cancelar_reparacion()
       - Handle SpoolBloqueadoError ‚Üí 403 response

    3. In main.py, add exception handler:
       - Map SpoolBloqueadoError to 403 Forbidden status

    Reference: Phase 2-5 endpoint patterns
    Include proper dependency injection for services
  </action>
  <verify>curl -X GET http://localhost:8000/api/spools/reparacion | jq</verify>
  <done>REST endpoints return RECHAZADO spools with bloqueado flags</done>
</task>

<task type="auto">
  <name>Task 2: Add REPARACI√ìN to frontend operation selection</name>
  <files>zeues-frontend/app/operacion/page.tsx</files>
  <action>
    Add REPARACI√ìN as 4th operation option:

    1. Add to operations array:
       ```typescript
       const operations = [
         { id: 'ARM', label: 'Armado', color: 'bg-blue-600' },
         { id: 'SOLD', label: 'Soldadura', color: 'bg-orange-600' },
         { id: 'METROLOGIA', label: 'Metrolog√≠a', color: 'bg-green-600' },
         { id: 'REPARACION', label: 'Reparaci√≥n', color: 'bg-yellow-600' }
       ];
       ```

    2. Update handleSelectOperation:
       - For REPARACION: Navigate to tipo-interaccion (follows ARM/SOLD pattern)
       - Store operation in context

    3. Style the button:
       - Use yellow color scheme (bg-yellow-600)
       - Same h-32 height for mobile-first design
       - Icon: üîß or similar repair symbol

    Reference: Existing operation selection pattern
    Maintain consistent button styling and navigation
  </action>
  <verify>npm run dev && echo "Check http://localhost:3000/operacion shows 4 buttons"</verify>
  <done>REPARACI√ìN button appears as 4th operation with yellow styling</done>
</task>

<task type="auto">
  <name>Task 3: Update spool selection for reparaci√≥n</name>
  <files>zeues-frontend/app/seleccionar-spool/page.tsx, zeues-frontend/components/SpoolCard.tsx</files>
  <action>
    Modify spool selection to handle reparaci√≥n workflow:

    1. In seleccionar-spool/page.tsx:
       - Detect when operacion === 'REPARACION'
       - Call getSpoolsReparacion() instead of generic fetch
       - Show title: "Seleccionar Spool para Reparaci√≥n"
       - Display cycle info in subtitle

    2. Create/Update SpoolCard component:
       - Accept bloqueado prop
       - If bloqueado:
         * Apply red border (border-red-500)
         * Gray background (bg-red-50)
         * Disabled cursor (cursor-not-allowed)
         * Show lock icon: üîí BLOQUEADO - Contactar supervisor
       - If not bloqueado:
         * Show cycle warning: ‚ö†Ô∏è Ciclo X/3
         * Yellow warning color
       - Disable onClick when bloqueado

    3. Handle empty state:
       - Message: "No hay spools rechazados pendientes de reparaci√≥n"

    TypeScript: Never use 'any' - type spool data properly
    Reference: Phase 2 spool selection patterns
  </action>
  <verify>npm run build && npm run lint</verify>
  <done>Spool selection shows RECHAZADO spools with BLOQUEADO state disabled</done>
</task>

<task type="auto">
  <name>Task 4: Add API functions for reparaci√≥n</name>
  <files>zeues-frontend/lib/api.ts</files>
  <action>
    Add reparaci√≥n API functions following existing patterns:

    1. Add getSpoolsReparacion():
       ```typescript
       export async function getSpoolsReparacion(): Promise<{
         spools: Array<{
           tag_spool: string;
           fecha_rechazo: string;
           estado_detalle: string;
           cycle: number;
           bloqueado: boolean;
         }>;
         total: number;
         bloqueados: number;
       }> {
         const response = await fetch(`${API_URL}/spools/reparacion`);
         if (!response.ok) throw new Error('Failed to fetch reparacion spools');
         return response.json();
       }
       ```

    2. Add completarReparacion():
       ```typescript
       export async function completarReparacion(payload: {
         tag_spool: string;
         worker_id: number;
         worker_nombre: string;
         fecha_operacion: string;
       }): Promise<unknown> {
         const response = await fetch(`${API_URL}/completar-reparacion`, {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(payload)
         });

         if (response.status === 403) {
           throw new Error('Spool bloqueado - contactar supervisor');
         }
         if (!response.ok) {
           throw new Error('Failed to complete reparacion');
         }
         return response.json();
       }
       ```

    3. Add tomar/pausar/cancelar functions similarly

    TypeScript: Use 'unknown' instead of 'any' for dynamic responses
    Reference: Phase 5 API function patterns
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>API functions typed correctly with no TypeScript errors</done>
</task>

</tasks>

<verification>
# Backend: Test reparaci√≥n endpoints
curl -X GET http://localhost:8000/api/spools/reparacion
curl -X POST http://localhost:8000/api/completar-reparacion -H "Content-Type: application/json" -d '{"tag_spool":"TEST","worker_id":1,"worker_nombre":"Test","fecha_operacion":"2026-01-28"}'

# Frontend: TypeScript and build checks
cd zeues-frontend
npx tsc --noEmit
npm run lint
npm run build

# Check operation page has 4 buttons
npm run dev
# Navigate to /operacion - should see REPARACI√ìN button
</verification>

<success_criteria>
- [ ] GET /api/spools/reparacion returns RECHAZADO spools with bloqueado flag
- [ ] POST endpoints handle reparaci√≥n actions (tomar/pausar/completar/cancelar)
- [ ] REPARACI√ìN appears as 4th yellow button on operation selection
- [ ] Spool cards show cycle info and disable BLOQUEADO spools
- [ ] TypeScript compilation passes with no 'any' types
- [ ] Frontend build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-reparacion-loops/06-03-SUMMARY.md`
</output>