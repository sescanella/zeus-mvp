---
phase: 07-data-model-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [backend/scripts/validate_uniones_sheet.py, backend/scripts/extend_metadata_schema.py]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Uniones sheet exists with 18 columns and correct structure"
    - "Metadata sheet has N_UNION column at position 11"
    - "System can validate sheet schemas at startup"
  artifacts:
    - path: "backend/scripts/validate_uniones_sheet.py"
      provides: "Validation script for Uniones sheet"
      min_lines: 80
    - path: "backend/scripts/extend_metadata_schema.py"
      provides: "Migration script for Metadata sheet"
      min_lines: 60
  key_links:
    - from: "validate_uniones_sheet.py"
      to: "Uniones sheet"
      via: "gspread read headers"
      pattern: "worksheet.*row_values\\(1\\)"
---

<objective>
Validate Uniones sheet structure and extend Metadata sheet with N_UNION column.

Purpose: Prepare sheets for union-level granular tracking and audit trail
Output: Validated Uniones sheet and extended Metadata sheet
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-model-foundation/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Uniones sheet validation script</name>
  <files>backend/scripts/validate_uniones_sheet.py</files>
  <action>
    Create a validation script that checks if the Uniones sheet exists and has the correct structure.

    The script must validate:
    1. Sheet exists (pre-populated by Engineering)
    2. Has exactly 18 columns
    3. Column headers match expected names:
       - Columns 1-5: ID, TAG_SPOOL, N_UNION, DN_UNION, TIPO_UNION
       - Columns 6-8: ARM_FECHA_INICIO, ARM_FECHA_FIN, ARM_WORKER
       - Columns 9-11: SOL_FECHA_INICIO, SOL_FECHA_FIN, SOL_WORKER
       - Columns 12-13: NDT_FECHA, NDT_STATUS
       - Columns 14-18: version, Creado_Por, Fecha_Creacion, Modificado_Por, Fecha_Modificacion

    The script should:
    - Use gspread with service account
    - Read headers from row 1
    - Compare against expected schema
    - Report any missing or extra columns
    - Exit with error code if validation fails
    - Support --fix flag to attempt adding missing columns (headers only)

    Important: This script validates but does NOT populate data. Engineering pre-populates union data.
  </action>
  <verify>Run: python backend/scripts/validate_uniones_sheet.py</verify>
  <done>Script reports either "Uniones sheet valid" or lists specific issues</done>
</task>

<task type="auto">
  <name>Task 2: Create Metadata schema extension script</name>
  <files>backend/scripts/extend_metadata_schema.py</files>
  <action>
    Create a migration script that adds N_UNION column to Metadata sheet at position 11.

    The script must:
    1. Check current column count (should be 10)
    2. Check if N_UNION already exists (idempotent)
    3. Add "N_UNION" header at row 1, column 11 if not present
    4. Leave all existing data rows unchanged (NULL is valid for spool-level events)
    5. Use batch_update() with USER_ENTERED
    6. Log the change for audit trail

    The N_UNION column will be:
    - Nullable (spool-level events have no union)
    - Integer when populated (union number 1-20)
    - Used for granular UNION_ARM_REGISTRADA and UNION_SOLD_REGISTRADA events

    Follow similar pattern to extend_operaciones_schema.py but simpler (just 1 column).
  </action>
  <verify>Run: python backend/scripts/extend_metadata_schema.py --dry-run</verify>
  <done>Script reports "1 column would be added to Metadata sheet"</done>
</task>

</tasks>

<verification>
1. Validate Uniones structure: `python backend/scripts/validate_uniones_sheet.py`
2. Test Metadata extension: `python backend/scripts/extend_metadata_schema.py --dry-run`
3. Verify scripts are idempotent by running twice
</verification>

<success_criteria>
- [ ] Uniones validation script detects all schema issues
- [ ] Metadata extension script adds N_UNION column
- [ ] Both scripts are idempotent
- [ ] Both scripts use batch operations where applicable
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-model-foundation/07-02-SUMMARY.md`
</output>