---
phase: 07-data-model-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/scripts/extend_operaciones_schema.py, backend/core/column_map_cache.py]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Operaciones sheet has 72 columns with correct headers"
    - "System can read and write to new metric columns"
    - "v3.0 code continues to work without changes"
  artifacts:
    - path: "backend/scripts/extend_operaciones_schema.py"
      provides: "Schema migration script for Operaciones"
      min_lines: 100
    - path: "backend/core/column_map_cache.py"
      provides: "Enhanced cache with invalidation method"
      contains: "def invalidate"
  key_links:
    - from: "extend_operaciones_schema.py"
      to: "Google Sheets API"
      via: "gspread batch_update"
      pattern: "batch_update.*USER_ENTERED"
---

<objective>
Extend Operaciones sheet from 67 to 72 columns by adding metric aggregation columns.

Purpose: Enable v4.0 to track union-level metrics while preserving v3.0 compatibility
Output: Operaciones sheet with 5 new columns (68-72) and migration script
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-model-foundation/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Operaciones schema extension script</name>
  <files>backend/scripts/extend_operaciones_schema.py</files>
  <action>
    Create a migration script that adds 5 new columns to the Operaciones sheet:
    - Column 68: Total_Uniones (integer, count of unions for this spool)
    - Column 69: Uniones_ARM_Completadas (integer, count where ARM_FECHA_FIN != NULL)
    - Column 70: Uniones_SOLD_Completadas (integer, count where SOL_FECHA_FIN != NULL)
    - Column 71: Pulgadas_ARM (float, sum of DN_UNION where ARM completed)
    - Column 72: Pulgadas_SOLD (float, sum of DN_UNION where SOLD completed)

    The script must:
    1. Use gspread to connect with service account credentials
    2. Check if columns already exist (idempotent)
    3. Add headers at row 1, columns 68-72 if not present
    4. Use batch_update() with USER_ENTERED for single API call
    5. Initialize all data rows with default values (0 for numbers)
    6. Log progress and handle errors gracefully
    7. Invalidate ColumnMapCache after changes

    Follow the pattern from backend/scripts/add_estado_detalle_column.py which added column 67.
  </action>
  <verify>Run: python backend/scripts/extend_operaciones_schema.py --dry-run</verify>
  <done>Script executes without errors and reports "5 columns would be added" in dry-run mode</done>
</task>

<task type="auto">
  <name>Task 2: Add cache invalidation to ColumnMapCache</name>
  <files>backend/core/column_map_cache.py</files>
  <action>
    Add invalidation capabilities to ColumnMapCache class:

    1. Add a class method `invalidate(sheet_name: str)` that removes the cached mapping for a specific sheet
    2. Add a class method `invalidate_all()` that clears the entire cache
    3. Update the docstring to document these new methods

    The invalidation is needed because after adding columns, the cached mappings become stale. The migration script will call ColumnMapCache.invalidate("Operaciones") after adding columns.

    This ensures that the next get_or_build() call will rebuild the mapping with the new columns included.
  </action>
  <verify>grep -n "def invalidate" backend/core/column_map_cache.py</verify>
  <done>ColumnMapCache has invalidate() and invalidate_all() methods defined</done>
</task>

</tasks>

<verification>
1. Run migration script in dry-run mode: `python backend/scripts/extend_operaciones_schema.py --dry-run`
2. Verify ColumnMapCache has invalidation methods: `grep "def invalidate" backend/core/column_map_cache.py`
3. Check that script follows idempotent pattern from add_estado_detalle_column.py
</verification>

<success_criteria>
- [ ] Migration script created and validates in dry-run mode
- [ ] ColumnMapCache enhanced with invalidation methods
- [ ] Script uses batch_update() for efficiency
- [ ] Script is idempotent (safe to run multiple times)
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-model-foundation/07-01-SUMMARY.md`
</output>