---
phase: 07-data-model-foundation
plan: 05
type: execute
wave: 4
depends_on: [07-04]
files_modified: [main.py]
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Application refuses to start with incomplete v4.0 schema"
    - "Startup logs clearly show schema validation status"
    - "v3.0 validation remains for backward compatibility check"
  artifacts:
    - path: "main.py"
      provides: "Startup validation hook"
      contains: "validate_v4_schema"
  key_links:
    - from: "main.py"
      to: "validate_schema_startup.py"
      via: "startup event"
      pattern: "@app\\.on_event.*startup"
---

<objective>
Integrate v4.0 schema validation into FastAPI startup sequence.

Purpose: Ensure application won't start if schema is incomplete
Output: Modified main.py with comprehensive startup validation
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-model-foundation/07-RESEARCH.md
@.planning/phases/07-data-model-foundation/07-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate validation into FastAPI startup</name>
  <files>main.py</files>
  <action>
    Add v4.0 schema validation to the existing startup event handler in main.py.

    Modifications needed:
    1. Import the validation function from validate_schema_startup
    2. After the existing v3.0 column validation (~line 301), add v4.0 validation
    3. Check for v4.0 columns in Operaciones (68-72)
    4. Validate Uniones sheet exists with correct structure
    5. Validate Metadata has N_UNION column (position 11)
    6. Raise RuntimeError with clear message if validation fails
    7. Log success message if all validations pass

    The validation should run AFTER cache pre-warming but BEFORE accepting traffic.
    This ensures the app won't start if schema is incomplete.

    Keep existing v3.0 validation for backward compatibility check.

    Example integration:
    ```python
    @app.on_event("startup")
    async def startup_event():
        # ... existing cache prewarming ...

        # v3.0 validation (existing)
        validate_v3_columns()

        # v4.0 validation (new)
        from backend.scripts.validate_schema_startup import validate_v4_schema
        success, details = validate_v4_schema()
        if not success:
            failed = [s for s, d in details.items() if d["status"] == "FAIL"]
            raise RuntimeError(f"v4.0 schema validation failed for: {failed}")

        logger.info("v4.0 schema validation passed")
    ```
  </action>
  <verify>grep -n "validate_v4_schema\|Total_Uniones\|N_UNION" main.py | head -5</verify>
  <done>main.py contains v4.0 schema validation in startup event</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete v4.0 schema validation integrated into FastAPI startup</what-built>
  <how-to-verify>
    1. Run validation script: `python backend/scripts/validate_schema_startup.py`
    2. Check it reports status for Operaciones (72 cols), Uniones (18 cols), and Metadata (11 cols)
    3. Start backend: `source venv/bin/activate && uvicorn main:app --reload`
    4. Check startup logs for "v4.0 schema validation passed" message
    5. If any columns are missing, verify app refuses to start with clear error message listing which sheets failed
  </how-to-verify>
  <resume-signal>Type "approved" if validation works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Check main.py integration: `grep "validate_v4_schema" main.py`
2. Start backend and verify startup validation logs
</verification>

<success_criteria>
- [ ] FastAPI startup includes v4.0 validation
- [ ] App refuses to start if schema incomplete
- [ ] Clear error messages identify which sheets have issues
- [ ] Human verified startup behavior is correct
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-model-foundation/07-05-SUMMARY.md`
</output>