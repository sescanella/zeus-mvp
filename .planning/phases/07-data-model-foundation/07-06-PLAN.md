---
phase: 07-data-model-foundation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - "backend/scripts/extend_operaciones_schema.py"
  - "backend/scripts/extend_metadata_schema.py"
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Operaciones sheet has 72 columns including Total_Uniones at column 68"
    - "Metadata sheet has 11 columns with N_UNION at position 11"
    - "Column cache invalidated to pick up new columns"
  artifacts:
    - path: "backend/scripts/extend_operaciones_schema.py"
      provides: "Migration script for Operaciones columns 68-72"
      pattern: "batch_update.*USER_ENTERED"
    - path: "backend/scripts/extend_metadata_schema.py"
      provides: "Migration script for Metadata column 11"
      pattern: "batch_update.*USER_ENTERED"
  key_links:
    - from: "extend_operaciones_schema.py"
      to: "Google Sheets API"
      via: "batch_update with A1 notation"
    - from: "extend_metadata_schema.py"
      to: "Google Sheets API"
      via: "batch_update with A1 notation"
    - from: "migration scripts"
      to: "ColumnMapCache"
      via: "invalidate() call after success"
---

<objective>
Execute schema migration scripts to add missing columns to Google Sheets

Purpose: Close gap from verification - sheets currently missing required v4.0 columns
Output: Operaciones sheet with 72 columns, Metadata sheet with 11 columns
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-model-foundation/07-VERIFICATION.md

# Migration scripts created in prior plans
@.planning/phases/07-data-model-foundation/07-01-SUMMARY.md
@.planning/phases/07-data-model-foundation/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute Operaciones sheet migration</name>
  <files>backend/scripts/extend_operaciones_schema.py</files>
  <action>
    Execute the migration script to add columns 68-72 to Operaciones sheet:
    - Total_Uniones (column 68)
    - Uniones_ARM_Completadas (column 69)
    - Uniones_SOLD_Completadas (column 70)
    - Pulgadas_ARM (column 71)
    - Pulgadas_SOLD (column 72)

    The script already exists from 07-01-PLAN.md and has been tested in dry-run mode.
    It will:
    1. Check if columns already exist (idempotent)
    2. Add missing columns with proper formatting
    3. Set default values ("0" for metrics columns)
    4. Invalidate ColumnMapCache after success

    Run with production mode (not dry-run).
  </action>
  <verify>python backend/scripts/extend_operaciones_schema.py --check</verify>
  <done>Script reports "Operaciones sheet has 72 columns" and "Column 68: Total_Uniones" exists</done>
</task>

<task type="auto">
  <name>Task 2: Execute Metadata sheet migration</name>
  <files>backend/scripts/extend_metadata_schema.py</files>
  <action>
    Execute the migration script to add N_UNION column at position 11:

    The script already exists from 07-02-PLAN.md and has been tested.
    It will:
    1. Check if N_UNION already exists at position 11 (idempotent)
    2. Add N_UNION column if missing
    3. Preserve all existing data
    4. Invalidate ColumnMapCache after success

    This column is nullable and will be used for granular union-level event tracking.
    Run with production mode.
  </action>
  <verify>python backend/scripts/extend_metadata_schema.py --check</verify>
  <done>Script reports "Metadata sheet has 11 columns" and "Column 11: N_UNION" exists</done>
</task>

<task type="auto">
  <name>Task 3: Validate all schemas post-migration</name>
  <files>backend/scripts/validate_schema_startup.py</files>
  <action>
    Run the comprehensive schema validation to confirm migrations successful:

    Expected results:
    - Operaciones: ✅ Valid (72 columns found, all v4.0 columns present)
    - Metadata: ✅ Valid (11 columns found, N_UNION at position 11)
    - Uniones: ❌ Invalid (still missing columns - Engineering dependency)

    The Uniones failure is expected as it requires Engineering team action.
    Document the remaining gap for Uniones sheet.
  </action>
  <verify>python backend/scripts/validate_schema_startup.py</verify>
  <done>Operaciones and Metadata sheets pass validation, Uniones expected to fail</done>
</task>

</tasks>

<verification>
1. Operaciones sheet has exactly 72 columns
2. Column 68 is "Total_Uniones"
3. Columns 69-72 are the other metrics columns
4. Metadata sheet has exactly 11 columns
5. Column 11 is "N_UNION"
6. ColumnMapCache invalidated and will rebuild on next access
</verification>

<success_criteria>
- Migration scripts execute successfully without errors
- Operaciones extended from 67 to 72 columns
- Metadata extended from 10 to 11 columns
- Schema validation passes for Operaciones and Metadata
- System ready for v4.0 features (except Uniones dependency)
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-model-foundation/07-06-SUMMARY.md`
</output>