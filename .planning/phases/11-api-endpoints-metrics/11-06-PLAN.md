---
wave: 4
depends_on: [11-05]
files_modified:
  - backend/services/occupation_service.py
  - backend/routers/union_router.py
  - tests/unit/test_occupation_service.py
  - tests/integration/test_union_api_v4.py
autonomous: true
---

# Plan 11-06: Fix Metadata Batch + Granular Event Logging

**Goal:** Ensure FINALIZAR operation logs 1 batch event (spool level) plus N granular events (union level) per requirement METRIC-03/METRIC-04

**Context:** Gap found during verification - OccupationService.finalizar_spool() logs only 1 spool-level event, missing N union-level granular events. UnionService.process_selection() already implements proper batch + granular logging but is not being called.

## Tasks

### Task 1: Inject UnionService into OccupationService

**File:** `backend/services/occupation_service.py`

**Changes:**
1. Add UnionService as optional dependency in `__init__` (line ~105-110)
2. Import UnionService at top of file
3. Initialize union_service parameter with None default

```python
def __init__(
    self,
    # ... existing params ...
    union_repository: Optional[UnionRepository] = None,
    union_service: Optional['UnionService'] = None  # Add this line
):
    # ... existing initialization ...
    self.union_repository = union_repository
    self.union_service = union_service  # Add this line
```

**Verification:**
- UnionService imported
- union_service added as optional parameter
- self.union_service assigned

### Task 2: Refactor finalizar_spool to use UnionService

**File:** `backend/services/occupation_service.py`

**Changes:**
Replace lines 1222-1247 (direct UnionRepository calls) with UnionService delegation:

```python
# Step 6: Process union selection through UnionService
try:
    if self.union_service:
        # Use UnionService for batch update + metadata logging
        result = self.union_service.process_selection(
            tag_spool=tag_spool,
            union_ids=selected_unions,
            worker_id=worker_id,
            worker_nombre=worker_nombre,
            operacion=operacion
        )

        updated_count = result["union_count"]
        pulgadas = result.get("pulgadas", 0.0)
        event_count = result.get("event_count", 0)

        logger.info(
            f"✅ UnionService processed: {updated_count} unions, "
            f"{pulgadas} pulgadas, {event_count} metadata events"
        )

        # Skip manual metadata logging at line 1295 since UnionService handled it
        skip_metadata_logging = True
    else:
        # Fallback to direct UnionRepository (v3.0 compatibility)
        timestamp = now_chile()

        if operacion == "ARM":
            updated_count = self.union_repository.batch_update_arm(...)
        elif operacion == "SOLD":
            updated_count = self.union_repository.batch_update_sold(...)

        skip_metadata_logging = False

except Exception as e:
    logger.error(f"Failed to process union selection: {e}")
    raise SheetsUpdateError(...)
```

**Changes at line 1275-1310:**
Wrap metadata logging in conditional to avoid duplicate when UnionService used:

```python
# Step 8: Log appropriate event to Metadata (only if not handled by UnionService)
if not skip_metadata_logging:
    try:
        # ... existing metadata logging code ...
    except Exception as e:
        logger.error(f"❌ CRITICAL: Metadata logging failed: {e}", exc_info=True)
```

**Verification:**
- UnionService.process_selection() called when union_service available
- Direct UnionRepository calls maintained as fallback
- Metadata logging skipped when UnionService handles it

### Task 3: Update router to inject UnionService

**File:** `backend/routers/union_router.py`

**Changes at finalizar endpoint (~line 214):**
1. Import UnionService at top
2. Inject UnionService when creating OccupationService instance

```python
from backend.services.union_service import UnionService

# In finalizar endpoint (around line 270)
occupation_service = OccupationService(
    sheets_repository=sheets_repo,
    metadata_repository=metadata_repo,
    redis_lock_service=redis_service,
    conflict_service=conflict_service,
    validation_service=validation_service,
    union_repository=union_repo,
    union_service=UnionService(
        union_repo=union_repo,
        metadata_repo=metadata_repo
    )  # Add UnionService injection
)
```

**Verification:**
- UnionService imported
- UnionService instance created and passed to OccupationService

### Task 4: Add tests for batch + granular metadata logging

**File:** `tests/unit/test_occupation_service.py`

**New test method:**
```python
async def test_finalizar_logs_batch_and_granular_metadata(self):
    """Verify FINALIZAR logs 1 batch + N granular metadata events."""
    # Arrange
    mock_union_service = MagicMock()
    mock_union_service.process_selection.return_value = {
        "union_count": 3,
        "pulgadas": 18.5,
        "event_count": 4  # 1 batch + 3 granular
    }

    service = OccupationService(
        # ... other deps ...
        union_service=mock_union_service
    )

    # Act
    result = await service.finalizar_spool(
        tag_spool="TEST-01",
        worker_id=93,
        worker_nombre="MR(93)",
        operacion="ARM",
        selected_unions=["OT-123+1", "OT-123+2", "OT-123+3"]
    )

    # Assert
    mock_union_service.process_selection.assert_called_once_with(
        tag_spool="TEST-01",
        union_ids=["OT-123+1", "OT-123+2", "OT-123+3"],
        worker_id=93,
        worker_nombre="MR(93)",
        operacion="ARM"
    )
    # Verify metadata_repository.log_event NOT called (UnionService handles it)
    self.mock_metadata_repo.log_event.assert_not_called()
```

**Verification:**
- Test verifies UnionService.process_selection() called
- Test verifies no duplicate metadata logging
- Test verifies correct parameters passed

### Task 5: Integration test for metadata event count

**File:** `tests/integration/test_union_api_v4.py`

**Add to test_finalizar_workflow_partial (or new test):**
```python
async def test_finalizar_creates_batch_and_granular_events(self):
    """Verify FINALIZAR creates 1 + N metadata events."""
    # This test is marked as skipped since it requires real Sheets
    # Include manual validation steps

    pytest.skip("Manual validation required - see instructions")

    # Manual validation:
    # 1. POST /api/v4/occupation/iniciar with TEST-02
    # 2. POST /api/v4/occupation/finalizar with 3 unions selected
    # 3. Query Metadata sheet - should see 4 new events:
    #    - 1 event with N_UNION = NULL, evento = "PAUSAR_SPOOL"
    #    - 3 events with N_UNION = 1,2,3, evento = "UNION_ARM_REGISTRADA"
```

## Verification Criteria

### must_haves (from Phase 11 goal)
1. **Metadata logging pattern:** FINALIZAR must create 1 + N events
2. **Batch event:** N_UNION = NULL, contains pulgadas in metadata_json
3. **Granular events:** N_UNION = union number for each selected union
4. **No regression:** v3.0 fallback continues to work (single event)

### Test Coverage
- Unit test verifies UnionService.process_selection() called
- Unit test verifies no duplicate metadata logging
- Integration test documents manual validation procedure
- No breaking changes to existing tests

## Success Metrics
- Gap resolved: OccupationService delegates to UnionService for batch + granular logging
- METRIC-03 requirement satisfied (batch event logged)
- METRIC-04 requirement satisfied (granular events logged)
- Metadata sheet shows correct event pattern (1 + N events per FINALIZAR)