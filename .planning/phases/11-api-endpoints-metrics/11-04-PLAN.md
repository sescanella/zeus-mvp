---
wave: 3
depends_on: [11-03]
files_modified:
  - backend/routers/union_router.py
  - backend/models/union_api.py
  - backend/models/occupation.py
  - tests/unit/routers/test_union_router.py
autonomous: true
---

# Plan 11-04: FINALIZAR Workflow Endpoint

## Goal
Implement POST /api/v4/occupation/finalizar endpoint that accepts selected unions array and auto-determines PAUSAR or COMPLETAR

## Context
From CONTEXT.md and Phase 10:
- FINALIZAR payload: selected_unions array (can be empty for cancellation)
- Auto-determines PAUSAR vs COMPLETAR based on selection
- Returns action_taken, unions_processed, pulgadas
- Race condition handling: 409 CONFLICT
- Triggers metrología if 100% complete

Phase 10 already implemented OccupationService.finalizar_spool() with all business logic.

## Tasks

<task>
1. Add FINALIZAR models to backend/models/union_api.py
   - FinalizarRequestV4 with selected_unions array
   - Extend response to include pulgadas field

Code:
```python
from typing import List, Optional

class FinalizarRequestV4(BaseModel):
    """v4.0 FINALIZAR request with union selection"""
    tag_spool: str = Field(..., description="Spool TAG identifier")
    worker_id: int = Field(..., description="Worker ID number")
    operacion: ActionType = Field(..., description="ARM or SOLD operation")
    selected_unions: List[str] = Field(
        default_factory=list,
        description="List of union IDs to complete (empty = cancellation)"
    )

class FinalizarResponseV4(BaseModel):
    """v4.0 FINALIZAR response with metrics"""
    success: bool
    tag_spool: str
    message: str
    action_taken: str = Field(..., description="PAUSAR, COMPLETAR, or CANCELADO")
    unions_processed: int = Field(..., description="Number of unions processed")
    pulgadas: Optional[float] = Field(None, description="Total pulgadas-diámetro processed")
    metrologia_triggered: bool = Field(False, description="Whether auto-transition occurred")
    new_state: Optional[str] = Field(None, description="New state after transition")
```

Success: Models support complete FINALIZAR response
</task>

<task>
2. Update backend/models/occupation.py to add pulgadas field
   - Add pulgadas as optional field to OccupationResponse
   - Maintain backward compatibility (optional field)

Code:
```python
class OccupationResponse(BaseModel):
    """Response for occupation operations"""
    success: bool
    tag_spool: str
    message: str
    action_taken: Optional[str] = None
    unions_processed: Optional[int] = None
    pulgadas: Optional[float] = Field(None, description="Total pulgadas-diámetro (v4.0)")  # NEW
    metrologia_triggered: Optional[bool] = None
    new_state: Optional[str] = None
```

Success: OccupationResponse supports pulgadas field
</task>

<task>
3. Add FINALIZAR endpoint to backend/routers/union_router.py
   - POST /occupation/finalizar
   - Version detection
   - Call OccupationService.finalizar_spool()
   - Handle race conditions (409)

Code:
```python
from backend.models.occupation import FinalizarRequest  # Phase 10 model
from backend.exceptions import SpoolNoEncontradoError

@router.post("/occupation/finalizar", response_model=FinalizarResponseV4)
async def finalizar_v4(
    request: FinalizarRequestV4,
    occupation_service: OccupationService = Depends(get_occupation_service),
    sheets_repo: SheetsRepository = Depends(get_sheets_repository),
    worker_repo: WorkerRepository = Depends(get_worker_repository)
):
    """v4.0 FINALIZAR - Process selected unions and auto-determine action"""

    # 1. Version detection
    spool = sheets_repo.get_spool_by_tag(request.tag_spool)
    if not spool:
        raise HTTPException(status_code=404, detail=f"Spool {request.tag_spool} not found")

    if not is_v4_spool(spool):
        raise HTTPException(
            status_code=400,
            detail={
                "error": "WRONG_VERSION",
                "message": "Spool is v3.0, use /api/v3/occupation/completar instead",
                "spool_version": "v3.0",
                "correct_endpoint": "/api/v3/occupation/completar"
            }
        )

    # 2. Derive worker_nombre
    worker = worker_repo.get_worker_by_id(request.worker_id)
    if not worker:
        raise HTTPException(status_code=404, detail=f"Worker {request.worker_id} not found")

    worker_nombre = f"{worker['Apellido']}({request.worker_id})"

    # 3. Build Phase 10 request
    finalizar_request = FinalizarRequest(
        tag_spool=request.tag_spool,
        worker_id=request.worker_id,
        worker_nombre=worker_nombre,
        operacion=request.operacion,
        selected_unions=request.selected_unions
    )

    # 4. Call service layer
    try:
        result = await occupation_service.finalizar_spool(finalizar_request)

        # Extract metrics from result
        action = result.get("action_taken", "UNKNOWN")
        unions_count = result.get("unions_processed", 0)
        pulgadas = result.get("pulgadas")  # May be None

        # Build message based on action
        if action == "CANCELADO":
            message = f"Trabajo cancelado - sin uniones seleccionadas"
        elif action == "PAUSAR":
            message = f"Trabajo pausado - {unions_count} uniones procesadas"
        else:  # COMPLETAR
            message = f"Operación completada - {unions_count} uniones procesadas"
            if result.get("metrologia_triggered"):
                message += " (Listo para metrología)"

        return FinalizarResponseV4(
            success=True,
            tag_spool=request.tag_spool,
            message=message,
            action_taken=action,
            unions_processed=unions_count,
            pulgadas=pulgadas,
            metrologia_triggered=result.get("metrologia_triggered", False),
            new_state=result.get("new_state")
        )

    except ValueError as e:
        # Race condition: selected > disponibles
        if "more unions than available" in str(e):
            raise HTTPException(
                status_code=409,
                detail={
                    "error": "RACE_CONDITION",
                    "message": "Some unions no longer available (completed by another worker)",
                    "detail": str(e)
                }
            )
        raise

    except NoAutorizadoError as e:
        raise HTTPException(
            status_code=403,
            detail={
                "error": "NO_AUTORIZADO",
                "message": "Worker doesn't own this spool"
            }
        )
```

Success: FINALIZAR endpoint complete with race condition handling
</task>

<task>
4. Add comprehensive tests for FINALIZAR
   - Test PAUSAR (partial completion)
   - Test COMPLETAR (full completion)
   - Test CANCELADO (zero unions)
   - Test race condition (409)
   - Test not owner (403)
   - Test metrología trigger

Test cases:
```python
def test_finalizar_pausar_partial():
    """Partial selection results in PAUSAR"""
    # Setup: INICIAR first
    client.post("/api/v4/occupation/iniciar", json={...})

    # FINALIZAR with 3 of 10 unions
    response = client.post("/api/v4/occupation/finalizar", json={
        "tag_spool": "TEST-02",
        "worker_id": 93,
        "operacion": "ARM",
        "selected_unions": ["TEST-02+1", "TEST-02+2", "TEST-02+3"]
    })
    assert response.status_code == 200
    data = response.json()
    assert data["action_taken"] == "PAUSAR"
    assert data["unions_processed"] == 3
    assert data["pulgadas"] > 0

def test_finalizar_completar_full():
    """Full selection results in COMPLETAR"""
    # Select all 10 unions
    response = client.post("/api/v4/occupation/finalizar", json={
        "tag_spool": "TEST-02",
        "worker_id": 93,
        "operacion": "ARM",
        "selected_unions": [f"TEST-02+{i}" for i in range(1, 11)]
    })
    assert response.status_code == 200
    data = response.json()
    assert data["action_taken"] == "COMPLETAR"
    assert data["unions_processed"] == 10

def test_finalizar_cancelado_zero():
    """Zero unions results in CANCELADO"""
    response = client.post("/api/v4/occupation/finalizar", json={
        "tag_spool": "TEST-02",
        "worker_id": 93,
        "operacion": "ARM",
        "selected_unions": []
    })
    assert response.status_code == 200
    data = response.json()
    assert data["action_taken"] == "CANCELADO"
    assert data["unions_processed"] == 0

def test_finalizar_race_condition():
    """Selected > disponibles returns 409"""
    # Attempt to select unavailable union
    response = client.post("/api/v4/occupation/finalizar", json={
        "tag_spool": "TEST-02",
        "worker_id": 93,
        "operacion": "SOLD",  # Try SOLD on ARM-incomplete union
        "selected_unions": ["TEST-02+999"]  # Non-existent
    })
    assert response.status_code == 409
    detail = response.json()["detail"]
    assert detail["error"] == "RACE_CONDITION"
```

Success: All FINALIZAR scenarios tested
</task>

## Verification

<verification>
1. Run FINALIZAR tests
   ```bash
   pytest tests/unit/routers/test_union_router.py::test_finalizar -v
   ```

2. Manual end-to-end test
   ```bash
   # Step 1: INICIAR
   curl -X POST http://localhost:8000/api/v4/occupation/iniciar \
     -H "Content-Type: application/json" \
     -d '{"tag_spool": "TEST-02", "worker_id": 93, "operacion": "ARM"}'

   # Step 2: Query disponibles
   curl http://localhost:8000/api/v4/uniones/TEST-02/disponibles?operacion=ARM

   # Step 3: FINALIZAR with partial selection
   curl -X POST http://localhost:8000/api/v4/occupation/finalizar \
     -H "Content-Type: application/json" \
     -d '{
       "tag_spool": "TEST-02",
       "worker_id": 93,
       "operacion": "ARM",
       "selected_unions": ["TEST-02+1", "TEST-02+2", "TEST-02+3"]
     }'

   # Expected response:
   # {
   #   "success": true,
   #   "tag_spool": "TEST-02",
   #   "message": "Trabajo pausado - 3 uniones procesadas",
   #   "action_taken": "PAUSAR",
   #   "unions_processed": 3,
   #   "pulgadas": 16.5,
   #   "metrologia_triggered": false
   # }
   ```

3. Verify Metadata events
   - Check Metadata sheet for batch event (SPOOL_ARM_PAUSADO)
   - Check for N granular events (UNION_ARM_REGISTRADA)
   - Verify pulgadas recorded in events

4. Test cancellation flow
   ```bash
   curl -X POST http://localhost:8000/api/v4/occupation/finalizar \
     -H "Content-Type: application/json" \
     -d '{
       "tag_spool": "TEST-02",
       "worker_id": 93,
       "operacion": "ARM",
       "selected_unions": []
     }'
   # Should log SPOOL_CANCELADO event
   ```
</verification>

## must_haves
- [ ] POST /api/v4/occupation/finalizar endpoint functional
- [ ] Auto-determination works (PAUSAR vs COMPLETAR vs CANCELADO)
- [ ] Pulgadas included in response
- [ ] Race conditions return 409 CONFLICT
- [ ] Metadata logs batch + granular events

## Requirements Addressed
- **API-05**: POST /api/occupation/finalizar - auto-determines PAUSAR/COMPLETAR ✓
- **METRIC-03**: Metadata logs SPOOL_ARM_PAUSADO event (via Phase 10 service) ✓
- **METRIC-04**: Metadata logs SPOOL_ARM_COMPLETADO event (via Phase 10 service) ✓
- **METRIC-05**: Metadata logs SPOOL_SOLD_PAUSADO and SPOOL_SOLD_COMPLETADO events ✓
- **METRIC-06**: Metadata logs SPOOL_CANCELADO event when 0 unions selected ✓
- **METRIC-07**: Metadata logs granular UNION_ARM_REGISTRADA event per union ✓
- **METRIC-08**: Metadata logs granular UNION_SOLD_REGISTRADA event per union ✓
- **METRIC-09**: Each FINALIZAR logs 1 batch + N granular events ✓