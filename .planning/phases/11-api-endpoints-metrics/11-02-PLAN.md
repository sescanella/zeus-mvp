---
wave: 2
depends_on: [11-01]
files_modified:
  - backend/routers/union_router.py (new)
  - backend/models/union_api.py (new)
  - backend/main.py
  - tests/unit/routers/test_union_router.py (new)
autonomous: true
---

# Plan 11-02: Union Query Endpoints

## Goal
Implement read-only union query endpoints for disponibles and metricas, establishing the v4.0 API foundation

## Context
From CONTEXT.md and research:
- Union queries under `/api/v4/uniones/{tag}/...` path structure
- Disponibles response: core fields only (id, n_union, dn_union, tipo_union)
- Metricas: 5 fields with 2 decimal precision for pulgadas
- No caching initially (always-fresh reads from Phase 10 D33)

These endpoints provide the data foundation for frontend union selection (Phase 12).

## Tasks

<task>
1. Create backend/models/union_api.py with response models
   - DisponiblesResponse with unions list
   - MetricasResponse with 5 required fields
   - UnionSummary for disponibles items

Code:
```python
from pydantic import BaseModel, Field
from typing import List

class UnionSummary(BaseModel):
    """Minimal union data for disponibles query"""
    id: str = Field(..., description="Composite ID: TAG_SPOOL+N_UNION")
    n_union: int = Field(..., description="Union number (1-20)")
    dn_union: float = Field(..., description="Diameter in inches")
    tipo_union: str = Field(..., description="Union type: BW, BR, SO, FW, etc.")

class DisponiblesResponse(BaseModel):
    """Response for disponibles unions query"""
    tag_spool: str
    operacion: str  # ARM or SOLD
    unions: List[UnionSummary]
    count: int = Field(..., description="Total available unions")

class MetricasResponse(BaseModel):
    """Spool-level metrics (5 fields per success criteria)"""
    tag_spool: str
    total_uniones: int
    arm_completadas: int
    sold_completadas: int
    pulgadas_arm: float = Field(..., description="2 decimal precision")
    pulgadas_sold: float = Field(..., description="2 decimal precision")
```

Success: Models match CONTEXT.md specifications exactly
</task>

<task>
2. Create backend/routers/union_router.py with query endpoints
   - GET /uniones/{tag}/disponibles?operacion=ARM|SOLD
   - GET /uniones/{tag}/metricas
   - Use dependency injection for repositories
   - Include proper error handling

Code structure:
```python
from fastapi import APIRouter, Depends, HTTPException, Query
from backend.models.union_api import DisponiblesResponse, MetricasResponse
from backend.repositories.union_repository import UnionRepository
from backend.repositories.sheets_repository import SheetsRepository
from backend.core.dependency import get_union_repository, get_sheets_repository

router = APIRouter()

@router.get("/uniones/{tag}/disponibles", response_model=DisponiblesResponse)
async def get_disponibles(
    tag: str,
    operacion: str = Query(..., regex="^(ARM|SOLD)$"),
    union_repo: UnionRepository = Depends(get_union_repository),
    sheets_repo: SheetsRepository = Depends(get_sheets_repository)
):
    # Get spool to extract OT
    spool = sheets_repo.get_spool_by_tag(tag)
    if not spool:
        raise HTTPException(status_code=404, detail=f"Spool {tag} not found")

    # Get available unions based on operation
    if operacion == "ARM":
        unions = union_repo.get_disponibles_arm_by_ot(spool["OT"])
    else:  # SOLD
        unions = union_repo.get_disponibles_sold_by_ot(spool["OT"])

    # Build response with core fields only
    return DisponiblesResponse(
        tag_spool=tag,
        operacion=operacion,
        unions=[UnionSummary(...) for u in unions],
        count=len(unions)
    )

@router.get("/uniones/{tag}/metricas", response_model=MetricasResponse)
async def get_metricas(
    tag: str,
    union_repo: UnionRepository = Depends(get_union_repository)
):
    # Always-fresh calculation from Uniones sheet
    unions = union_repo.get_by_spool(tag)
    if not unions:
        raise HTTPException(status_code=404, detail=f"No unions found for spool {tag}")

    # Calculate metrics
    total = len(unions)
    arm_completadas = sum(1 for u in unions if u.arm_fecha_fin)
    sold_completadas = sum(1 for u in unions if u.sol_fecha_fin)
    pulgadas_arm = round(sum(u.dn_union for u in unions if u.arm_fecha_fin), 2)
    pulgadas_sold = round(sum(u.dn_union for u in unions if u.sol_fecha_fin), 2)

    return MetricasResponse(...)
```

Success: Endpoints return correct data structure
</task>

<task>
3. Register router in backend/main.py
   - Import union_router
   - Include with /api/v4 prefix
   - Add v4-unions tag

Code:
```python
from backend.routers import union_router

# v4.0 union endpoints
app.include_router(union_router.router, prefix="/api/v4", tags=["v4-unions"])
```

Success: v4.0 endpoints accessible at /api/v4/uniones/*
</task>

<task>
4. Create comprehensive tests
   - tests/unit/routers/test_union_router.py
   - Test disponibles ARM filtering
   - Test disponibles SOLD filtering (ARM-completed only)
   - Test metricas calculation with 2 decimal precision
   - Test 404 errors for missing spools
   - Test 400 for invalid operacion

Test cases:
```python
def test_disponibles_arm_returns_incomplete():
    """ARM returns unions where ARM_FECHA_FIN is NULL"""

def test_disponibles_sold_requires_arm_complete():
    """SOLD returns only unions where ARM_FECHA_FIN is NOT NULL"""

def test_metricas_2_decimal_precision():
    """Pulgadas values have exactly 2 decimal places"""
    response = client.get("/api/v4/uniones/TEST-01/metricas")
    data = response.json()
    assert data["pulgadas_arm"] == 18.50  # Not 18.5

def test_disponibles_404_spool_not_found():
    """Returns 404 when spool doesn't exist"""

def test_disponibles_400_invalid_operacion():
    """Returns 400 for operacion != ARM|SOLD"""
```

Success: All query tests pass
</task>

## Verification

<verification>
1. Run router tests
   ```bash
   pytest tests/unit/routers/test_union_router.py -v
   ```

2. Manual API testing
   ```bash
   # Test disponibles for ARM
   curl http://localhost:8000/api/v4/uniones/TEST-02/disponibles?operacion=ARM

   # Expected response format:
   # {
   #   "tag_spool": "TEST-02",
   #   "operacion": "ARM",
   #   "unions": [
   #     {"id": "TEST-02+1", "n_union": 1, "dn_union": 6.0, "tipo_union": "BW"},
   #     {"id": "TEST-02+2", "n_union": 2, "dn_union": 4.5, "tipo_union": "FW"}
   #   ],
   #   "count": 2
   # }

   # Test metricas
   curl http://localhost:8000/api/v4/uniones/TEST-02/metricas

   # Expected response format:
   # {
   #   "tag_spool": "TEST-02",
   #   "total_uniones": 10,
   #   "arm_completadas": 7,
   #   "sold_completadas": 5,
   #   "pulgadas_arm": 18.50,
   #   "pulgadas_sold": 12.75
   # }
   ```

3. Check API documentation
   - Visit http://localhost:8000/docs
   - Find v4-unions tag
   - Test endpoints through Swagger UI
   - Verify response schemas match specifications
</verification>

## must_haves
- [ ] GET /api/v4/uniones/{tag}/disponibles works with ARM and SOLD filters
- [ ] GET /api/v4/uniones/{tag}/metricas returns 5 required fields
- [ ] Pulgadas values have 2 decimal precision (18.50, not 18.5)
- [ ] 404 returned for non-existent spools
- [ ] Response models match CONTEXT.md specifications exactly

## Requirements Addressed
- **API-01**: GET disponibles?operacion=ARM returns unions where ARM_FECHA_FIN IS NULL ✓
- **API-02**: GET disponibles?operacion=SOLD returns unions where ARM_FECHA_FIN IS NOT NULL AND SOL_FECHA_FIN IS NULL ✓
- **API-03**: GET metricas returns {total_uniones, arm_completadas, sold_completadas, pulgadas_arm, pulgadas_sold} ✓
- **METRIC-01**: Pulgadas-diámetro in metrics response (foundation for dashboard display) ✓
- **METRIC-02**: Performance calculation support (pulgadas data available) ✓