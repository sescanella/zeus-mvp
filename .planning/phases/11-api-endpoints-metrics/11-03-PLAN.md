---
wave: 2
depends_on: [11-01]
files_modified:
  - backend/routers/union_router.py
  - backend/models/union_api.py
  - backend/core/dependency.py
  - tests/unit/routers/test_union_router.py
autonomous: true
---

# Plan 11-03: INICIAR Workflow Endpoint

## Goal
Implement POST /api/v4/occupation/iniciar endpoint that occupies spool with Redis lock without modifying Uniones sheet

## Context
From CONTEXT.md and Phase 10:
- INICIAR payload: minimal fields (tag_spool, worker_id, operacion)
- worker_nombre can be derived from backend lookup
- Must reject v3.0 spools (400 Bad Request)
- ARM prerequisite validation for SOLD (403 Forbidden)
- Uses OccupationService.iniciar_spool() from Phase 10

## Tasks

<task>
1. Add INICIAR request/response models to backend/models/union_api.py
   - IniciarRequestV4 with minimal fields
   - IniciarResponseV4 for success/error responses
   - Reuse OccupationResponse if appropriate

Code:
```python
from pydantic import BaseModel, Field
from enum import Enum

class ActionType(str, Enum):
    ARM = "ARM"
    SOLD = "SOLD"

class IniciarRequestV4(BaseModel):
    """v4.0 INICIAR request - minimal fields"""
    tag_spool: str = Field(..., description="Spool TAG identifier")
    worker_id: int = Field(..., description="Worker ID number")
    operacion: ActionType = Field(..., description="ARM or SOLD operation")
    # Note: worker_nombre derived by backend

class IniciarResponseV4(BaseModel):
    """v4.0 INICIAR response"""
    success: bool
    tag_spool: str
    message: str
    worker_nombre: str = Field(None, description="Derived worker name")
    error_code: str = Field(None, description="Error code if failed")
```

Success: Models support minimal payload per CONTEXT.md
</task>

<task>
2. Add INICIAR endpoint to backend/routers/union_router.py
   - POST /occupation/iniciar
   - Version detection (reject v3.0 spools)
   - Worker name lookup
   - Call OccupationService.iniciar_spool()

Code:
```python
from backend.services.occupation_service import OccupationService
from backend.repositories.worker_repository import WorkerRepository
from backend.utils.version_detection import is_v4_spool
from backend.models.occupation import IniciarRequest  # Phase 10 model
from backend.exceptions import ArmPrerequisiteError, NoAutorizadoError

@router.post("/occupation/iniciar", response_model=IniciarResponseV4)
async def iniciar_v4(
    request: IniciarRequestV4,
    occupation_service: OccupationService = Depends(get_occupation_service),
    sheets_repo: SheetsRepository = Depends(get_sheets_repository),
    worker_repo: WorkerRepository = Depends(get_worker_repository)
):
    """v4.0 INICIAR - Occupy spool without touching unions"""

    # 1. Version detection
    spool = sheets_repo.get_spool_by_tag(request.tag_spool)
    if not spool:
        raise HTTPException(status_code=404, detail=f"Spool {request.tag_spool} not found")

    if not is_v4_spool(spool):
        raise HTTPException(
            status_code=400,
            detail={
                "error": "WRONG_VERSION",
                "message": "Spool is v3.0, use /api/v3/occupation/tomar instead",
                "spool_version": "v3.0",
                "correct_endpoint": "/api/v3/occupation/tomar"
            }
        )

    # 2. Derive worker_nombre
    worker = worker_repo.get_worker_by_id(request.worker_id)
    if not worker:
        raise HTTPException(status_code=404, detail=f"Worker {request.worker_id} not found")

    worker_nombre = f"{worker['Apellido']}({request.worker_id})"

    # 3. Build Phase 10 request
    iniciar_request = IniciarRequest(
        tag_spool=request.tag_spool,
        worker_id=request.worker_id,
        worker_nombre=worker_nombre,
        operacion=request.operacion
    )

    # 4. Call service layer
    try:
        result = await occupation_service.iniciar_spool(iniciar_request)
        return IniciarResponseV4(
            success=True,
            tag_spool=request.tag_spool,
            message=f"Spool {request.tag_spool} iniciado por {worker_nombre}",
            worker_nombre=worker_nombre
        )
    except ArmPrerequisiteError as e:
        raise HTTPException(
            status_code=403,
            detail={
                "error": "ARM_PREREQUISITE",
                "message": str(e)
            }
        )
    except NoAutorizadoError as e:
        raise HTTPException(
            status_code=403,
            detail={
                "error": "NO_AUTORIZADO",
                "message": str(e)
            }
        )
```

Success: Endpoint integrates with Phase 10 service layer
</task>

<task>
3. Update backend/core/dependency.py if needed
   - Add get_worker_repository if missing
   - Ensure all dependencies are available

Code to add if missing:
```python
def get_worker_repository():
    """Dependency for worker repository"""
    return WorkerRepository(get_sheets_service())
```

Success: All required dependencies available
</task>

<task>
4. Add comprehensive tests for INICIAR
   - Test v4.0 spool success
   - Test v3.0 spool rejection (400)
   - Test ARM prerequisite failure for SOLD (403)
   - Test worker not found (404)
   - Test spool not found (404)

Test cases:
```python
def test_iniciar_v4_success_arm():
    """v4.0 spool ARM occupation succeeds"""
    response = client.post("/api/v4/occupation/iniciar", json={
        "tag_spool": "TEST-02",  # v4.0 spool with unions
        "worker_id": 93,
        "operacion": "ARM"
    })
    assert response.status_code == 200
    data = response.json()
    assert data["success"] is True
    assert "MR(93)" in data["worker_nombre"]

def test_iniciar_v3_spool_rejected():
    """v3.0 spool returns 400 with helpful error"""
    response = client.post("/api/v4/occupation/iniciar", json={
        "tag_spool": "OLD-SPOOL",  # v3.0 spool (Total_Uniones = 0)
        "worker_id": 93,
        "operacion": "ARM"
    })
    assert response.status_code == 400
    detail = response.json()["detail"]
    assert detail["error"] == "WRONG_VERSION"
    assert "/api/v3/occupation/tomar" in detail["correct_endpoint"]

def test_iniciar_sold_requires_arm():
    """SOLD without ARM completion returns 403"""
    response = client.post("/api/v4/occupation/iniciar", json={
        "tag_spool": "NO-ARM-SPOOL",
        "worker_id": 93,
        "operacion": "SOLD"
    })
    assert response.status_code == 403
    detail = response.json()["detail"]
    assert detail["error"] == "ARM_PREREQUISITE"
```

Success: All INICIAR tests pass
</task>

## Verification

<verification>
1. Run INICIAR tests
   ```bash
   pytest tests/unit/routers/test_union_router.py::test_iniciar -v
   ```

2. Manual API testing
   ```bash
   # Test v4.0 spool INICIAR
   curl -X POST http://localhost:8000/api/v4/occupation/iniciar \
     -H "Content-Type: application/json" \
     -d '{"tag_spool": "TEST-02", "worker_id": 93, "operacion": "ARM"}'

   # Expected success response:
   # {
   #   "success": true,
   #   "tag_spool": "TEST-02",
   #   "message": "Spool TEST-02 iniciado por MR(93)",
   #   "worker_nombre": "MR(93)"
   # }

   # Test v3.0 spool rejection
   curl -X POST http://localhost:8000/api/v4/occupation/iniciar \
     -H "Content-Type: application/json" \
     -d '{"tag_spool": "OLD-SPOOL", "worker_id": 93, "operacion": "ARM"}'

   # Expected 400 response:
   # {
   #   "detail": {
   #     "error": "WRONG_VERSION",
   #     "message": "Spool is v3.0, use /api/v3/occupation/tomar instead",
   #     "spool_version": "v3.0",
   #     "correct_endpoint": "/api/v3/occupation/tomar"
   #   }
   # }
   ```

3. Check Redis lock creation
   ```bash
   redis-cli GET "spool:TEST-02:lock"
   # Should show lock data with worker info
   ```

4. Verify Operaciones sheet update
   - Check Ocupado_Por column shows worker
   - Check Fecha_Ocupacion has timestamp
   - Confirm Uniones sheet NOT modified
</verification>

## must_haves
- [ ] POST /api/v4/occupation/iniciar endpoint functional
- [ ] v3.0 spools rejected with 400 and helpful message
- [ ] ARM prerequisite enforced for SOLD (403 if not met)
- [ ] Worker name derived from worker_id lookup
- [ ] Redis lock acquired without modifying Uniones sheet

## Requirements Addressed
- **API-04**: POST /api/occupation/iniciar - body: {tag_spool, worker_id, operacion} - occupies spool only âœ“