---
wave: 3
depends_on: [11-02, 11-03, 11-04]
files_modified:
  - tests/integration/test_union_api_v4.py (new)
  - tests/integration/test_api_versioning.py (new)
  - backend/routers/union_router.py
autonomous: true
---

# Plan 11-05: Integration Tests & Validation

## Goal
Comprehensive integration testing and performance validation to ensure v4.0 API meets all requirements and maintains v3.0 compatibility

## Context
This is the final plan for Phase 11. We need to:
- Validate end-to-end workflows
- Test version detection and routing
- Verify performance requirements (< 1s for 10 unions)
- Ensure backward compatibility
- Validate error handling and edge cases

## Tasks

<task>
1. Create tests/integration/test_union_api_v4.py with workflow tests
   - End-to-end INICIAR → FINALIZAR flows
   - Race condition scenarios
   - Metrología auto-trigger
   - Performance validation

Code:
```python
import pytest
import time
from fastapi.testclient import TestClient

class TestUnionAPIV4Workflows:
    """Integration tests for v4.0 union API workflows"""

    def test_iniciar_finalizar_pausar_flow(self, client):
        """Complete workflow: INICIAR → partial selection → PAUSAR"""
        # 1. INICIAR
        response = client.post("/api/v4/occupation/iniciar", json={
            "tag_spool": "TEST-02",
            "worker_id": 93,
            "operacion": "ARM"
        })
        assert response.status_code == 200

        # 2. Query disponibles
        response = client.get("/api/v4/uniones/TEST-02/disponibles?operacion=ARM")
        assert response.status_code == 200
        disponibles = response.json()["unions"]
        assert len(disponibles) > 3

        # 3. FINALIZAR with partial selection
        selected = [u["id"] for u in disponibles[:3]]
        response = client.post("/api/v4/occupation/finalizar", json={
            "tag_spool": "TEST-02",
            "worker_id": 93,
            "operacion": "ARM",
            "selected_unions": selected
        })
        assert response.status_code == 200
        data = response.json()
        assert data["action_taken"] == "PAUSAR"
        assert data["unions_processed"] == 3
        assert data["pulgadas"] > 0

    def test_iniciar_finalizar_completar_flow(self, client):
        """Complete workflow: INICIAR → full selection → COMPLETAR"""
        # Similar structure, select all unions
        # Verify COMPLETAR action

    def test_sold_requires_arm_prerequisite(self, client):
        """SOLD operation requires ARM unions to be complete"""
        # 1. Try INICIAR SOLD on fresh spool (should fail)
        response = client.post("/api/v4/occupation/iniciar", json={
            "tag_spool": "NO-ARM-SPOOL",
            "worker_id": 93,
            "operacion": "SOLD"
        })
        assert response.status_code == 403
        assert "ARM_PREREQUISITE" in response.json()["detail"]["error"]

        # 2. Complete ARM first
        # 3. Then SOLD should work

    def test_metrologia_auto_trigger(self, client):
        """100% completion triggers metrología transition"""
        # Complete all ARM unions
        # Then complete all SOLD unions
        # Verify metrologia_triggered = true

    def test_performance_10_unions_under_1s(self, client):
        """PERF-02: 10-union operation completes in < 1s"""
        # INICIAR
        client.post("/api/v4/occupation/iniciar", json={...})

        # Select 10 unions
        unions = [f"TEST-02+{i}" for i in range(1, 11)]

        start = time.time()
        response = client.post("/api/v4/occupation/finalizar", json={
            "tag_spool": "TEST-02",
            "worker_id": 93,
            "operacion": "ARM",
            "selected_unions": unions
        })
        duration = time.time() - start

        assert response.status_code == 200
        assert duration < 1.0, f"Operation took {duration:.2f}s, exceeds 1s target"

    def test_race_condition_handling(self, client):
        """Concurrent workers cause race condition"""
        # Setup: Worker 1 initiates
        # Worker 2 completes some unions
        # Worker 1 tries to select now-unavailable unions
        # Verify 409 CONFLICT response
```

Success: Workflow tests cover all major scenarios
</task>

<task>
2. Create tests/integration/test_api_versioning.py for version routing
   - v3.0 spools use v3.0 endpoints
   - v4.0 spools use v4.0 endpoints
   - Cross-version rejection tests

Code:
```python
class TestAPIVersioning:
    """Test version detection and routing"""

    def test_v3_spool_rejects_v4_endpoint(self, client, v3_spool):
        """v3.0 spool calling v4.0 endpoint returns 400"""
        response = client.post("/api/v4/occupation/iniciar", json={
            "tag_spool": v3_spool["TAG_SPOOL"],  # Total_Uniones = 0
            "worker_id": 93,
            "operacion": "ARM"
        })
        assert response.status_code == 400
        detail = response.json()["detail"]
        assert detail["error"] == "WRONG_VERSION"
        assert "/api/v3/occupation/tomar" in detail["correct_endpoint"]

    def test_v4_spool_accepts_v4_endpoint(self, client, v4_spool):
        """v4.0 spool works with v4.0 endpoint"""
        response = client.post("/api/v4/occupation/iniciar", json={
            "tag_spool": v4_spool["TAG_SPOOL"],  # Total_Uniones > 0
            "worker_id": 93,
            "operacion": "ARM"
        })
        assert response.status_code == 200

    def test_v3_endpoints_still_functional(self, client):
        """v3.0 endpoints work at new /api/v3/ prefix"""
        response = client.post("/api/v3/occupation/tomar", json={
            "tag_spool": "TEST-01",
            "worker_id": 93,
            "worker_nombre": "MR(93)",
            "operacion": "ARM"
        })
        assert response.status_code in [200, 409]  # Success or already occupied

    def test_legacy_endpoints_still_work(self, client):
        """Legacy /api/occupation/* paths still functional"""
        response = client.post("/api/occupation/tomar", json={
            "tag_spool": "TEST-01",
            "worker_id": 93,
            "worker_nombre": "MR(93)",
            "operacion": "ARM"
        })
        assert response.status_code in [200, 409]
```

Success: Version routing validated
</task>

<task>
3. Add error scenario tests to union_router.py tests
   - Missing required fields (422)
   - Invalid operacion values (400)
   - Non-existent spools (404)
   - Ownership violations (403)

Code additions:
```python
def test_finalizar_not_owner(self, client):
    """Worker doesn't own spool returns 403"""
    # Worker 1 initiates
    client.post("/api/v4/occupation/iniciar", json={
        "tag_spool": "TEST-02",
        "worker_id": 93,
        "operacion": "ARM"
    })

    # Worker 2 tries to finalize
    response = client.post("/api/v4/occupation/finalizar", json={
        "tag_spool": "TEST-02",
        "worker_id": 94,  # Different worker
        "operacion": "ARM",
        "selected_unions": ["TEST-02+1"]
    })
    assert response.status_code == 403
    assert "NO_AUTORIZADO" in response.json()["detail"]["error"]

def test_invalid_operacion_value(self, client):
    """Invalid operacion returns 422 validation error"""
    response = client.post("/api/v4/occupation/iniciar", json={
        "tag_spool": "TEST-02",
        "worker_id": 93,
        "operacion": "INVALID"  # Not ARM or SOLD
    })
    assert response.status_code == 422
    errors = response.json()["detail"]
    assert any("operacion" in str(e) for e in errors)

def test_disponibles_invalid_operacion(self, client):
    """Query param validation for operacion"""
    response = client.get("/api/v4/uniones/TEST-02/disponibles?operacion=INVALID")
    assert response.status_code == 422  # Query validation
```

Success: Error scenarios covered
</task>

<task>
4. Create manual validation checklist
   - Document manual testing procedures
   - Include curl commands for each scenario
   - Add to phase documentation

Create file: .planning/phases/11-api-endpoints-metrics/MANUAL_VALIDATION.md

Content:
```markdown
# Phase 11: Manual Validation Checklist

## Prerequisites
- Backend running: `uvicorn main:app --reload --port 8000`
- Redis available
- Test spools prepared (v3.0 and v4.0)

## v4.0 Workflow Tests

### 1. INICIAR Success
```bash
curl -X POST http://localhost:8000/api/v4/occupation/iniciar \
  -H "Content-Type: application/json" \
  -d '{"tag_spool": "TEST-02", "worker_id": 93, "operacion": "ARM"}'
```
- [ ] Returns 200 with success message
- [ ] Redis lock created
- [ ] Operaciones.Ocupado_Por updated

### 2. Query Disponibles
```bash
curl http://localhost:8000/api/v4/uniones/TEST-02/disponibles?operacion=ARM
```
- [ ] Returns list of available unions
- [ ] Only incomplete unions shown for ARM
- [ ] Only ARM-complete unions shown for SOLD

### 3. FINALIZAR Partial (PAUSAR)
```bash
curl -X POST http://localhost:8000/api/v4/occupation/finalizar \
  -H "Content-Type: application/json" \
  -d '{
    "tag_spool": "TEST-02",
    "worker_id": 93,
    "operacion": "ARM",
    "selected_unions": ["TEST-02+1", "TEST-02+2"]
  }'
```
- [ ] Returns action_taken: "PAUSAR"
- [ ] Pulgadas calculated correctly
- [ ] Metadata events logged

### 4. Query Metrics
```bash
curl http://localhost:8000/api/v4/uniones/TEST-02/metricas
```
- [ ] Returns 5 fields exactly
- [ ] Pulgadas have 2 decimal precision (18.50)
- [ ] Counts match actual union states

## Version Detection Tests

### 5. v3.0 Spool Rejection
```bash
# Try v4.0 endpoint on v3.0 spool
curl -X POST http://localhost:8000/api/v4/occupation/iniciar \
  -H "Content-Type: application/json" \
  -d '{"tag_spool": "OLD-SPOOL", "worker_id": 93, "operacion": "ARM"}'
```
- [ ] Returns 400 Bad Request
- [ ] Error message suggests /api/v3/occupation/tomar

### 6. v3.0 Endpoints Still Work
```bash
curl -X POST http://localhost:8000/api/v3/occupation/tomar \
  -H "Content-Type: application/json" \
  -d '{"tag_spool": "OLD-SPOOL", "worker_id": 93, "worker_nombre": "MR(93)", "operacion": "ARM"}'
```
- [ ] v3.0 endpoints functional at new prefix

## Performance Test

### 7. 10-Union Operation
```bash
time curl -X POST http://localhost:8000/api/v4/occupation/finalizar \
  -H "Content-Type: application/json" \
  -d '{
    "tag_spool": "TEST-02",
    "worker_id": 93,
    "operacion": "ARM",
    "selected_unions": ["TEST-02+1", "TEST-02+2", ..., "TEST-02+10"]
  }'
```
- [ ] Completes in < 1 second
- [ ] All unions processed successfully
```

Success: Manual validation guide created
</task>

## Verification

<verification>
1. Run all integration tests
   ```bash
   # New v4.0 integration tests
   pytest tests/integration/test_union_api_v4.py -v

   # Version routing tests
   pytest tests/integration/test_api_versioning.py -v

   # All router tests
   pytest tests/unit/routers/ -v

   # Full test suite
   pytest tests/ -v --tb=short
   ```

2. Check test coverage
   ```bash
   pytest --cov=backend/routers/union_router tests/
   pytest --cov=backend/routers/occupation_v3 tests/
   ```

3. API documentation review
   - Visit http://localhost:8000/docs
   - Check v3-occupation tag (relocated endpoints)
   - Check v4-unions tag (new endpoints)
   - Test each endpoint through Swagger UI

4. Performance validation
   ```bash
   # Use the manual test script with timing
   time ./test_10_union_performance.sh
   ```

5. Review logs for errors
   ```bash
   tail -f logs/app.log | grep ERROR
   ```
</verification>

## must_haves
- [ ] All v4.0 workflow tests pass (INICIAR → FINALIZAR)
- [ ] Version detection and routing work correctly
- [ ] v3.0 backward compatibility maintained
- [ ] Performance < 1s for 10-union operations
- [ ] Comprehensive error handling validated

## Requirements Addressed
- **All API requirements (API-01 through API-06)**: Full implementation validated ✓
- **All METRIC requirements (METRIC-01 through METRIC-09)**: Event logging verified ✓
- **Performance requirement PERF-02**: < 1s for 10 unions validated ✓
- **Backward compatibility**: v3.0 endpoints remain functional ✓

## Phase 11 Complete
With this plan, Phase 11 is complete. The REST API layer for v4.0 union workflows is fully implemented with:
- Versioned endpoints (/api/v3/ and /api/v4/)
- Union query endpoints (disponibles, metricas)
- Action endpoints (INICIAR, FINALIZAR)
- Comprehensive testing
- Performance validation
- Backward compatibility