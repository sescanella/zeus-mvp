---
wave: 1
depends_on: []
files_modified:
  - backend/routers/occupation_v3.py (new)
  - backend/main.py
  - tests/unit/routers/test_occupation_v3.py (new)
autonomous: true
---

# Plan 11-01: API Versioning & V3 Migration

## Goal
Establish URL versioning structure by relocating v3.0 endpoints to `/api/v3/` prefix and creating router foundation for v4.0 endpoints

## Context
From CONTEXT.md decisions:
- v4.0 endpoints use `/api/v4/...` prefix (explicit versioning)
- v3.0 endpoints move to `/api/v3/...` (TOMAR, PAUSAR, COMPLETAR relocated)
- Clean separation prevents breaking changes while maintaining backward compatibility

Currently, v3.0 endpoints are at `/api/occupation/*` and must be relocated to `/api/v3/occupation/*` to support dual-version operation.

## Tasks

<task>
1. Create backend/routers/occupation_v3.py
   - Copy existing occupation.py router content
   - Remove v4.0-specific models and logic (IniciarRequest, FinalizarRequest)
   - Keep only v3.0 endpoints: /tomar, /pausar, /completar, /batch-tomar
   - Update router tags to ["v3-occupation"]
   - Add deprecation notice in docstrings

Success: occupation_v3.py contains only v3.0 endpoints with proper imports
</task>

<task>
2. Update backend/main.py to register versioned routers
   - Import occupation_v3 router
   - Include occupation_v3 router with prefix="/api/v3"
   - Keep existing occupation router at "/api" for temporary backward compatibility
   - Add startup log message indicating v3/v4 router registration

Code structure:
```python
from backend.routers import occupation, occupation_v3

# v3.0 endpoints (relocated)
app.include_router(occupation_v3.router, prefix="/api/v3", tags=["v3-occupation"])

# Keep original path for backward compatibility during transition
app.include_router(occupation.router, prefix="/api", tags=["occupation-legacy"])

logger.info("API versioning enabled: v3.0 endpoints at /api/v3/, v4.0 endpoints at /api/v4/")
```

Success: Both /api/occupation/tomar and /api/v3/occupation/tomar work
</task>

<task>
3. Create basic tests for relocated v3.0 endpoints
   - Create tests/unit/routers/test_occupation_v3.py
   - Test that v3.0 endpoints work at new /api/v3/ prefix
   - Test TOMAR, PAUSAR, COMPLETAR basic flows
   - Verify proper status codes (409 for occupied, 403 for no auth, etc.)

Test structure:
```python
def test_v3_tomar_endpoint():
    """Test that v3.0 TOMAR works at /api/v3/occupation/tomar"""
    response = client.post("/api/v3/occupation/tomar", json={...})
    assert response.status_code == 200

def test_legacy_endpoint_still_works():
    """Temporary: verify /api/occupation/tomar still works"""
    response = client.post("/api/occupation/tomar", json={...})
    assert response.status_code == 200
```

Success: All v3.0 endpoints accessible at new prefix
</task>

<task>
4. Add version detection helper for future use
   - Create backend/utils/version_detection.py
   - Add is_v4_spool() function that checks Total_Uniones column
   - Add get_spool_version() that returns "v3.0" or "v4.0"

Code:
```python
def is_v4_spool(spool_data: dict) -> bool:
    """Detect if spool is v4.0 (has unions) or v3.0 (no unions)."""
    total_uniones = spool_data.get("Total_Uniones")
    return total_uniones is not None and int(total_uniones) > 0

def get_spool_version(spool_data: dict) -> str:
    """Return spool version string."""
    return "v4.0" if is_v4_spool(spool_data) else "v3.0"
```

Success: Version detection utilities available for v4.0 endpoints
</task>

## Verification

<verification>
1. Run existing v3.0 tests - should still pass
   ```bash
   pytest tests/unit/routers/test_occupation.py -v
   ```

2. Test new v3.0 prefix endpoints
   ```bash
   pytest tests/unit/routers/test_occupation_v3.py -v
   ```

3. Manual API test
   ```bash
   # Test v3.0 at new prefix
   curl -X POST http://localhost:8000/api/v3/occupation/tomar \
     -H "Content-Type: application/json" \
     -d '{"tag_spool": "TEST-02", "worker_id": 93, "worker_nombre": "MR(93)", "operacion": "ARM"}'

   # Test legacy path still works
   curl -X POST http://localhost:8000/api/occupation/tomar \
     -H "Content-Type: application/json" \
     -d '{"tag_spool": "TEST-02", "worker_id": 93, "worker_nombre": "MR(93)", "operacion": "ARM"}'
   ```

4. Check API documentation
   - Visit http://localhost:8000/docs
   - Verify v3-occupation tag shows relocated endpoints
   - Verify occupation-legacy tag shows original paths
</verification>

## must_haves
- [ ] v3.0 endpoints accessible at /api/v3/occupation/* prefix
- [ ] Original /api/occupation/* endpoints still functional (backward compatibility)
- [ ] occupation_v3.py router created with only v3.0 logic
- [ ] Version detection utilities created for v4.0 use
- [ ] Tests pass for both old and new paths

## Requirements Addressed
- **API-06**: System maintains v3.0 endpoints (/tomar, /pausar, /completar) for backward compatibility âœ“