---
phase: 03-state-machine-and-collaboration
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - backend/routers/history.py
  - backend/services/history_service.py
  - backend/models/history.py
  - backend/main.py
  - backend/tests/integration/test_collaboration.py
autonomous: true

must_haves:
  truths:
    - "Worker can view occupation history showing who worked on spool"
    - "Duration calculation shows time between TOMAR and PAUSAR/COMPLETAR"
    - "Any Armador can continue ARM work started by different Armador"
  artifacts:
    - path: "backend/routers/history.py"
      provides: "Occupation history endpoint"
      contains: "get_occupation_history"
    - path: "backend/services/history_service.py"
      provides: "History aggregation from Metadata"
      min_lines: 100
      exports: ["HistoryService"]
    - path: "backend/tests/integration/test_collaboration.py"
      provides: "Multi-worker collaboration tests"
      min_lines: 150
  key_links:
    - from: "history_service.py"
      to: "metadata_repository"
      via: "query events"
      pattern: "get_events_by_spool"
    - from: "test_collaboration.py"
      to: "state_service"
      via: "integration test"
      pattern: "multiple workers.*same spool"
---

<objective>
Create occupation history endpoint that shows timeline of workers on each spool, and implement comprehensive integration tests for multi-worker collaborative workflows.

Purpose: Enable visibility into who worked on which spool and for how long (COLLAB-04), and verify that collaborative handoffs work correctly (COLLAB-01).
Output: Working history endpoint showing worker timeline with durations, and passing tests for sequential multi-worker operations.
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-machine-and-collaboration/03-CONTEXT.md
@.planning/phases/03-state-machine-and-collaboration/03-RESEARCH.md
@.planning/phases/03-state-machine-and-collaboration/03-02-SUMMARY.md
@.planning/phases/03-state-machine-and-collaboration/03-03-SUMMARY.md

# Reference metadata repository for event queries
@backend/repositories/metadata_repository.py
@backend/models/metadata.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create occupation history endpoint</name>
  <files>backend/routers/history.py, backend/models/history.py, backend/main.py</files>
  <action>
    Create REST endpoint for occupation history retrieval.

    1. Create models/history.py with:
       - OccupationSession: worker_nombre, worker_id, operacion, start_time, end_time, duration
       - HistoryResponse: tag_spool, sessions (List[OccupationSession])

    2. Create routers/history.py with:
       - GET /api/history/{tag_spool} endpoint
       - Dependency injection for HistoryService
       - Return HistoryResponse with all sessions

    3. Register router in main.py

    Follow RESTful conventions - history is read-only resource.
  </action>
  <verify>curl -X GET http://localhost:8000/api/history/TEST-001</verify>
  <done>Returns 200 with JSON structure (even if empty sessions array)</done>
</task>

<task type="auto">
  <name>Task 2: Build occupation history aggregation service</name>
  <files>backend/services/history_service.py</files>
  <action>
    Create service that aggregates Metadata events into occupation timeline.

    1. Create HistoryService with get_occupation_history(tag_spool) method:
       - Query metadata for TOMAR_SPOOL, PAUSAR_SPOOL, COMPLETAR_ARM, COMPLETAR_SOLD events
       - Build sessions by matching TOMAR with corresponding PAUSAR/COMPLETAR
       - Calculate duration using _calculate_duration() helper
       - Format as "2h 15m" for readability

    2. Handle edge cases:
       - TOMAR without matching end (session still open)
       - Multiple workers on same spool (sequential sessions)
       - PAUSAR followed by another worker's TOMAR

    Follow pattern from 03-RESEARCH.md lines 545-604.
    Show ALL events chronologically, no filtering (per context decision).
  </action>
  <verify>cd backend && python -c "from services.history_service import HistoryService; print('HistoryService ready')"</verify>
  <done>HistoryService imports without errors</done>
</task>

<task type="auto">
  <name>Task 3: Implement collaboration integration tests</name>
  <files>backend/tests/integration/test_collaboration.py</files>
  <action>
    Create comprehensive tests for multi-worker collaboration scenarios.

    Test cases:
    1. test_armador_handoff():
       - Worker A (Armador) starts ARM (TOMAR)
       - Worker A pauses (PAUSAR)
       - Worker B (also Armador) takes over (TOMAR)
       - Worker B completes (COMPLETAR)
       - Verify Armador column shows "Worker B", Fecha_Armado populated

    2. test_dependency_enforcement():
       - Try SOLD TOMAR without ARM initiated
       - Verify 400 error with "ARM must be initiated" message

    3. test_sequential_operations():
       - Worker A completes ARM
       - Worker B starts and completes SOLD
       - Verify both operations show completado in Estado_Detalle

    4. test_occupation_history_timeline():
       - Multiple workers work on same spool
       - Query history endpoint
       - Verify sessions show correct workers, times, durations

    Use pytest fixtures for test data setup.
  </action>
  <verify>cd backend && pytest tests/integration/test_collaboration.py -v</verify>
  <done>All collaboration tests pass</done>
</task>

</tasks>

<verification>
1. History endpoint returns occupation timeline for any spool
2. Duration calculations show time in human-readable format
3. Integration tests pass for Armador handoff scenario
4. SOLD dependency on ARM is enforced (test fails without ARM)
5. Estado_Detalle shows correct combined state after multiple operations
</verification>

<success_criteria>
- [ ] GET /api/history/{tag_spool} endpoint returns worker timeline
- [ ] HistoryService aggregates Metadata events into sessions with durations
- [ ] Test verifies Worker B can complete ARM started by Worker A
- [ ] Test verifies SOLD cannot start without ARM initiated
- [ ] All Phase 3 success criteria from roadmap are met
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-machine-and-collaboration/03-04-SUMMARY.md`
</output>