---
phase: 03-state-machine-and-collaboration
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/services/state_machines/arm_state_machine.py
  - backend/services/state_machines/sold_state_machine.py
  - backend/services/state_service.py
  - backend/repositories/sheets_repository.py
autonomous: true

must_haves:
  truths:
    - "ARM state machine updates Armador column on TOMAR"
    - "SOLD state machine updates Fecha_Soldadura on COMPLETAR"
    - "Estado_Detalle updates automatically on every state transition"
  artifacts:
    - path: "backend/services/state_machines/arm_state_machine.py"
      provides: "ARM callbacks for column updates"
      contains: "on_enter_en_progreso"
    - path: "backend/services/state_machines/sold_state_machine.py"
      provides: "SOLD callbacks for column updates"
      contains: "on_enter_completado"
  key_links:
    - from: "arm_state_machine.py"
      to: "sheets_repository"
      via: "callback methods"
      pattern: "update_cell_by_column_name"
    - from: "state_service.py"
      to: "Estado_Detalle"
      via: "after transition update"
      pattern: "_update_estado_detalle"
---

<objective>
Add state machine callbacks that automatically update Sheets columns (Armador, Soldador, Fecha_Armado, Fecha_Soldadura) on state transitions, and ensure Estado_Detalle stays synchronized.

Purpose: Make state machines the single source of truth for column updates, eliminating manual column writes and ensuring consistency.
Output: State machines with working callbacks that update columns atomically with state transitions.
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-machine-and-collaboration/03-CONTEXT.md
@.planning/phases/03-state-machine-and-collaboration/03-RESEARCH.md
@.planning/phases/03-state-machine-and-collaboration/03-01-SUMMARY.md

# Reference sheets repository for column update methods
@backend/repositories/sheets_repository.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ARM state machine callbacks</name>
  <files>backend/services/state_machines/arm_state_machine.py</files>
  <action>
    Add callbacks to ARM state machine for automatic column updates.

    1. Add async on_enter_en_progreso() callback:
       - Extract worker_nombre from event_data.kwargs
       - Update Armador column with worker name
       - Use await self.sheets_repo.update_cell_by_column_name()

    2. Add async on_enter_completado() callback:
       - Extract fecha_operacion from event_data.kwargs (or use date.today())
       - Update Fecha_Armado column with date
       - Format date as DD-MM-YYYY for consistency

    3. Add async on_enter_pendiente() callback:
       - Check if transition source was en_progreso (CANCELAR case)
       - Clear Armador column (set to empty string)

    Follow pattern from 03-RESEARCH.md lines 354-414.
    All callbacks must be async since they do Sheets I/O.
  </action>
  <verify>grep -E "async def on_enter" backend/services/state_machines/arm_state_machine.py</verify>
  <done>Shows 3 async callback methods: on_enter_pendiente, on_enter_en_progreso, on_enter_completado</done>
</task>

<task type="auto">
  <name>Task 2: Add SOLD state machine callbacks</name>
  <files>backend/services/state_machines/sold_state_machine.py</files>
  <action>
    Add callbacks to SOLD state machine following same pattern as ARM.

    1. Add async on_enter_en_progreso() callback:
       - Update Soldador column with worker_nombre

    2. Add async on_enter_completado() callback:
       - Update Fecha_Soldadura column with fecha_operacion

    3. Add async on_enter_pendiente() callback:
       - Clear Soldador column on CANCELAR

    4. Ensure ARM dependency validator is still present from Plan 01

    Mirror ARM pattern but for SOLD-specific columns.
  </action>
  <verify>grep -E "async def on_enter|def validate_arm" backend/services/state_machines/sold_state_machine.py</verify>
  <done>Shows 3 async callbacks plus validate_arm_initiated method</done>
</task>

<task type="auto">
  <name>Task 3: Implement automatic Estado_Detalle updates</name>
  <files>backend/services/state_service.py</files>
  <action>
    Update StateService to automatically update Estado_Detalle after state transitions.

    1. Add _update_estado_detalle() method:
       - Accept tag_spool, ocupado_por, arm_state, sold_state
       - Use EstadoDetalleBuilder to create display string
       - Update Estado_Detalle column in Sheets

    2. In tomar() method after state transition:
       - Call _update_estado_detalle() with new states

    3. In pausar() method:
       - Clear ocupado_por (set to None)
       - Call _update_estado_detalle() to show "Disponible" format

    4. In completar() method:
       - After completing operation
       - Call _update_estado_detalle() with updated state

    Estado_Detalle must update on EVERY state change for real-time visibility.
  </action>
  <verify>grep -c "_update_estado_detalle" backend/services/state_service.py</verify>
  <done>Shows at least 4 occurrences (method definition + 3 calls in tomar/pausar/completar)</done>
</task>

</tasks>

<verification>
1. State machine callbacks trigger on state transitions
2. Armador/Soldador columns update on iniciar transitions
3. Fecha_Armado/Fecha_Soldadura columns update on completar transitions
4. Columns clear on cancelar transitions
5. Estado_Detalle updates after every state change
</verification>

<success_criteria>
- [ ] ARM callbacks update Armador and Fecha_Armado columns
- [ ] SOLD callbacks update Soldador and Fecha_Soldadura columns
- [ ] CANCELAR transitions clear worker assignment columns
- [ ] Estado_Detalle automatically updates after every transition
- [ ] All callbacks are async and handle Sheets I/O properly
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-machine-and-collaboration/03-03-SUMMARY.md`
</output>