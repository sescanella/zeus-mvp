---
phase: 03-state-machine-and-collaboration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/services/state_machines/__init__.py
  - backend/services/state_machines/base_state_machine.py
  - backend/services/state_machines/arm_state_machine.py
  - backend/services/state_machines/sold_state_machine.py
  - backend/scripts/add_estado_detalle_column.py
  - backend/exceptions.py
autonomous: true

must_haves:
  truths:
    - "Estado_Detalle column exists in Operaciones sheet"
    - "ARM state machine transitions from PENDIENTE to EN_PROGRESO to COMPLETADO"
    - "SOLD state machine blocks TOMAR if ARM not initiated"
  artifacts:
    - path: "backend/services/state_machines/arm_state_machine.py"
      provides: "ARM state machine with 3 states"
      min_lines: 50
      exports: ["ARMStateMachine"]
    - path: "backend/services/state_machines/sold_state_machine.py"
      provides: "SOLD state machine with dependency guard"
      min_lines: 60
      exports: ["SOLDStateMachine"]
    - path: "backend/scripts/add_estado_detalle_column.py"
      provides: "Migration script for Estado_Detalle column"
      min_lines: 40
  key_links:
    - from: "sold_state_machine.py"
      to: "arm state check"
      via: "guard condition"
      pattern: "arm_not_initiated"
    - from: "arm_state_machine.py"
      to: "python-statemachine"
      via: "import and inheritance"
      pattern: "from statemachine import StateMachine"
---

<objective>
Create the foundation for hierarchical state machines: add Estado_Detalle column to Operaciones sheet and implement separate ARM/SOLD state machines with dependency guards.

Purpose: Enable combined state tracking (occupation + operation progress) and prevent state explosion by using separate per-operation state machines.
Output: Estado_Detalle column in production sheet, working ARM and SOLD state machines with proper transitions and guards.
</objective>

<execution_context>
@/Users/sescanella/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sescanella/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-machine-and-collaboration/03-CONTEXT.md
@.planning/phases/03-state-machine-and-collaboration/03-RESEARCH.md

# Reference Phase 2 summaries for OccupationService structure
@.planning/phases/02-core-location-tracking/02-02-SUMMARY.md

# Current production schema from Phase 1
@backend/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Estado_Detalle column to Operaciones sheet</name>
  <files>backend/scripts/add_estado_detalle_column.py, backend/config.py</files>
  <action>
    Create migration script to add Estado_Detalle column to Operaciones sheet at position 67 (after the v3.0 columns added in Phase 1).

    1. Copy pattern from Phase 1's add_v3_columns.py script
    2. Add Estado_Detalle as column 67 (1-indexed position)
    3. Use same idempotency check (don't add if already exists)
    4. Update V3_COLUMNS in config.py to include Estado_Detalle
    5. Test with dry-run mode first

    Column purpose: Store formatted display string like "MR(93) trabajando ARM (SOLD pendiente)" or "Disponible - ARM pendiente, SOLD pendiente"
  </action>
  <verify>python backend/scripts/add_estado_detalle_column.py --dry-run</verify>
  <done>Script runs without errors and reports "Column 'Estado_Detalle' would be added at position 67" in dry-run mode</done>
</task>

<task type="auto">
  <name>Task 2: Create ARM state machine with basic transitions</name>
  <files>backend/services/state_machines/__init__.py, backend/services/state_machines/base_state_machine.py, backend/services/state_machines/arm_state_machine.py, backend/exceptions.py</files>
  <action>
    Implement ARM operation state machine using python-statemachine library.

    1. Install python-statemachine==2.5.0 in venv
    2. Create base_state_machine.py with shared functionality
    3. Create arm_state_machine.py with:
       - States: pendiente (initial), en_progreso, completado (final)
       - Transitions: iniciar (pendiente→en_progreso), completar (en_progreso→completado), cancelar (en_progreso→pendiente)
       - Constructor accepting tag_spool, sheets_repo, metadata_repo
       - State names as class attributes for external access
    4. Add DependenciasNoSatisfechasError to exceptions.py if not exists

    Follow pattern from 03-RESEARCH.md Example 1 (lines 351-415).
    Do NOT add callbacks yet - those come in Plan 03.
  </action>
  <verify>cd backend && python -c "from services.state_machines.arm_state_machine import ARMStateMachine; m = ARMStateMachine('TEST-001', None, None); print(f'Initial: {m.current_state.id}')"</verify>
  <done>Import succeeds and prints "Initial: pendiente"</done>
</task>

<task type="auto">
  <name>Task 3: Create SOLD state machine with ARM dependency guard</name>
  <files>backend/services/state_machines/sold_state_machine.py</files>
  <action>
    Implement SOLD operation state machine with ARM dependency validation.

    1. Create sold_state_machine.py following ARM pattern but adding:
       - Guard condition method: arm_not_initiated() that checks if ARM is started
       - Validator method: validate_arm_initiated() that raises DependenciasNoSatisfechasError
       - iniciar transition with guard: pendiente.to(en_progreso, validators=["validate_arm_initiated"])
    2. Guard should check via sheets_repo if Armador column is None (ARM not started)
    3. Include clear error message: "SOLD no puede iniciarse sin ARM iniciado"

    Follow pattern from 03-RESEARCH.md Example Pattern 2 (lines 134-173).
    Remember: Guards return boolean, validators raise exceptions.
  </action>
  <verify>cd backend && python -c "from services.state_machines.sold_state_machine import SOLDStateMachine; m = SOLDStateMachine('TEST-001', None, None); print(f'Has guard: {hasattr(m, \"arm_not_initiated\")}')"</verify>
  <done>Import succeeds and prints "Has guard: True"</done>
</task>

</tasks>

<verification>
1. Estado_Detalle column visible in Google Sheets at position 67
2. Both state machines importable and instantiable
3. ARM state machine transitions work: pendiente → en_progreso → completado
4. SOLD state machine has ARM dependency guard
5. python-statemachine==2.5.0 added to requirements.txt
</verification>

<success_criteria>
- [ ] Estado_Detalle column successfully added to production sheet
- [ ] ARM state machine created with 3 states and 3 transitions
- [ ] SOLD state machine created with ARM dependency guard
- [ ] Both state machines follow python-statemachine patterns
- [ ] No callbacks implemented yet (deferred to Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-machine-and-collaboration/03-01-SUMMARY.md`
</output>