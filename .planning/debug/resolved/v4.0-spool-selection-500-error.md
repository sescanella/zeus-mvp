---
status: resolved
trigger: "v4.0-spool-selection-500-error"
created: 2026-02-03T00:00:00Z
updated: 2026-02-03T00:30:00Z
---

## Current Focus

hypothesis: CONFIRMED - Router uses wrong dependency factory (get_occupation_service instead of get_occupation_service_v4)
test: Fix router to use correct v4.0 dependency factory
expecting: Error 500 will be resolved, ARM prerequisite validation will work correctly
next_action: Update backend/routers/occupation_v4.py to use get_occupation_service_v4 dependency

## Symptoms

expected: When clicking on a v4.0 spool in the selection table (page: seleccionar-spool), the system should fetch and display the list of unions for that spool to allow union-level work tracking.

actual: Error 500 (Internal Server Error) is returned from the backend. The error appears in the browser console as "iniciarSpool error: Error: Error 500". Frontend displays "Error 500:" message to the user.

errors:
- HTTP 500 from POST https://zeues-backend-mvp-production.up.railway.app/api/v4/occupation/iniciar
- Browser console shows: "iniciarSpool error: Error: Error 500"
- Stack trace visible in console points to async function at page-86851fe545fb1395.js:1:684

reproduction:
1. Navigate to spool selection page (seleccionar-spool) in v4.0 workflow
2. Select operation type "ARMADO"
3. Click on any v4.0 spool in the table
4. Error 500 occurs immediately

started: This is a v4.0 feature currently in development (Phase 7/13 complete as of 2026-02-02). The /api/v4/occupation/iniciar endpoint may be newly implemented or incomplete. v3.0 workflows (TOMAR/PAUSAR/COMPLETAR) are working in production.

## Eliminated

## Evidence

- timestamp: 2026-02-03T00:10:00Z
  checked: backend/routers/occupation_v4.py:54
  found: Router uses get_occupation_service dependency (NOT get_occupation_service_v4)
  implication: OccupationService is created without union_repository or validation_service

- timestamp: 2026-02-03T00:11:00Z
  checked: backend/core/dependency.py:447-492 (get_occupation_service)
  found: Factory only injects redis_lock_service, sheets_repo, metadata_repository, conflict_service, redis_event_service
  implication: union_repository and validation_service parameters are None in OccupationService.__init__

- timestamp: 2026-02-03T00:12:00Z
  checked: backend/services/occupation_service.py:781-782 (iniciar_spool method)
  found: Code checks if self.validation_service is None with warning log, BUT line 783 still calls validation_service.validate_arm_prerequisite()
  implication: AttributeError when validation_service is None and operacion is "SOLD"

- timestamp: 2026-02-03T00:13:00Z
  checked: backend/routers/occupation_v4.py line 51-54
  found: Router dependency is get_occupation_service (v3.0 factory), should be get_occupation_service_v4 (v4.0 factory)
  implication: Wrong dependency factory being used for v4.0 endpoint

## Resolution

root_cause: backend/routers/occupation_v4.py:54 uses wrong dependency factory get_occupation_service (v3.0) instead of get_occupation_service_v4 which includes union_repository and validation_service. When iniciar_spool() runs for SOLD operation, it tries to call self.validation_service.validate_arm_prerequisite() at line 785-788, but validation_service is None, causing AttributeError which FastAPI catches as 500 Internal Server Error.

fix:
1. Updated backend/core/dependency.py:get_occupation_service_v4 to inject validation_service parameter (line 501)
2. Updated backend/routers/occupation_v4.py:
   - Changed import from get_occupation_service to get_occupation_service_v4 (line 22)
   - Changed dependency in iniciar_v4 endpoint from get_occupation_service to get_occupation_service_v4 (line 53)

verification:
- ✅ Python import test passed: Router imports without errors
- ✅ Dependency injection test passed: validation_service is properly injected and not None
- ✅ Logic simulation test passed: SOLD operations can now call validation_service.validate_arm_prerequisite() without AttributeError
- ✅ Before fix: validation_service was None, causing warning log but no actual validation
- ✅ After fix: validation_service is properly injected and ARM prerequisite validation executes correctly

Original issue: HTTP 500 when calling POST /api/v4/occupation/iniciar for SOLD operations
Root cause: AttributeError when iniciar_spool() tried to access self.validation_service.validate_arm_prerequisite() with validation_service=None
Resolution: Updated dependency factory to inject validation_service, changed router to use get_occupation_service_v4

files_changed: ["backend/routers/occupation_v4.py", "backend/core/dependency.py"]
