# Requirements Archive: v4.0 Uniones System

**Archived:** 2026-02-02
**Status:** ✅ SHIPPED

This is the archived requirements specification for v4.0.
For current requirements, see `.planning/REQUIREMENTS.md` (will be created for next milestone).

---

# Requirements: ZEUES v4.0 Uniones System

**Defined:** 2026-01-30
**Core Value:** Track work at the union level with the correct business metric (pulgadas-diámetro)

## v4.0 Requirements

Requirements for union-level tracking and partial completion workflows. Each maps to roadmap phases.

### Data Model & Schema

- [x] **DATA-01**: Add 5 columns to Uniones sheet (14-18): version (UUID4), Creado_Por, Fecha_Creacion, Modificado_Por, Fecha_Modificacion
- [x] **DATA-02**: Add 5 columns to Operaciones sheet (68-72): Total_Uniones, Uniones_ARM_Completadas, Uniones_SOLD_Completadas, Pulgadas_ARM, Pulgadas_SOLD
- [x] **DATA-03**: Add N_UNION column to Metadata sheet (position 11 at end, nullable) for granular audit trail
- [x] **DATA-04**: UnionRepository uses TAG_SPOOL column (not OT) for foreign key relationship to Operaciones
- [x] **DATA-05**: System uses dynamic header mapping for all sheets (never hardcode column indices)

### Backend - Repositories & Models

- [x] **REPO-01**: UnionRepository provides get_disponibles_arm() - returns unions where ARM_FECHA_FIN IS NULL
- [x] **REPO-02**: UnionRepository provides get_disponibles_sold() - returns unions where ARM_FECHA_FIN IS NOT NULL AND SOL_FECHA_FIN IS NULL
- [x] **REPO-03**: UnionRepository provides batch_update_arm() using gspread.batch_update() with A1 notation (1 API call for N unions)
- [x] **REPO-04**: UnionRepository provides batch_update_sold() using gspread.batch_update() with A1 notation
- [x] **REPO-05**: UnionRepository provides count_completed_arm() and count_completed_sold() for metrics
- [x] **REPO-06**: UnionRepository provides sum_pulgadas_arm() and sum_pulgadas_sold() for metrics calculation
- [x] **REPO-07**: MetadataRepository extends log_event() with n_union: Optional[int] parameter
- [x] **REPO-08**: MetadataRepository provides batch_log_events() with auto-chunking (900 rows max per chunk)
- [x] **REPO-09**: Union Pydantic model with 18 fields matching Uniones sheet structure

### Backend - Services & Business Logic

- [x] **SVC-01**: UnionService provides process_selection() - orchestrates batch update + metadata logging
- [x] **SVC-02**: UnionService provides calcular_pulgadas() - sums DN_UNION for selected unions with 1 decimal precision
- [x] **SVC-03**: UnionService provides build_eventos_metadata() - creates batch + granular events
- [x] **SVC-04**: OccupationService provides iniciar_spool() - writes Ocupado_Por + Fecha_Ocupacion + Redis lock (NO touch Uniones)
- [x] **SVC-05**: OccupationService provides finalizar_spool() - auto-determines PAUSAR/COMPLETAR, delegates to UnionService, releases lock
- [x] **SVC-06**: ValidationService enforces ARM→SOLD prerequisite (SOLD requires >= 1 union with ARM_FECHA_FIN != NULL)
- [x] **SVC-07**: System auto-determines PAUSAR (len(selected) < total) vs COMPLETAR (len(selected) == total)
- [x] **SVC-08**: System triggers metrología queue when SOLD 100% complete (Estado_Detalle = "En Cola Metrología")

### Backend - API Endpoints

- [x] **API-01**: GET /api/v4/uniones/{tag}/disponibles?operacion=ARM - returns unions where ARM_FECHA_FIN IS NULL
- [x] **API-02**: GET /api/v4/uniones/{tag}/disponibles?operacion=SOLD - returns unions where ARM_FECHA_FIN IS NOT NULL AND SOL_FECHA_FIN IS NULL
- [x] **API-03**: GET /api/v4/uniones/{tag}/metricas - returns {total_uniones, arm_completadas, sold_completadas, pulgadas_arm, pulgadas_sold}
- [x] **API-04**: POST /api/v4/occupation/iniciar - body: {tag_spool, worker_id, operacion} - occupies spool only
- [x] **API-05**: POST /api/v4/occupation/finalizar - body: {tag_spool, worker_id, operacion, selected_unions: list[int]} - auto-determines PAUSAR/COMPLETAR
- [x] **API-06**: System maintains v3.0 endpoints (/tomar, /pausar, /completar) for backward compatibility

### Frontend - UX Workflows

- [x] **UX-01**: P3 shows 2 buttons (INICIAR, FINALIZAR) for v4.0 spools
- [x] **UX-02**: P3 shows 3 buttons (TOMAR, PAUSAR, COMPLETAR) for v3.0 spools
- [x] **UX-03**: P4 filters spools by action - INICIAR: disponibles (STATUS_NV='ABIERTA' AND Status_Spool='EN_PROCESO' AND Ocupado_Por IN ('','DISPONIBLE'))
- [x] **UX-04**: P4 filters spools by action - FINALIZAR: ocupados (Ocupado_Por LIKE '%(worker_id)%')
- [x] **UX-05**: P5 (new page) shows union selection checkboxes with N_UNION, DN_UNION, TIPO_UNION
- [x] **UX-06**: P5 shows live counter "Seleccionadas: 7/10 | Pulgadas: 18.5" updated in real-time
- [x] **UX-07**: P5 shows modal confirmation "¿Liberar sin registrar?" when 0 unions selected
- [x] **UX-08**: P5 disables checkboxes for already-completed unions with "✓ Armada" or "✓ Soldada" badge
- [x] **UX-09**: Context stores accion ('INICIAR' | 'FINALIZAR'), selectedUnions (number[]), pulgadasCompletadas (number)
- [x] **UX-10**: P6/P7 show dynamic text based on action and display pulgadasCompletadas for FINALIZAR

### Frontend - Version Detection

- [x] **VER-01**: System detects spool version by querying union count (count > 0 = v4.0, count = 0 = v3.0)
- [x] **VER-02**: Frontend renders appropriate UX based on spool version (2-button vs 3-button flow)
- [x] **VER-03**: System validates v4.0 endpoints reject v3.0 spools (union count = 0) with clear error message

### Performance & Optimization

- [x] **PERF-01**: Batch union updates achieve < 1s latency (p95) for 10-union selection
- [x] **PERF-02**: Batch union updates achieve < 2s latency (p99) - acceptable threshold
- [x] **PERF-03**: Single FINALIZAR operation makes max 2 Sheets API calls (1 batch update + 1 batch append)
- [x] **PERF-04**: Metadata batch logging chunks eventos into 900-row groups (Google Sheets append_rows limit)
- [x] **PERF-05**: System stays under 50% of Google Sheets rate limit (30 writes/min vs 60 limit)

### Metrics & Audit Trail

- [x] **METRIC-01**: Dashboard displays pulgadas-diámetro as primary metric (not spool count)
- [x] **METRIC-02**: System calculates worker performance as pulgadas-diámetro/day
- [x] **METRIC-03**: Metadata logs SPOOL_ARM_PAUSADO event with {uniones_completadas, total, uniones_trabajadas, pulgadas}
- [x] **METRIC-04**: Metadata logs SPOOL_ARM_COMPLETADO event with {uniones_completadas, total, pulgadas}
- [x] **METRIC-05**: Metadata logs SPOOL_SOLD_PAUSADO and SPOOL_SOLD_COMPLETADO events
- [x] **METRIC-06**: Metadata logs SPOOL_CANCELADO event when 0 unions selected (with operacion and motivo)
- [x] **METRIC-07**: Metadata logs granular UNION_ARM_REGISTRADA event per union with {dn_union, tipo, timestamp_inicio, timestamp_fin, duracion_min}
- [x] **METRIC-08**: Metadata logs granular UNION_SOLD_REGISTRADA event per union
- [x] **METRIC-09**: Each FINALIZAR operation logs 1 batch event (N_UNION=NULL) + N granular events (N_UNION=1-20)

### Redis & State Management

- [x] **REDIS-01**: Redis locks have NO TTL (permanent until FINALIZAR) to support 5-8 hour work sessions
- [x] **REDIS-02**: System implements lazy cleanup executed on INICIAR (removes locks > 24h without Sheets.Ocupado_Por match)
- [x] **REDIS-03**: System reconciles Redis locks from Sheets.Ocupado_Por on application startup (auto-recovery)
- [x] **REDIS-04**: INICIAR writes Redis lock with key format "spool:{TAG_SPOOL}:lock" and value "{worker_id}"
- [x] **REDIS-05**: FINALIZAR releases Redis lock and sets Ocupado_Por='DISPONIBLE' regardless of PAUSAR or COMPLETAR outcome

### Validation & Business Rules

- [x] **VAL-01**: System validates INICIAR SOLD requires >= 1 union with ARM_FECHA_FIN != NULL
- [x] **VAL-02**: System prevents selecting union for SOLD if ARM_FECHA_FIN IS NULL (backend filters + frontend validation)
- [x] **VAL-03**: System supports partial ARM completion (worker A: 7/10, worker B: 3/10 later)
- [x] **VAL-04**: System supports partial SOLD completion with armadas constraint (can complete 5 of 7 soldable unions)
- [x] **VAL-05**: System handles edge case: 10 total unions, 6 armadas, 4 sin armar → SOLD shows 6 checkboxes, completing 6/6 = PAUSADO (not COMPLETADO)
- [x] **VAL-06**: System enforces optimistic locking with version UUID on Uniones updates (3x retry with backoff)
- [x] **VAL-07**: System allows 0 unions selected in FINALIZAR after modal confirmation (logs SPOOL_CANCELADO, releases lock)

### Backward Compatibility

- [x] **COMPAT-01**: Metrología workflow stays at spool level (no changes to /api/metrologia/completar)
- [x] **COMPAT-02**: Reparación workflow stays at spool level (no changes to /api/reparacion/*)
- [x] **COMPAT-03**: Estado_Detalle continues calculating from spool-level data (no union-level granularity)
- [x] **COMPAT-04**: Uniones columns NDT_UNION and R_NDT_UNION remain NULL in v4.0 (reserved for v4.1+)
- [x] **COMPAT-05**: SSE endpoints /api/sse/disponible and /api/sse/quien-tiene-que remain unchanged (no new filters)
- [x] **COMPAT-06**: Operaciones columns Armador, Soldador, Fecha_Armado, Fecha_Soldadura remain in schema (not removed)
- [x] **COMPAT-07**: Backend calculates Armador/Soldador from Uniones on-demand when legacy endpoints request them

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| DATA-01 | Phase 7 | Complete |
| DATA-02 | Phase 7 | Complete |
| DATA-03 | Phase 7 | Complete |
| DATA-04 | Phase 7 | Complete |
| DATA-05 | Phase 7 | Complete |
| REPO-01 | Phase 8 | Complete |
| REPO-02 | Phase 8 | Complete |
| REPO-03 | Phase 8 | Complete |
| REPO-04 | Phase 8 | Complete |
| REPO-05 | Phase 8 | Complete |
| REPO-06 | Phase 8 | Complete |
| REPO-07 | Phase 8 | Complete |
| REPO-08 | Phase 8 | Complete |
| REPO-09 | Phase 8 | Complete |
| REDIS-01 | Phase 9 | Complete |
| REDIS-02 | Phase 9 | Complete |
| REDIS-03 | Phase 9 | Complete |
| REDIS-04 | Phase 9 | Complete |
| REDIS-05 | Phase 9 | Complete |
| VER-01 | Phase 9 | Complete |
| VER-02 | Phase 9 | Complete |
| VER-03 | Phase 9 | Complete |
| SVC-01 | Phase 10 | Complete |
| SVC-02 | Phase 10 | Complete |
| SVC-03 | Phase 10 | Complete |
| SVC-04 | Phase 10 | Complete |
| SVC-05 | Phase 10 | Complete |
| SVC-06 | Phase 10 | Complete |
| SVC-07 | Phase 10 | Complete |
| SVC-08 | Phase 10 | Complete |
| VAL-01 | Phase 10 | Complete |
| VAL-02 | Phase 10 | Complete |
| VAL-03 | Phase 10 | Complete |
| VAL-04 | Phase 10 | Complete |
| VAL-05 | Phase 10 | Complete |
| VAL-06 | Phase 10 | Complete |
| VAL-07 | Phase 10 | Complete |
| API-01 | Phase 11 | Complete |
| API-02 | Phase 11 | Complete |
| API-03 | Phase 11 | Complete |
| API-04 | Phase 11 | Complete |
| API-05 | Phase 11 | Complete |
| API-06 | Phase 11 | Complete |
| METRIC-01 | Phase 11 | Complete |
| METRIC-02 | Phase 11 | Complete |
| METRIC-03 | Phase 11 | Complete |
| METRIC-04 | Phase 11 | Complete |
| METRIC-05 | Phase 11 | Complete |
| METRIC-06 | Phase 11 | Complete |
| METRIC-07 | Phase 11 | Complete |
| METRIC-08 | Phase 11 | Complete |
| METRIC-09 | Phase 11 | Complete |
| UX-01 | Phase 12 | Complete |
| UX-02 | Phase 12 | Complete |
| UX-03 | Phase 12 | Complete |
| UX-04 | Phase 12 | Complete |
| UX-05 | Phase 12 | Complete |
| UX-06 | Phase 12 | Complete |
| UX-07 | Phase 12 | Complete |
| UX-08 | Phase 12 | Complete |
| UX-09 | Phase 12 | Complete |
| UX-10 | Phase 12 | Complete |
| COMPAT-01 | Phase 12 | Complete |
| COMPAT-02 | Phase 12 | Complete |
| COMPAT-03 | Phase 12 | Complete |
| COMPAT-04 | Phase 12 | Complete |
| COMPAT-05 | Phase 12 | Complete |
| COMPAT-06 | Phase 12 | Complete |
| COMPAT-07 | Phase 12 | Complete |
| PERF-01 | Phase 13 | Complete |
| PERF-02 | Phase 13 | Complete |
| PERF-03 | Phase 13 | Complete |
| PERF-04 | Phase 13 | Complete |
| PERF-05 | Phase 13 | Complete |

**Coverage:**
- v4.0 requirements: 63 total
- Mapped to phases: 63 (100% coverage)
- Shipped: 63 (100%)

---

## Milestone Summary

**Shipped:** 63 of 63 v4.0 requirements (100%)

**Adjusted:** None - all requirements implemented as originally specified

**Dropped:** None - all requirements validated and shipped

**Key Outcomes:**
- Union-level tracking achieved with complete audit trail
- Pulgadas-diámetro metric integrated throughout system
- Dual v3.0/v4.0 workflow support maintaining backward compatibility
- Performance targets validated with mock infrastructure (production validation pending)
- Comprehensive test coverage with 244 tests passing

---

*Archived: 2026-02-02 as part of v4.0 milestone completion*
*Requirements defined: 2026-01-30*
*Last updated: 2026-02-02 (100% complete)*
