# Milestone v4.0: Uniones System

**Status:** ✅ SHIPPED 2026-02-02
**Phases:** 7-13
**Total Plans:** 42

## Overview

Track work at the union level with the correct business metric (pulgadas-diámetro). Enable workers to complete work by individual welds, measure performance in pulgadas-diámetro, and support partial completion workflows.

## Phases

### Phase 7: Data Model Foundation

**Goal**: Sheets schema ready for union-level tracking with audit columns and metrics aggregations
**Depends on**: v3.0 Phase 6 (shipped)
**Plans**: 7 plans (including 2 gap closure plans)

Plans:

- [x] 07-01-PLAN.md — Extend Operaciones sheet to 72 columns with metrics
- [x] 07-02-PLAN.md — Validate Uniones sheet and extend Metadata schema
- [x] 07-03-PLAN.md — Create Union model and repository with tests
- [x] 07-04-PLAN.md — Add startup schema validation for all sheets
- [x] 07-05-PLAN.md — Integrate v4.0 schema validation into FastAPI startup
- [x] 07-06-PLAN.md — Execute schema migrations for Operaciones and Metadata (gap closure)
- [x] 07-07-PLAN.md — Document Uniones requirements for Engineering (gap closure)

**Success Criteria** (what must be TRUE):
1. Uniones sheet has 18 columns including 5 audit fields (version, Creado_Por, Fecha_Creacion, Modificado_Por, Fecha_Modificacion)
2. Operaciones sheet has 72 columns including 5 new metrics columns (Total_Uniones, Uniones_ARM_Completadas, Uniones_SOLD_Completadas, Pulgadas_ARM, Pulgadas_SOLD)
3. Metadata sheet has 11 columns including N_UNION field at position 11 for granular audit trail
4. System queries all sheets using dynamic header mapping (no hardcoded column indices)
5. UnionRepository can query Uniones using TAG_SPOOL as foreign key to Operaciones

### Phase 8: Backend Data Layer

**Goal**: Repository layer can read/write union data with batch operations and performance optimization
**Depends on**: Phase 7
**Plans**: 5 plans

Plans:

- [x] 08-01-PLAN.md — Implement batch update methods for ARM and SOLD operations
- [x] 08-02-PLAN.md — Implement OT-based query methods for union repository
- [x] 08-03-PLAN.md — Implement metrics aggregation methods for union tracking
- [x] 08-04-PLAN.md — Extend metadata repository with batch logging and N_UNION field
- [x] 08-05-PLAN.md — Integration tests and performance validation

**Success Criteria** (what must be TRUE):
1. UnionRepository can fetch disponibles for ARM (where ARM_FECHA_FIN IS NULL) and SOLD (where ARM_FECHA_FIN IS NOT NULL AND SOL_FECHA_FIN IS NULL)
2. UnionRepository can batch update ARM and SOLD timestamps using gspread.batch_update() with A1 notation in single API call
3. UnionRepository can count completed unions and sum pulgadas for ARM and SOLD operations
4. MetadataRepository can log batch events with auto-chunking (900 rows max per chunk)
5. Union Pydantic model validates 18 fields matching Uniones sheet structure

### Phase 9: Redis & Version Detection

**Goal**: Redis locks support long-running sessions and system detects v3.0 vs v4.0 spools for dual workflow routing
**Depends on**: Phase 8
**Plans**: 6 plans

Plans:

- [x] 09-01-PLAN.md — Implement persistent Redis locks without TTL
- [x] 09-02-PLAN.md — Add lazy cleanup mechanism for abandoned locks
- [x] 09-03-PLAN.md — Implement startup reconciliation from Sheets
- [x] 09-04-PLAN.md — Create version detection service and diagnostic endpoint
- [x] 09-05-PLAN.md — Integration tests for persistent locks and version detection
- [x] 09-06-PLAN.md — Frontend version detection and badges

**Success Criteria** (what must be TRUE):
1. Redis locks have NO TTL and persist until FINALIZAR operation releases them
2. System executes lazy cleanup on INICIAR removing locks older than 24h without matching Sheets.Ocupado_Por
3. System reconciles Redis locks from Sheets.Ocupado_Por on application startup for auto-recovery
4. Frontend detects spool version by union count (count > 0 = v4.0, count = 0 = v3.0)
5. System validates v4.0 endpoints reject v3.0 spools with clear error message

### Phase 10: Backend Services & Validation

**Goal**: Business logic orchestrates union selection with auto-determination of PAUSAR vs COMPLETAR and ARM-before-SOLD validation
**Depends on**: Phase 9
**Plans**: 5 plans

Plans:

- [x] 10-01-PLAN.md — Create UnionService for batch operations
- [x] 10-02-PLAN.md — Enhance OccupationService with INICIAR/FINALIZAR
- [x] 10-03-PLAN.md — Add ARM-before-SOLD validation
- [x] 10-04-PLAN.md — Implement metrología auto-transition
- [x] 10-05-PLAN.md — Integration tests and performance validation

**Success Criteria** (what must be TRUE):
1. UnionService can process selection with batch update and metadata logging in under 1 second for 10 unions
2. UnionService calculates pulgadas-diámetro by summing DN_UNION with 1 decimal precision
3. OccupationService.iniciar_spool() writes Ocupado_Por and Fecha_Ocupacion without touching Uniones sheet
4. OccupationService.finalizar_spool() auto-determines PAUSAR (partial) vs COMPLETAR (100%) based on selection count
5. ValidationService enforces ARM-before-SOLD rule: SOLD requires at least 1 union with ARM_FECHA_FIN != NULL
6. System triggers automatic transition to metrología queue when SOLD is 100% complete
7. System allows 0 unions selected in FINALIZAR after modal confirmation (logs SPOOL_CANCELADO event)

### Phase 11: API Endpoints & Metrics

**Goal**: REST API exposes union workflows with INICIAR/FINALIZAR endpoints and maintains v3.0 compatibility
**Depends on**: Phase 10
**Plans**: 6 plans (including 1 gap closure plan)

Plans:

- [x] 11-01-PLAN.md — API versioning and v3.0 endpoint migration
- [x] 11-02-PLAN.md — Union query endpoints (disponibles, metricas)
- [x] 11-03-PLAN.md — INICIAR workflow endpoint
- [x] 11-04-PLAN.md — FINALIZAR workflow endpoint
- [x] 11-05-PLAN.md — Integration tests and validation
- [x] 11-06-PLAN.md — Fix metadata batch + granular event logging (gap closure)

**Success Criteria** (what must be TRUE):
1. GET /api/v4/uniones/{tag}/disponibles?operacion=ARM|SOLD returns filtered unions based on operation type
2. GET /api/v4/uniones/{tag}/metricas returns aggregated metrics (total_uniones, arm_completadas, sold_completadas, pulgadas_arm, pulgadas_sold)
3. POST /api/v4/occupation/iniciar occupies spool with Redis lock without modifying Uniones sheet
4. POST /api/v4/occupation/finalizar accepts selected_unions array and auto-determines PAUSAR or COMPLETAR
5. v3.0 endpoints (/tomar, /pausar, /completar) remain functional for backward compatibility
6. Metadata logs 1 batch event (spool level) plus N granular events (union level) per FINALIZAR operation
7. Dashboard displays pulgadas-diámetro as primary metric instead of spool count

### Phase 12: Frontend Union Selection UX

**Goal**: Mobile-first UI supports dual workflows (v3.0 3-button vs v4.0 2-button INICIAR/FINALIZAR) with union selection checkboxes
**Depends on**: Phase 11
**Plans**: 8 plans

Plans:

- [x] 12-01-PLAN.md — TypeScript types and API client for v4.0
- [x] 12-02-PLAN.md — Base components (Modal, UnionTable shell, version detection)
- [x] 12-03-PLAN.md — Context extension with v4.0 state management
- [x] 12-04-PLAN.md — P5 union selection page with checkboxes and counter
- [x] 12-05-PLAN.md — API integration and error handling for P5
- [x] 12-06-PLAN.md — P3 version detection and dual button sets
- [x] 12-07-PLAN.md — P4 spool filtering and version badges
- [x] 12-08-PLAN.md — P6 success page with dynamic messaging

**Success Criteria** (what must be TRUE):
1. P3 shows 2 buttons (INICIAR, FINALIZAR) for v4.0 spools and 3 buttons (TOMAR, PAUSAR, COMPLETAR) for v3.0 spools
2. P4 filters spools by action type: INICIAR shows disponibles, FINALIZAR shows ocupados by current worker
3. P5 (new page) shows union selection checkboxes with N_UNION, DN_UNION, TIPO_UNION columns
4. P5 displays live counter updating "Seleccionadas: 7/10 | Pulgadas: 18.5" as user selects checkboxes
5. P5 shows modal confirmation "¿Liberar sin registrar?" when 0 unions selected
6. P5 disables checkboxes for already-completed unions with visual "✓ Armada" or "✓ Soldada" badge
7. Metrología and Reparación workflows remain at spool level with no changes to existing UI

### Phase 13: Performance Validation & Optimization

**Goal**: System meets performance SLA (< 1s p95 for 10 unions) and stays under Google Sheets rate limits
**Depends on**: Phase 12
**Plans**: 5 plans

Plans:

- [x] 13-01-PLAN.md — Percentile-Based Latency Validation (PERF-01, PERF-02)
- [x] 13-02-PLAN.md — API Call Efficiency Validation (PERF-03, PERF-04)
- [x] 13-03-PLAN.md — Rate Limit Monitoring (PERF-05)
- [x] 13-04-PLAN.md — Comprehensive Load Testing with Locust
- [x] 13-05-PLAN.md — Performance Report Generation & CI Integration

**Success Criteria** (what must be TRUE):
1. Batch union updates achieve < 1s latency at p95 for 10-union selection operation
2. Batch union updates achieve < 2s latency at p99 (acceptable threshold)
3. Single FINALIZAR operation makes maximum 2 Sheets API calls (1 batch update + 1 batch append)
4. Metadata batch logging chunks eventos into 900-row groups to respect Google Sheets append_rows limit
5. System stays under 50% of Google Sheets write rate limit (30 writes/min vs 60 limit) during normal operations

---

## Milestone Summary

**Key Decisions:**
- Decision: Use TAG_SPOOL (not OT) as foreign key in UnionRepository (Rationale: Maintains v3.0 compatibility, avoids breaking Redis/Metadata/queries)
- Decision: 1 decimal precision for pulgadas (not 2) (Rationale: User preference, simpler calculations, sufficient for business metric)
- Decision: Persistent Redis locks without TTL (Rationale: Supports 5-8 hour work sessions, lazy cleanup prevents orphans)
- Decision: Auto-determination of PAUSAR vs COMPLETAR (Rationale: Simplifies UX, reduces decision fatigue, clearer workflow)
- Decision: Batch + granular metadata logging (Rationale: Regulatory compliance, granular traceability per union, performance optimization)
- Decision: Version detection via union count (Rationale: No schema migration needed, simple conditional logic, backward compatible)
- Decision: Performance validation with mock latency (Rationale: Production Sheets API performance unknown until deployment, Week 1 monitoring plan)

**Issues Resolved:**
- Fixed metadata batch + granular event logging gap (Phase 11 Plan 6)
- Resolved frontend P5 union selection integration (confirmed seleccionar-uniones/page.tsx exists)
- Validated all 63 v4.0 requirements satisfied with comprehensive cross-phase integration
- Confirmed 9/9 critical wiring points working correctly across phases
- Validated all 5 E2E user flows complete (INICIAR→FINALIZAR, ARM→SOLD validation, zero-union cancellation, v3.0 backward compatibility)

**Issues Deferred:**
- Week 1 production monitoring for real Google Sheets API performance validation
- Load testing with 30-50 concurrent workers against real backend
- RateLimitMonitor runtime integration (monitoring-only infrastructure)
- FastAPI lifespan handler migration (cosmetic deprecation warning)

**Technical Debt Incurred:**
- Performance tests use mock latency (300ms ±50ms) - real Sheets API performance unvalidated until production
- RateLimitMonitor exists but not integrated into production request paths (monitoring infrastructure only)
- Load testing scenarios exist but not executed against real backend deployment
- GET /api/v4/uniones/{tag}/disponibles implementation differs from original plan (indirect call pattern)
- FastAPI on_event deprecated, should migrate to lifespan handlers (non-blocking cosmetic warning)

---

_For current project status, see .planning/ROADMAP.md_
_For milestone audit details, see .planning/milestones/v4.0-MILESTONE-AUDIT.md_
