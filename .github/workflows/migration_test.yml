name: Migration Test Suite

on:
  pull_request:
    branches:
      - v3.0-dev
      - main
    paths:
      - 'backend/**'
      - 'tests/v3.0/**'
      - '.github/workflows/migration_test.yml'
  push:
    branches:
      - v3.0-dev
    paths:
      - 'backend/**'
      - 'tests/v3.0/**'
  workflow_dispatch:  # Manual trigger

jobs:
  test-migration:
    name: Test Migration Process
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest-json-report psutil

      - name: Verify environment
        run: |
          python --version
          pip list
          echo "Project structure:"
          ls -la backend/scripts/

      - name: Run migration test harness
        env:
          GOOGLE_SHEET_ID: ${{ secrets.TEST_SHEET_ID }}
          GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        run: |
          python backend/scripts/test_migration_harness.py
        continue-on-error: false

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-test-report-${{ github.run_number }}
          path: backend/logs/test_report*.json
          retention-days: 30

      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs-${{ github.run_number }}
          path: backend/logs/test_harness*.log
          retention-days: 30

      - name: Upload pytest reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-reports-${{ github.run_number }}
          path: backend/logs/pytest_report*.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFiles = fs.readdirSync('backend/logs/').filter(f => f.startsWith('test_report_'));

            if (reportFiles.length === 0) {
              console.log('No test report found');
              return;
            }

            const reportPath = `backend/logs/${reportFiles[0]}`;
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            const success = report.success ? '✅' : '❌';
            const status = report.success ? 'PASSED' : 'FAILED';

            const body = `
            ## Migration Test Results ${success}

            **Status:** ${status}
            **Test Sheet:** ${report.test_sheet_id || 'N/A'}
            **Timestamp:** ${report.timestamp}

            ### Results
            - Migration: ${report.results.migration_output ? '✅' : '❌'}
            - E2E Tests: ${report.results.e2e_tests_passed ? '✅' : '❌'}
            - Rollback Tests: ${report.results.rollback_tests_passed ? '✅' : '❌'}

            [View detailed logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run smoke tests
        env:
          GOOGLE_SHEET_ID: ${{ secrets.TEST_SHEET_ID }}
          GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        run: |
          pytest tests/v3.0/ -m smoke -v --tb=short

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results-${{ github.run_number }}
          path: .pytest_cache/
          retention-days: 7
